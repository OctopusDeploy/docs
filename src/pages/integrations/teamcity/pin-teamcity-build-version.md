---
layout: src/layouts/Default.astro
pubDate: 2015-02-11
title: 'Pin TeamCity Build Version'
description: 'Try to pin the TeamCity build version. (Requires Octopus version to match TeamCity version)'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2015-02-11 by bobjwalker belongs to 'TeamCity' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Build Number

`buildNumber = #{Octopus.Release.Number}`

null

</div>
        
<div class="param">

### Build Configuration ID

`buildTypeId`

The build configuration id to look for the build to pin.

General Settings of the Build Configuration

</div>
        
<div class="param">

### Url of TeamCity Server

`TeamCityUrl = http://localhost:8082`

The url to the TeamCity server.

</div>
        
<div class="param">

### TeamCity User

`TeamCityUser`

The TeamCity user used for pinning the build

</div>
        
<div class="param">

### TeamCity User Password

`TeamCityPassword`

The password for the TeamCity user.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
$buildNumber = $OctopusParameters['buildNumber']
$buildTypeId = $OctopusParameters['buildTypeId']

$tcUrl = $OctopusParameters['TeamCityUrl']
$tcUser = $OctopusParameters['TeamCityUser']
$tcPass = $OctopusParameters['TeamCityPassword']

[string]$tcRestUrl = $tcUrl + '/httpAuth/app/rest/builds/buildType:{1},number:{0}/pin/'
$url = $tcRestUrl -f $buildNumber,$buildTypeId

Write-Host "****************************"
Write-Host "Pinning build in TeamCity at:"$url 
Write-Host "****************************"

$req = [System.Net.WebRequest]::Create($url)
$req.Credentials = new-object System.Net.NetworkCredential($tcUser, $tcPass)
$req.Method ="PUT"
$req.ContentLength = 0

$resp = $req.GetResponse()
$reader = new-object System.IO.StreamReader($resp.GetResponseStream())
$reader.ReadToEnd() | Write-Host

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Pin%20TeamCity%20Build%20Version&step-template=Pin%20TeamCity%20Build%20Version)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "b3137de8-93c9-4a10-8f6a-5dd14175b843",
  "Name": "Pin TeamCity Build Version",
  "Description": "Try to pin the TeamCity build version. (Requires Octopus version to match TeamCity version)",
  "Version": 1,
  "ExportedAt": "2015-02-11T08:20:13.192+00:00",
  "ActionType": "Octopus.Script",
  "Author": "bobjwalker",
  "Parameters": [
    {
      "Name": "buildNumber",
      "Label": "Build Number",
      "HelpText": null,
      "DefaultValue": "#{Octopus.Release.Number}",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "buildTypeId",
      "Label": "Build Configuration ID",
      "HelpText": "The build configuration id to look for the build to pin.\n\nGeneral Settings of the Build Configuration",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "TeamCityUrl",
      "Label": "Url of TeamCity Server",
      "HelpText": "The url to the TeamCity server.",
      "DefaultValue": "http://localhost:8082",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "TeamCityUser",
      "Label": "TeamCity User",
      "HelpText": "The TeamCity user used for pinning the build",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "TeamCityPassword",
      "Label": "TeamCity User Password",
      "HelpText": "The password for the TeamCity user.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "$buildNumber = $OctopusParameters['buildNumber']\n$buildTypeId = $OctopusParameters['buildTypeId']\n\n$tcUrl = $OctopusParameters['TeamCityUrl']\n$tcUser = $OctopusParameters['TeamCityUser']\n$tcPass = $OctopusParameters['TeamCityPassword']\n\n[string]$tcRestUrl = $tcUrl + '/httpAuth/app/rest/builds/buildType:{1},number:{0}/pin/'\n$url = $tcRestUrl -f $buildNumber,$buildTypeId\n\nWrite-Host \"****************************\"\nWrite-Host \"Pinning build in TeamCity at:\"$url \nWrite-Host \"****************************\"\n\n$req = [System.Net.WebRequest]::Create($url)\n$req.Credentials = new-object System.Net.NetworkCredential($tcUser, $tcPass)\n$req.Method =\"PUT\"\n$req.ContentLength = 0\n\n$resp = $req.GetResponse()\n$reader = new-object System.IO.StreamReader($resp.GetResponseStream())\n$reader.ReadToEnd() | Write-Host\n",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Category": "TeamCity",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/TeamCity-Pin-Build.json",
  "Website": "/step-templates/b3137de8-93c9-4a10-8f6a-5dd14175b843",
  "Logo": "https://i.octopus.com/library/step-templates/teamcity.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/TeamCity-Pin-Build.json)

</div>
