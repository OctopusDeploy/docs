---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2022-10-03
title: 'MongoDB Atlas - Restore cluster from latest snapshot'
description: 'Allow the user to restore a cluster from the latest snapshot.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2022-10-03 by claude-uceda belongs to 'MongoDB' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Public key

`matlas-public-key = `

Mongo atlas public key

</div>
        
<div class="param">

### Private key

`matlas-private-key = `

Mongo atlas private key

</div>
        
<div class="param">

### Project source's id

`matlas-project-source = `

Project id of the cluster that will be the snapshot source.

</div>
        
<div class="param">

### Cluster source's name

`matlas-cluster-source = `

Cluster that will be used to get the snapshot.

</div>
        
<div class="param">

### Project target's id

`matlas-project-target = `

Project id of the cluster that will used to restore the snapshot.

</div>
        
<div class="param">

### Cluster target's name

`matlas-cluster-target = `

Cluster that will be used to restore the snapshot.

</div>
        
<div class="param">

### Status check delay

`matlas-check-delay-seconds = 30`

Delay in seconds between each statuses check.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
$project_source = $OctopusParameters["matlas-project-source"]
$cluster_source = $OctopusParameters["matlas-cluster-source"]
$project_target = $OctopusParameters["matlas-project-target"]
$cluster_target = $OctopusParameters["matlas-cluster-target"]
$check_delay_seconds = $OctopusParameters["matlas-check-delay-seconds"]

$login = $OctopusParameters["matlas-public-key"]
$secret = $OctopusParameters["matlas-private-key"]

$check_delay_seconds_nb = ($check_delay_seconds -as [int])

function Check-Required($name, $value) {
	if($value -eq $null -or $value -eq ''){
    	Write-Error -Message "Missing parameter or invalid value for '$name'. ($value)" -ErrorAction Stop
    }
}

Check-Required 'matlas-public-key' $login
Check-Required 'matlas-private-key' $secret
Check-Required 'matlas-project-source' $project_source
Check-Required 'matlas-cluster-source' $cluster_source
Check-Required 'matlas-project-target' $project_target
Check-Required 'matlas-cluster-target' $cluster_target
Check-Required 'matlas-check-delay-seconds' $check_delay_seconds_nb

Write-Host "Restoring from $($project_source)/$($cluster_source) to $($project_target)/$($cluster_target) using $login."

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

function Invoke-Api($uri, $method, $content) {	

	$securedPassword = ConvertTo-SecureString -String $secret -AsPlainText -Force	
	$credentials = New-Object System.Management.Automation.PSCredential ($login, $securedPassword)

	try {
		return Invoke-RestMethod -Uri $uri -Method $method -Credential $credentials -ContentType "application/json" -Body $content
	}
	catch {
		Write-Error -Message $_ -ErrorAction Stop
	}
}

$root = "https://cloud.mongodb.com/api/atlas/v1.0"
$uri = New-Object System.Uri("$root/groups/$project_source/clusters/$cluster_source/backup/snapshots?itemsPerPage=5")
$results = Invoke-Api $uri "GET"
$snapshots = $results.results | Where-Object { $_.status -eq "completed" }
$snapshot = $snapshots[0]

$uri = New-Object System.Uri("$root/groups/$project_source/clusters/$cluster_source/backup/restoreJobs")
$request = "{`"deliveryType`":`"automated`", `"snapshotId`":`"$($snapshot.id)`", `"targetClusterName`":`"$cluster_target`", `"targetGroupId`":`"$project_target`"}"
$job = Invoke-Api $uri "POST" $request

$uri = New-Object System.Uri("$root/groups/$project_source/clusters/$cluster_source/backup/restoreJobs/$($job.id)")
while ($null -eq $job.finishedAt -or $job.finishedAt -eq "") {

	Write-Host "Waiting for restore to complete."	
	Start-Sleep -s $check_delay_seconds_nb
	$job = Invoke-Api $uri "GET"
}

Write-Host "Restore completed."

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20MongoDB%20Atlas%20-%20Restore%20cluster%20from%20latest%20snapshot&step-template=MongoDB%20Atlas%20-%20Restore%20cluster%20from%20latest%20snapshot)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "bf062dfe-de07-462c-8e7d-ec062b29e550",
  "Name": "MongoDB Atlas - Restore cluster from latest snapshot",
  "Description": "Allow the user to restore a cluster from the latest snapshot.",
  "Version": 1,
  "ExportedAt": "2022-10-03T10:52:04.423Z",
  "ActionType": "Octopus.Script",
  "Author": "claude-uceda",
  "Packages": [],
  "Parameters": [
    {
      "Id": "0cfd5665-9bfc-413a-bc4a-7778a860b7f0",
      "Name": "matlas-public-key",
      "Label": "Public key",
      "HelpText": "Mongo atlas public key",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "61cff00c-69b5-44b5-873d-742430ca2beb",
      "Name": "matlas-private-key",
      "Label": "Private key",
      "HelpText": "Mongo atlas private key",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Id": "3d86c70a-2a6c-4cb7-a04e-f7f43838554c",
      "Name": "matlas-project-source",
      "Label": "Project source's id",
      "HelpText": "Project id of the cluster that will be the snapshot source.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "2a32df2e-641d-41a0-9e56-dba341efe58d",
      "Name": "matlas-cluster-source",
      "Label": "Cluster source's name",
      "HelpText": "Cluster that will be used to get the snapshot.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "bff9846a-980e-4a8f-b6bb-b43de82397c1",
      "Name": "matlas-project-target",
      "Label": "Project target's id",
      "HelpText": "Project id of the cluster that will used to restore the snapshot.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "e2aaa07d-9122-47ee-b3e9-008949ed5709",
      "Name": "matlas-cluster-target",
      "Label": "Cluster target's name",
      "HelpText": "Cluster that will be used to restore the snapshot.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "ac4c10c6-e487-4cec-902d-7cfaab7a3934",
      "Name": "matlas-check-delay-seconds",
      "Label": "Status check delay",
      "HelpText": "Delay in seconds between each statuses check.",
      "DefaultValue": "30",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "$project_source = $OctopusParameters[\"matlas-project-source\"]\n$cluster_source = $OctopusParameters[\"matlas-cluster-source\"]\n$project_target = $OctopusParameters[\"matlas-project-target\"]\n$cluster_target = $OctopusParameters[\"matlas-cluster-target\"]\n$check_delay_seconds = $OctopusParameters[\"matlas-check-delay-seconds\"]\n\n$login = $OctopusParameters[\"matlas-public-key\"]\n$secret = $OctopusParameters[\"matlas-private-key\"]\n\n$check_delay_seconds_nb = ($check_delay_seconds -as [int])\n\nfunction Check-Required($name, $value) {\n\tif($value -eq $null -or $value -eq ''){\n    \tWrite-Error -Message \"Missing parameter or invalid value for '$name'. ($value)\" -ErrorAction Stop\n    }\n}\n\nCheck-Required 'matlas-public-key' $login\nCheck-Required 'matlas-private-key' $secret\nCheck-Required 'matlas-project-source' $project_source\nCheck-Required 'matlas-cluster-source' $cluster_source\nCheck-Required 'matlas-project-target' $project_target\nCheck-Required 'matlas-cluster-target' $cluster_target\nCheck-Required 'matlas-check-delay-seconds' $check_delay_seconds_nb\n\nWrite-Host \"Restoring from $($project_source)/$($cluster_source) to $($project_target)/$($cluster_target) using $login.\"\n\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n\nfunction Invoke-Api($uri, $method, $content) {\t\n\n\t$securedPassword = ConvertTo-SecureString -String $secret -AsPlainText -Force\t\n\t$credentials = New-Object System.Management.Automation.PSCredential ($login, $securedPassword)\n\n\ttry {\n\t\treturn Invoke-RestMethod -Uri $uri -Method $method -Credential $credentials -ContentType \"application/json\" -Body $content\n\t}\n\tcatch {\n\t\tWrite-Error -Message $_ -ErrorAction Stop\n\t}\n}\n\n$root = \"https://cloud.mongodb.com/api/atlas/v1.0\"\n$uri = New-Object System.Uri(\"$root/groups/$project_source/clusters/$cluster_source/backup/snapshots?itemsPerPage=5\")\n$results = Invoke-Api $uri \"GET\"\n$snapshots = $results.results | Where-Object { $_.status -eq \"completed\" }\n$snapshot = $snapshots[0]\n\n$uri = New-Object System.Uri(\"$root/groups/$project_source/clusters/$cluster_source/backup/restoreJobs\")\n$request = \"{`\"deliveryType`\":`\"automated`\", `\"snapshotId`\":`\"$($snapshot.id)`\", `\"targetClusterName`\":`\"$cluster_target`\", `\"targetGroupId`\":`\"$project_target`\"}\"\n$job = Invoke-Api $uri \"POST\" $request\n\n$uri = New-Object System.Uri(\"$root/groups/$project_source/clusters/$cluster_source/backup/restoreJobs/$($job.id)\")\nwhile ($null -eq $job.finishedAt -or $job.finishedAt -eq \"\") {\n\n\tWrite-Host \"Waiting for restore to complete.\"\t\n\tStart-Sleep -s $check_delay_seconds_nb\n\t$job = Invoke-Api $uri \"GET\"\n}\n\nWrite-Host \"Restore completed.\"\n"
  },
  "Category": "MongoDB",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/mongodb-atlas-restore-snapshot.json",
  "Website": "/step-templates/bf062dfe-de07-462c-8e7d-ec062b29e550",
  "Logo": "https://i.octopus.com/library/step-templates/mongodb.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/mongodb-atlas-restore-snapshot.json)

</div>
