---
layout: src/layouts/Default.astro
pubDate: 2014-08-25
title: 'File System - Clean ASP.NET Temp Files'
description: 'Most ASP.NET websites today make use of dynamic compilation. 
The dynamically compiled assemblies are stored in the Temporary ASP.NET files directory.
However, files in this directory are not automatically removed and may build up over time.
This script will clean out all files in this directory.
You should note that this may cause running websites to be restarted.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2014-08-25 by Lavinski belongs to 'File System' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Framework version

`FrameworkVersion = All`

This is the framework version to target. 
Specifying `All` will clean out the temp files for each installed version of the framework.
If you need to target a specific version, you can specify either the bit-ness, version or both.

Example values:
`Framework`
`Framework64`
`v4`
`v2.0.50727`
`v2.0.50727`
`Framework\v4.0.30319`
`Framework64\v4.0.30319`
`Framework64\v2`

Specifying a bit-ness value will match all versions.
Specifying only a version will match that version regarless of bit-ness.
A fully specified framework version will match only that value.

</div>
        
<div class="param">

### Days to keep

`DaysToKeep = 30`

Number of days since last write time to keep temporary files.

Note that this is the write time of the top level folder.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
# Running outside octopus
param(
	[string]$frameworkVersion,
	[int]$daysToKeep,
	[switch]$whatIf
) 

$ErrorActionPreference = "Stop"

function Get-Param($Name, [switch]$Required, $Default) {
	$result = $null
	
	if ($OctopusParameters -ne $null) {
		$result = $OctopusParameters[$Name]
	}

	if ($result -eq $null) {
		$variable = Get-Variable $Name -EA SilentlyContinue	
		if ($variable -ne $null) {
			$result = $variable.Value
		}
	}
	
	if ($result -eq $null) {
		if ($Required) {
			throw "Missing parameter value $Name"
		} else {
			$result = $Default
		}
	}

	return $result
}

function RemoveSafely-Item($folder, $Old, [switch]$whatIf) {
	
	if ($folder.LastWriteTime -lt $old) {
		
		try {
			Write-Host "Removing: $($folder.FullName)"
			$folder | Remove-Item -Recurse -Force -WhatIf:$whatIf -EA Stop
		} catch {
			$message = $_.Exception.Message
			Write-Host "Info: Could not remove $itemName. $message"
		}
	}
}

& {
	param(
		[string]$frameworkVersion,
		[int]$daysToKeep
	) 

	Write-Host "Cleaning Temporary ASP.NET files directory"
	
	if ([string]::IsNullOrEmpty($frameworkVersion)) {
		throw "You need to specify the frameworkVersion parameter"
	}
	
	Write-Host "FrameworkVersion: $frameworkVersion"
	
	$dotnetPath = [System.Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory() | Split-Path | Split-Path
	$bitnessValues = @("Framework", "Framework64")
	$versionStart = "v"
	$versionFilter = "$versionStart"
	$tempDir = "Temporary ASP.NET Files"
	
	$directoriesToClean = @()
	
	if ($frameworkVersion -ne "All") {
	
		# Starts with v
		if ($frameworkVersion.StartsWith($versionStart, "CurrentCultureIgnoreCase")) {
			$versionFilter = $frameworkVersion
			if ($frameworkVersion -contains "\") {
				throw "Framework version cannot contain '\'"
			}
		} else {
		
			# Includes one \
			$firstSlash = $frameworkVersion.IndexOf("\")
			
			$NotAVersion = -1
			if ($firstSlash -eq $NotAVersion) {
				$bitnessValues = @($frameworkVersion)
			} else {
			
				$secondSlash = $frameworkVersion.IndexOf("\", $firstSlash)
				
				$NoExtraSlash = -1
				if ($secondSlash -ne $NoExtraSlash) {
					
					$bitnessValues = @($frameworkVersion | Split-Path)
					$versionFilter = @($frameworkVersion | Split-Path -Leaf)

				} else {
					throw "Includes more than one '\'"
				}
			}
		}
	}
	
	if (!$versionFilter.StartsWith($versionStart, "CurrentCultureIgnoreCase")) {
		throw "Version filter must start with '$versionStart'"
	}
	
	foreach ($bitness in $bitnessValues) {
		$fvPath = (Join-Path $dotnetPath $bitness)
		if (Test-Path $fvPath) {
			$directoriesToClean += (ls $fvPath -Filter "$versionFilter*")
		}
	}
	
	foreach ($dir in $directoriesToClean) {
		$fullTempPath = Join-Path $dir.FullName $tempDir
		
		if (Test-Path $fullTempPath) {
			$virtualDirectories = ls $fullTempPath
			foreach ($virtualPathDir in $virtualDirectories) {
				$old = (Get-Date).AddDays(-$daysToKeep)
				
				foreach ($siteDir in (Get-ChildItem $virtualPathDir.FullName)) {
					RemoveSafely-Item $siteDir $old -WhatIf:$whatIf
				}
			}
		}
	}
	
 } `
 (Get-Param 'frameworkVersion' -Required) `
 (Get-Param 'daysToKeep' -Default 30) 
 
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20File%20System%20-%20Clean%20ASP.NET%20Temp%20Files&step-template=File%20System%20-%20Clean%20ASP.NET%20Temp%20Files)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "47fa89d0-fffd-4686-978d-4d54d944df55",
  "Name": "File System - Clean ASP.NET Temp Files",
  "Description": "Most ASP.NET websites today make use of dynamic compilation. \nThe dynamically compiled assemblies are stored in the Temporary ASP.NET files directory.\nHowever, files in this directory are not automatically removed and may build up over time.\nThis script will clean out all files in this directory.\nYou should note that this may cause running websites to be restarted.",
  "Version": 9,
  "ExportedAt": "2014-08-25T05:12:40.750+00:00",
  "ActionType": "Octopus.Script",
  "Author": "Lavinski",
  "Parameters": [
    {
      "Name": "FrameworkVersion",
      "Label": "Framework version",
      "HelpText": "This is the framework version to target. \nSpecifying `All` will clean out the temp files for each installed version of the framework.\nIf you need to target a specific version, you can specify either the bit-ness, version or both.\n\nExample values:\n`Framework`\n`Framework64`\n`v4`\n`v2.0.50727`\n`v2.0.50727`\n`Framework\\v4.0.30319`\n`Framework64\\v4.0.30319`\n`Framework64\\v2`\n\nSpecifying a bit-ness value will match all versions.\nSpecifying only a version will match that version regarless of bit-ness.\nA fully specified framework version will match only that value.",
      "DefaultValue": "All",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DaysToKeep",
      "Label": "Days to keep",
      "HelpText": "Number of days since last write time to keep temporary files.\n\nNote that this is the write time of the top level folder.",
      "DefaultValue": "30",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "# Running outside octopus\nparam(\n\t[string]$frameworkVersion,\n\t[int]$daysToKeep,\n\t[switch]$whatIf\n) \n\n$ErrorActionPreference = \"Stop\"\n\nfunction Get-Param($Name, [switch]$Required, $Default) {\n\t$result = $null\n\t\n\tif ($OctopusParameters -ne $null) {\n\t\t$result = $OctopusParameters[$Name]\n\t}\n\n\tif ($result -eq $null) {\n\t\t$variable = Get-Variable $Name -EA SilentlyContinue\t\n\t\tif ($variable -ne $null) {\n\t\t\t$result = $variable.Value\n\t\t}\n\t}\n\t\n\tif ($result -eq $null) {\n\t\tif ($Required) {\n\t\t\tthrow \"Missing parameter value $Name\"\n\t\t} else {\n\t\t\t$result = $Default\n\t\t}\n\t}\n\n\treturn $result\n}\n\nfunction RemoveSafely-Item($folder, $Old, [switch]$whatIf) {\n\t\n\tif ($folder.LastWriteTime -lt $old) {\n\t\t\n\t\ttry {\n\t\t\tWrite-Host \"Removing: $($folder.FullName)\"\n\t\t\t$folder | Remove-Item -Recurse -Force -WhatIf:$whatIf -EA Stop\n\t\t} catch {\n\t\t\t$message = $_.Exception.Message\n\t\t\tWrite-Host \"Info: Could not remove $itemName. $message\"\n\t\t}\n\t}\n}\n\n& {\n\tparam(\n\t\t[string]$frameworkVersion,\n\t\t[int]$daysToKeep\n\t) \n\n\tWrite-Host \"Cleaning Temporary ASP.NET files directory\"\n\t\n\tif ([string]::IsNullOrEmpty($frameworkVersion)) {\n\t\tthrow \"You need to specify the frameworkVersion parameter\"\n\t}\n\t\n\tWrite-Host \"FrameworkVersion: $frameworkVersion\"\n\t\n\t$dotnetPath = [System.Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory() | Split-Path | Split-Path\n\t$bitnessValues = @(\"Framework\", \"Framework64\")\n\t$versionStart = \"v\"\n\t$versionFilter = \"$versionStart\"\n\t$tempDir = \"Temporary ASP.NET Files\"\n\t\n\t$directoriesToClean = @()\n\t\n\tif ($frameworkVersion -ne \"All\") {\n\t\n\t\t# Starts with v\n\t\tif ($frameworkVersion.StartsWith($versionStart, \"CurrentCultureIgnoreCase\")) {\n\t\t\t$versionFilter = $frameworkVersion\n\t\t\tif ($frameworkVersion -contains \"\\\") {\n\t\t\t\tthrow \"Framework version cannot contain '\\'\"\n\t\t\t}\n\t\t} else {\n\t\t\n\t\t\t# Includes one \\\n\t\t\t$firstSlash = $frameworkVersion.IndexOf(\"\\\")\n\t\t\t\n\t\t\t$NotAVersion = -1\n\t\t\tif ($firstSlash -eq $NotAVersion) {\n\t\t\t\t$bitnessValues = @($frameworkVersion)\n\t\t\t} else {\n\t\t\t\n\t\t\t\t$secondSlash = $frameworkVersion.IndexOf(\"\\\", $firstSlash)\n\t\t\t\t\n\t\t\t\t$NoExtraSlash = -1\n\t\t\t\tif ($secondSlash -ne $NoExtraSlash) {\n\t\t\t\t\t\n\t\t\t\t\t$bitnessValues = @($frameworkVersion | Split-Path)\n\t\t\t\t\t$versionFilter = @($frameworkVersion | Split-Path -Leaf)\n\n\t\t\t\t} else {\n\t\t\t\t\tthrow \"Includes more than one '\\'\"\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t\n\tif (!$versionFilter.StartsWith($versionStart, \"CurrentCultureIgnoreCase\")) {\n\t\tthrow \"Version filter must start with '$versionStart'\"\n\t}\n\t\n\tforeach ($bitness in $bitnessValues) {\n\t\t$fvPath = (Join-Path $dotnetPath $bitness)\n\t\tif (Test-Path $fvPath) {\n\t\t\t$directoriesToClean += (ls $fvPath -Filter \"$versionFilter*\")\n\t\t}\n\t}\n\t\n\tforeach ($dir in $directoriesToClean) {\n\t\t$fullTempPath = Join-Path $dir.FullName $tempDir\n\t\t\n\t\tif (Test-Path $fullTempPath) {\n\t\t\t$virtualDirectories = ls $fullTempPath\n\t\t\tforeach ($virtualPathDir in $virtualDirectories) {\n\t\t\t\t$old = (Get-Date).AddDays(-$daysToKeep)\n\t\t\t\t\n\t\t\t\tforeach ($siteDir in (Get-ChildItem $virtualPathDir.FullName)) {\n\t\t\t\t\tRemoveSafely-Item $siteDir $old -WhatIf:$whatIf\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t\n } `\n (Get-Param 'frameworkVersion' -Required) `\n (Get-Param 'daysToKeep' -Default 30) \n ",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Category": "File System",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/file-system-clean-asp-net-temp-files.json",
  "Website": "/step-templates/47fa89d0-fffd-4686-978d-4d54d944df55",
  "Logo": "https://i.octopus.com/library/step-templates/filesystem.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/file-system-clean-asp-net-temp-files.json)

</div>
