---
layout: src/layouts/Default.astro
pubDate: 2023-03-07
title: 'Kubernetes - Create Service Account and Target'
description: 'Create a service account with a role granting full access to everything in the namespace, and create a Kubernetes target with the new account in Octopus'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.KubernetesRunScript exported 2023-03-07 by isaaccalligeros belongs to 'Kubernetes' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Target name

`CreateK8sTargetName = `

The optional name of the target. Defaults to "<namespace>-k8s" if no value is defined.

</div>
        
<div class="param">

### Target Role

`CreateK8sTargetRole = k8s`

The role to assign to the new Kubernetes target

</div>
        
<div class="param">

### Target Namespace

`CreateK8sTargetNamespace = #{Octopus.Environment.Name | ToLower}`

The namespace that the service account is granted access to, as well as the default namespace on the target.

</div>
        
<div class="param">

### Namespace annotations

`CreateK8sTargetNamespaceAnnotations = `

An optional list of annotations to apply to the namespace

</div>
        
<div class="param">

### Container Image Feed

`CreateK8sTargetContainerImageFeed = `

The optional name of the Docker feed where the container image is sourced from.

</div>
        
<div class="param">

### Container image

`CreateK8sTargetContainerImage = `

The optional name of the health check container image.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
if ([string]::IsNullOrWhitespace($CreateK8sTargetNamespace)) {
	Write-Error "The namespace variable must be defined"
    exit 1
}

if ([string]::IsNullOrWhitespace($CreateK8sTargetRole)) {
	Write-Error "The role variable must be defined"
    exit 1
}

$target = if ([string]::IsNullOrEmpty($CreateK8sTargetName)) {"$($CreateK8sTargetNamespace)-k8s"} else {$CreateK8sTargetName}
$serviceaccount = "$($CreateK8sTargetNamespace)-deployer"
$rolename = "$($CreateK8sTargetNamespace)-deployer-role"
$binding = "$($CreateK8sTargetNamespace)-deployer-binding"

$count = (kubectl get namespaces -o json |
	ConvertFrom-JSON |
    Select-Object -ExpandProperty items |
    ? {$_.metadata.name -eq $CreateK8sTargetNamespace}).Count
    
if ($count -eq 0) {
  Set-Content -Path namespace.yaml -Value @"
  apiVersion: v1
  kind: Namespace
  metadata:
    name: $CreateK8sTargetNamespace
"@

  if (![string]::IsNullOrWhitespace($CreateK8sTargetNamespaceAnnotations)) {
  	Add-Content -Path namespace.yaml -Value @"
    annotations:
"@
	$annotations = ($CreateK8sTargetNamespaceAnnotations -split '\r?\n').Trim()
    foreach ($annotation in $annotations) {
        Add-Content -Path namespace.yaml -Value @"
      $annotation
"@
    }
  }

  kubectl apply -f namespace.yaml
}

Set-Content -Path serviceaccount.yaml -Value @"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: $serviceaccount
  namespace: $CreateK8sTargetNamespace 
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: $CreateK8sTargetNamespace 
  name: $rolename
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: $binding
  namespace: $CreateK8sTargetNamespace 
subjects:
- kind: ServiceAccount
  name: $serviceaccount
  apiGroup: ""
roleRef:
  kind: Role
  name: $rolename
  apiGroup: ""
"@

kubectl apply -f serviceaccount.yaml
 
Set-Content -Path secret.yaml -Value @"
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: $serviceaccount
  namespace: $CreateK8sTargetNamespace
  annotations:
    kubernetes.io/service-account.name: "$serviceaccount"
"@

kubectl apply -f secret.yaml

$data = kubectl get secret $serviceaccount -o jsonpath="{.data.token}" --namespace=$CreateK8sTargetNamespace 

$token = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($data))
$url = (kubectl config view -o json | ConvertFrom-Json).clusters[0].cluster.server

New-OctopusTokenAccount -Name $target -token $token -updateIfExisting

if ([string]::IsNullOrEmpty("#{Octopus.Action.Kubernetes.CertificateAuthority}") -or "#{Octopus.Action.Kubernetes.AksAdminLogin}" -ieq "True") {
	New-OctopusKubernetesTarget `
		-name $target `
		-clusterUrl $url `
		-octopusRoles $CreateK8sTargetRole `
		-octopusAccountIdOrName $target `
		-namespace $CreateK8sTargetNamespace `
		-updateIfExisting `
		-skipTlsVerification True `
		-octopusDefaultWorkerPoolIdOrName "#{Octopus.WorkerPool.Id}" `
        -healthCheckContainerImageFeedIdOrName "$CreateK8sTargetContainerImageFeed" `
    	-healthCheckContainerImage "$CreateK8sTargetContainerImage"
} else {
	New-OctopusKubernetesTarget `
		-name $target `
		-clusterUrl $url `
		-octopusRoles $CreateK8sTargetRole `
		-octopusAccountIdOrName $target `
		-namespace $CreateK8sTargetNamespace `
		-updateIfExisting `
        -octopusServerCertificateIdOrName "#{Octopus.Action.Kubernetes.CertificateAuthority}" `
		-octopusDefaultWorkerPoolIdOrName "#{Octopus.WorkerPool.Id}" `
        -healthCheckContainerImageFeedIdOrName "$CreateK8sTargetContainerImageFeed" `
    	-healthCheckContainerImage "$CreateK8sTargetContainerImage"
}
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Kubernetes%20-%20Create%20Service%20Account%20and%20Target&step-template=Kubernetes%20-%20Create%20Service%20Account%20and%20Target)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "05d2d9a8-3862-49ff-97d6-5f08935f6fa3",
  "Name": "Kubernetes - Create Service Account and Target",
  "Description": "Create a service account with a role granting full access to everything in the namespace, and create a Kubernetes target with the new account in Octopus",
  "Version": 14,
  "ExportedAt": "2023-03-07T11:26:30.753Z",
  "ActionType": "Octopus.KubernetesRunScript",
  "Author": "isaaccalligeros",
  "Packages": [],
  "Parameters": [
    {
      "Id": "66047c5e-8827-4bce-85ef-98466e656d0e",
      "Name": "CreateK8sTargetName",
      "Label": "Target name",
      "HelpText": "The optional name of the target. Defaults to \"<namespace>-k8s\" if no value is defined.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "1505ab59-1b6b-497e-9aa5-888f583c2cb2",
      "Name": "CreateK8sTargetRole",
      "Label": "Target Role",
      "HelpText": "The role to assign to the new Kubernetes target",
      "DefaultValue": "k8s",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "e0dc3fc2-b422-4b27-8353-efee0233cf7f",
      "Name": "CreateK8sTargetNamespace",
      "Label": "Target Namespace",
      "HelpText": "The namespace that the service account is granted access to, as well as the default namespace on the target.",
      "DefaultValue": "#{Octopus.Environment.Name | ToLower}",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "34a94173-611f-4cbf-b30a-66fb9456d1cf",
      "Name": "CreateK8sTargetNamespaceAnnotations",
      "Label": "Namespace annotations",
      "HelpText": "An optional list of annotations to apply to the namespace",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      }
    },
    {
      "Id": "f14880f9-5a57-4469-85d7-5e68e090ed43",
      "Name": "CreateK8sTargetContainerImageFeed",
      "Label": "Container Image Feed",
      "HelpText": "The optional name of the Docker feed where the container image is sourced from.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "8d8d4317-af86-4a2a-9c04-eef1d8624e4a",
      "Name": "CreateK8sTargetContainerImage",
      "Label": "Container image",
      "HelpText": "The optional name of the health check container image.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "if ([string]::IsNullOrWhitespace($CreateK8sTargetNamespace)) {\n\tWrite-Error \"The namespace variable must be defined\"\n    exit 1\n}\n\nif ([string]::IsNullOrWhitespace($CreateK8sTargetRole)) {\n\tWrite-Error \"The role variable must be defined\"\n    exit 1\n}\n\n$target = if ([string]::IsNullOrEmpty($CreateK8sTargetName)) {\"$($CreateK8sTargetNamespace)-k8s\"} else {$CreateK8sTargetName}\n$serviceaccount = \"$($CreateK8sTargetNamespace)-deployer\"\n$rolename = \"$($CreateK8sTargetNamespace)-deployer-role\"\n$binding = \"$($CreateK8sTargetNamespace)-deployer-binding\"\n\n$count = (kubectl get namespaces -o json |\n\tConvertFrom-JSON |\n    Select-Object -ExpandProperty items |\n    ? {$_.metadata.name -eq $CreateK8sTargetNamespace}).Count\n    \nif ($count -eq 0) {\n  Set-Content -Path namespace.yaml -Value @\"\n  apiVersion: v1\n  kind: Namespace\n  metadata:\n    name: $CreateK8sTargetNamespace\n\"@\n\n  if (![string]::IsNullOrWhitespace($CreateK8sTargetNamespaceAnnotations)) {\n  \tAdd-Content -Path namespace.yaml -Value @\"\n    annotations:\n\"@\n\t$annotations = ($CreateK8sTargetNamespaceAnnotations -split '\\r?\\n').Trim()\n    foreach ($annotation in $annotations) {\n        Add-Content -Path namespace.yaml -Value @\"\n      $annotation\n\"@\n    }\n  }\n\n  kubectl apply -f namespace.yaml\n}\n\nSet-Content -Path serviceaccount.yaml -Value @\"\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: $serviceaccount\n  namespace: $CreateK8sTargetNamespace \n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  namespace: $CreateK8sTargetNamespace \n  name: $rolename\nrules:\n- apiGroups: [\"*\"]\n  resources: [\"*\"]\n  verbs: [\"*\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: $binding\n  namespace: $CreateK8sTargetNamespace \nsubjects:\n- kind: ServiceAccount\n  name: $serviceaccount\n  apiGroup: \"\"\nroleRef:\n  kind: Role\n  name: $rolename\n  apiGroup: \"\"\n\"@\n\nkubectl apply -f serviceaccount.yaml\n \nSet-Content -Path secret.yaml -Value @\"\napiVersion: v1\nkind: Secret\ntype: kubernetes.io/service-account-token\nmetadata:\n  name: $serviceaccount\n  namespace: $CreateK8sTargetNamespace\n  annotations:\n    kubernetes.io/service-account.name: \"$serviceaccount\"\n\"@\n\nkubectl apply -f secret.yaml\n\n$data = kubectl get secret $serviceaccount -o jsonpath=\"{.data.token}\" --namespace=$CreateK8sTargetNamespace \n\n$token = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($data))\n$url = (kubectl config view -o json | ConvertFrom-Json).clusters[0].cluster.server\n\nNew-OctopusTokenAccount -Name $target -token $token -updateIfExisting\n\nif ([string]::IsNullOrEmpty(\"#{Octopus.Action.Kubernetes.CertificateAuthority}\") -or \"#{Octopus.Action.Kubernetes.AksAdminLogin}\" -ieq \"True\") {\n\tNew-OctopusKubernetesTarget `\n\t\t-name $target `\n\t\t-clusterUrl $url `\n\t\t-octopusRoles $CreateK8sTargetRole `\n\t\t-octopusAccountIdOrName $target `\n\t\t-namespace $CreateK8sTargetNamespace `\n\t\t-updateIfExisting `\n\t\t-skipTlsVerification True `\n\t\t-octopusDefaultWorkerPoolIdOrName \"#{Octopus.WorkerPool.Id}\" `\n        -healthCheckContainerImageFeedIdOrName \"$CreateK8sTargetContainerImageFeed\" `\n    \t-healthCheckContainerImage \"$CreateK8sTargetContainerImage\"\n} else {\n\tNew-OctopusKubernetesTarget `\n\t\t-name $target `\n\t\t-clusterUrl $url `\n\t\t-octopusRoles $CreateK8sTargetRole `\n\t\t-octopusAccountIdOrName $target `\n\t\t-namespace $CreateK8sTargetNamespace `\n\t\t-updateIfExisting `\n        -octopusServerCertificateIdOrName \"#{Octopus.Action.Kubernetes.CertificateAuthority}\" `\n\t\t-octopusDefaultWorkerPoolIdOrName \"#{Octopus.WorkerPool.Id}\" `\n        -healthCheckContainerImageFeedIdOrName \"$CreateK8sTargetContainerImageFeed\" `\n    \t-healthCheckContainerImage \"$CreateK8sTargetContainerImage\"\n}"
  },
  "Category": "Kubernetes",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/k8s-create-serviceaccount-and-target.json",
  "Website": "/step-templates/05d2d9a8-3862-49ff-97d6-5f08935f6fa3",
  "Logo": "https://i.octopus.com/library/step-templates/k8s.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/k8s-create-serviceaccount-and-target.json)

</div>
