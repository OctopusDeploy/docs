---
layout: src/layouts/Default.astro
pubDate: 2020-05-02
title: 'eksctl - Create Cluster (bash)'
description: 'Uses [eksctl](https://eksctl.io/) to create an EKS cluster and register it as a [kubernetes target](https://octopus.com/docs/infrastructure/deployment-targets/kubernetes-target) in Octopus.

eksctl must be installed on the worker executing the step.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.AwsRunScript exported 2020-05-02 by MJRichardson belongs to 'Kubernetes' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Cluster Name

`eksctl.cluster.name = `

The name of the EKS cluster

</div>
        
<div class="param">

### AWS Account

`eksctl.account = `

The AWS account used to create the cluster

</div>
        
<div class="param">

### AWS Region

`eksctl.region = `

The [AWS region code](https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints) (this can be overridden in the eksctl config)

</div>
        
<div class="param">

### eksctl config

`eksctl.yaml = `

The eksctl configuration YAML.  See [ekstl docs](https://eksctl.io/usage/creating-and-managing-clusters/).

</div>
        
<div class="param">

### Octopus Target Name

`eksctl.octopus.target.name = `

The name of the octopus kubernetes cluster target to create 

</div>
        
<div class="param">

### Octopus Target Roles

`eksctl.octopus.target.roles = `

Comma-separated list of the roles to assign to the created target in octopus

</div>
        
<div class="param">

### Default Worker Pool

`eksctl.octopus.target.defaultWorkerPool = `

The name or ID of the default worker pool for the created kubernetes target.
Leave blank to use the [default pool](https://octopus.com/docs/infrastructure/workers/worker-pools#default-worker-pool).

</div>
        

## Script body

Steps based on this template will execute the following *Bash* script.

```Bash
clusterName='#{eksctl.cluster.name}'
region='#{eksctl.region}'
kubeConfig='eks-sandbox.yaml'
eksctlYaml='eksctl.yaml'


# eksctl is required
if ! [ -x "$(command -v eksctl)" ]; then
	fail_step 'eksctl command not found'
fi

# yq is required
if ! [ -x "$(command -v yq)" ]; then
	fail_step 'yq command not found'
fi

cat >"./$eksctlYaml" <<EOL
#{eksctl.yaml}
EOL

# Check to see if the cluster exists
echo "Checking to see if cluster '$clusterName' exists"
eksctl get cluster --name $clusterName --region $region 2>&1

if [ $? -ne 0 ]
then
	echo "Cluster does not exist. Creating cluster..."
    eksctl create cluster -f $eksctlYaml --kubeconfig $kubeConfig
else
	echo "Cluster exists. Reading cluster details..."
    eksctl utils write-kubeconfig --cluster $clusterName --kubeconfig $kubeConfig 
fi

if [ ! -f $kubeConfig ]
then
	echo "$kubeConfig does not exist, so the Kubernetes target can not be created!"
	exit 1
fi

accountId=$(get_octopusvariable '#{eksctl.account}')
workerPool=$(get_octopusvariable 'eksctl.octopus.target.defaultWorkerPool')
clusterUrl=$(yq r $kubeConfig 'clusters[0].cluster.server')

# Write service message to create the k8s target
echo "##octopus[create-kubernetestarget \
    name=\"$(encode_servicemessagevalue '#{eksctl.octopus.target.name}')\" \
    octopusRoles=\"$(encode_servicemessagevalue '#{eksctl.octopus.target.roles}')\" \
    clusterName=\"$(encode_servicemessagevalue "$clusterName")\" \
    clusterUrl=\"$(encode_servicemessagevalue "$clusterUrl")\" \
    octopusAccountIdOrName=\"$(encode_servicemessagevalue "$accountId")\" \
    namespace=\"$(encode_servicemessagevalue 'default')\" \
    octopusDefaultWorkerPoolIdOrName=\"$(encode_servicemessagevalue "$workerPool")\" \
    updateIfExisting=\"$(encode_servicemessagevalue 'True')\" \
    skipTlsVerification=\"$(encode_servicemessagevalue 'True')\"]"
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20eksctl%20-%20Create%20Cluster%20(bash)&step-template=eksctl%20-%20Create%20Cluster%20(bash))

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "0388c8c3-9f27-4132-90c6-2c11b727d9fd",
  "Name": "eksctl - Create Cluster (bash)",
  "Description": "Uses [eksctl](https://eksctl.io/) to create an EKS cluster and register it as a [kubernetes target](https://octopus.com/docs/infrastructure/deployment-targets/kubernetes-target) in Octopus.\n\neksctl must be installed on the worker executing the step.",
  "Version": 3,
  "ExportedAt": "2020-05-02T15:04:09.845Z",
  "ActionType": "Octopus.AwsRunScript",
  "Author": "MJRichardson",
  "Packages": [],
  "Parameters": [
    {
      "Id": "df94426d-1270-4cf6-8b6d-1d7b6ab9579d",
      "Name": "eksctl.cluster.name",
      "Label": "Cluster Name",
      "HelpText": "The name of the EKS cluster",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "48ae65bd-df84-42e1-ab80-5c8eba31d948",
      "Name": "eksctl.account",
      "Label": "AWS Account",
      "HelpText": "The AWS account used to create the cluster",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "AmazonWebServicesAccount"
      }
    },
    {
      "Id": "2769000f-795b-486d-844f-2d5d0bb74fc2",
      "Name": "eksctl.region",
      "Label": "AWS Region",
      "HelpText": "The [AWS region code](https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints) (this can be overridden in the eksctl config)",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "80603dbb-08e2-42e1-91b3-7693bab55eb8",
      "Name": "eksctl.yaml",
      "Label": "eksctl config",
      "HelpText": "The eksctl configuration YAML.  See [ekstl docs](https://eksctl.io/usage/creating-and-managing-clusters/).",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      }
    },
    {
      "Id": "4259b03f-33a5-4b18-af55-f605de2125fe",
      "Name": "eksctl.octopus.target.name",
      "Label": "Octopus Target Name",
      "HelpText": "The name of the octopus kubernetes cluster target to create ",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "1da097f4-f09d-437e-b5ab-f1f08faa1d31",
      "Name": "eksctl.octopus.target.roles",
      "Label": "Octopus Target Roles",
      "HelpText": "Comma-separated list of the roles to assign to the created target in octopus",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "483e7e32-60ec-4c9e-bc0c-15ae5a483046",
      "Name": "eksctl.octopus.target.defaultWorkerPool",
      "Label": "Default Worker Pool",
      "HelpText": "The name or ID of the default worker pool for the created kubernetes target.\nLeave blank to use the [default pool](https://octopus.com/docs/infrastructure/workers/worker-pools#default-worker-pool).",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "Bash",
    "Octopus.Action.Aws.AssumeRole": "False",
    "Octopus.Action.AwsAccount.UseInstanceRole": "False",
    "OctopusUseBundledTooling": "False",
    "Octopus.Action.AwsAccount.Variable": "eksctl.account",
    "Octopus.Action.Script.ScriptBody": "clusterName='#{eksctl.cluster.name}'\nregion='#{eksctl.region}'\nkubeConfig='eks-sandbox.yaml'\neksctlYaml='eksctl.yaml'\n\n\n# eksctl is required\nif ! [ -x \"$(command -v eksctl)\" ]; then\n\tfail_step 'eksctl command not found'\nfi\n\n# yq is required\nif ! [ -x \"$(command -v yq)\" ]; then\n\tfail_step 'yq command not found'\nfi\n\ncat >\"./$eksctlYaml\" <<EOL\n#{eksctl.yaml}\nEOL\n\n# Check to see if the cluster exists\necho \"Checking to see if cluster '$clusterName' exists\"\neksctl get cluster --name $clusterName --region $region 2>&1\n\nif [ $? -ne 0 ]\nthen\n\techo \"Cluster does not exist. Creating cluster...\"\n    eksctl create cluster -f $eksctlYaml --kubeconfig $kubeConfig\nelse\n\techo \"Cluster exists. Reading cluster details...\"\n    eksctl utils write-kubeconfig --cluster $clusterName --kubeconfig $kubeConfig \nfi\n\nif [ ! -f $kubeConfig ]\nthen\n\techo \"$kubeConfig does not exist, so the Kubernetes target can not be created!\"\n\texit 1\nfi\n\naccountId=$(get_octopusvariable '#{eksctl.account}')\nworkerPool=$(get_octopusvariable 'eksctl.octopus.target.defaultWorkerPool')\nclusterUrl=$(yq r $kubeConfig 'clusters[0].cluster.server')\n\n# Write service message to create the k8s target\necho \"##octopus[create-kubernetestarget \\\n    name=\\\"$(encode_servicemessagevalue '#{eksctl.octopus.target.name}')\\\" \\\n    octopusRoles=\\\"$(encode_servicemessagevalue '#{eksctl.octopus.target.roles}')\\\" \\\n    clusterName=\\\"$(encode_servicemessagevalue \"$clusterName\")\\\" \\\n    clusterUrl=\\\"$(encode_servicemessagevalue \"$clusterUrl\")\\\" \\\n    octopusAccountIdOrName=\\\"$(encode_servicemessagevalue \"$accountId\")\\\" \\\n    namespace=\\\"$(encode_servicemessagevalue 'default')\\\" \\\n    octopusDefaultWorkerPoolIdOrName=\\\"$(encode_servicemessagevalue \"$workerPool\")\\\" \\\n    updateIfExisting=\\\"$(encode_servicemessagevalue 'True')\\\" \\\n    skipTlsVerification=\\\"$(encode_servicemessagevalue 'True')\\\"]\"",
    "Octopus.Action.Aws.Region": "#{eksctl.region}"
  },
  "Category": "Kubernetes",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/k8s-eksctl-create-cluster-bash.json",
  "Website": "/step-templates/0388c8c3-9f27-4132-90c6-2c11b727d9fd",
  "Logo": "https://i.octopus.com/library/step-templates/k8s.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/k8s-eksctl-create-cluster-bash.json)

</div>
