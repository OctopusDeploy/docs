---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2020-08-20
title: 'ApexSQL DevOps toolkit - Deploy'
description: 'This step will execute schema and data synchronization scripts created as deployment resource after comparison is done. 

ApexSQL DevOps toolkit - Sync and/or ApexSQL DevOps toolkit - Sync data  steps are reqiured'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2020-08-20 by ApexSQLtechops belongs to 'ApexSQL' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Retrieve package from

`DownloadPackageStepName = `

Select the step from which the synchronization sripts package can be sourced

</div>
        
<div class="param">

### Export location

`ExportPath = `

The location for exported deployment resources. Provide the path used for synchronization steps. All tentacles used in database deployment steps should have access to the chosen location

</div>
        
<div class="param">

### SQL Server

`ServerName = `

Provide the SQL Server name for the deployment target database

</div>
        
<div class="param">

### Database

`Database = `

The target database for the deployment of schema and data synchronization scripts.

</div>
        
<div class="param">

### Username

`Username = `

The account name used for SQL authentication method. Windows authentication method with the account that runs the Tentacle service will be used for SQL Server connection if left empty

</div>
        
<div class="param">

### Password

`Password = `

Enter password for chosen account used for SQL authentication method. Leave empty if Windows authentication method is used

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
$schemaSyncScript = ''
$dataSyncScript = ''
$schemaSyncQuery = ''
$dataSyncQuery= ''
$query = ''

function AddArtifact() {
    Param(
        [Parameter(Mandatory = $true)]
        [string]$artifact
    )
    if (Test-Path $artifact) {
        New-OctopusArtifact $artifact
    }
}

function Get-ParamValue
{
    param
    (
        [Parameter(Mandatory = $true)]
        [String] $ParamName
    )
    if($OctopusParameters -and ($OctopusParameters["$($ParamName)"] -ne $null))
    {
        # set the variable value
        return $OctopusParameters["$($ParamName)"]
    }
    else
    {
        # warning
        return $null
    }
}

$exportPath = '#{ExportPath}'
$PackageDownloadStepName = '#{PackageDownloadStepName}'

$projectId = $OctopusParameters["Octopus.Project.Id"]
$releaseNumber = $OctopusParameters["Octopus.Release.Number"]
$nugetPackageId = $OctopusParameters["Octopus.Action[$PackageDownloadStepName].Package.NuGetPackageId"]
$exportPath = Join-Path (Join-Path $exportPath $projectId) $releaseNumber

$defaultSchemaSyncScript = $OctopusParameters["Octopus.Action[$PackageDownloadStepName].Output.Package.InstallationDirectoryPath"] + '\SchemaSyncScript.sql'
$defaultDataSyncScript = $OctopusParameters["Octopus.Action[$PackageDownloadStepName].Output.Package.InstallationDirectoryPath"] + '\DataSyncScript.sql'

New-Item -Path $exportPath -Name "DeploySummary.txt" -ItemType "file" -Force | Out-Null
$deploySummary = $exportPath + "\DeploySummary.txt"

$schemaSyncScript = $exportPath + '\SchemaSyncScript.sql'
$dataSyncScript = $exportPath + '\DataSyncScript.sql'
$serverName = Get-ParamValue -ParamName 'ServerName'
  $database = Get-ParamValue -ParamName 'Database'
  $username = Get-ParamValue -ParamName 'Username'
  $password = Get-ParamValue -ParamName 'Password'
  $auth = ''
  
  if (-not ($null -eq $username -and $null -eq $password))
  {	
      $auth = " -U ""$($username)"" -P ""$($password)"""
  }
  else
  {	
      $auth = " -E"
  }

$sqlcmdProps = "sqlcmd.exe -S ""$($serverName)"" -d ""$($database)""$auth -b -i"
	if(Test-Path $schemaSyncScript) 
    {
		$result = Invoke-Expression -Command "$sqlcmdProps ""$schemaSyncScript"""
        $content = "Sync summary: " + $result
        if (Test-Path $deploySummary)
        {
        	Add-Content $deploySummary $content
        }
	}
  	if(Test-Path $dataSyncScript) 
    {
		$result = Invoke-Expression -Command "$sqlcmdProps ""$dataSyncScript"""
        $content = "Sync data summary: " + $result
        if (Test-Path $deploySummary)
        {
        	Add-Content $deploySummary $content
        }
	}

	if(Test-Path $defaultSchemaSyncScript) 
    {
		$result = Invoke-Expression -Command "$sqlcmdProps ""$defaultSchemaSyncScript"""
	}
    if(Test-Path $defaultDataSyncScript) 
    {
		$result = Invoke-Expression -Command "$sqlcmdProps ""$defaultDataSyncScript"""
	}

AddArtifact("$deploySummary")
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20ApexSQL%20DevOps%20toolkit%20-%20Deploy&step-template=ApexSQL%20DevOps%20toolkit%20-%20Deploy)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "42412324-a768-4943-baf8-bfe26ed2dff3",
  "Name": "ApexSQL DevOps toolkit - Deploy",
  "Description": "This step will execute schema and data synchronization scripts created as deployment resource after comparison is done. \n\nApexSQL DevOps toolkit - Sync and/or ApexSQL DevOps toolkit - Sync data  steps are reqiured",
  "Version": 2,
  "ExportedAt": "2020-08-20T11:36:52.048Z",
  "ActionType": "Octopus.Script",
  "Author": "ApexSQLtechops",
  "Packages": [],
  "Parameters": [
    {
      "Id": "ad2fad54-09c4-4210-adbc-ab238632cd67",
      "Name": "DownloadPackageStepName",
      "Label": "Retrieve package from",
      "HelpText": "Select the step from which the synchronization sripts package can be sourced",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Id": "b899f7a2-49dd-4193-8640-54e815996e02",
      "Name": "ExportPath",
      "Label": "Export location",
      "HelpText": "The location for exported deployment resources. Provide the path used for synchronization steps. All tentacles used in database deployment steps should have access to the chosen location",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "f0886e0e-f592-4fd7-ba04-8191224f3436",
      "Name": "ServerName",
      "Label": "SQL Server",
      "HelpText": "Provide the SQL Server name for the deployment target database",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "d1358f62-a3ff-4e24-b46c-036e33ff40f4",
      "Name": "Database",
      "Label": "Database",
      "HelpText": "The target database for the deployment of schema and data synchronization scripts.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "6572b012-7386-4bae-ae31-e72ac19e5171",
      "Name": "Username",
      "Label": "Username",
      "HelpText": "The account name used for SQL authentication method. Windows authentication method with the account that runs the Tentacle service will be used for SQL Server connection if left empty",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "d97dbe49-ccec-4be3-81a8-e356365aa250",
      "Name": "Password",
      "Label": "Password",
      "HelpText": "Enter password for chosen account used for SQL authentication method. Leave empty if Windows authentication method is used",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "$schemaSyncScript = ''\n$dataSyncScript = ''\n$schemaSyncQuery = ''\n$dataSyncQuery= ''\n$query = ''\n\nfunction AddArtifact() {\n    Param(\n        [Parameter(Mandatory = $true)]\n        [string]$artifact\n    )\n    if (Test-Path $artifact) {\n        New-OctopusArtifact $artifact\n    }\n}\n\nfunction Get-ParamValue\n{\n    param\n    (\n        [Parameter(Mandatory = $true)]\n        [String] $ParamName\n    )\n    if($OctopusParameters -and ($OctopusParameters[\"$($ParamName)\"] -ne $null))\n    {\n        # set the variable value\n        return $OctopusParameters[\"$($ParamName)\"]\n    }\n    else\n    {\n        # warning\n        return $null\n    }\n}\n\n$exportPath = '#{ExportPath}'\n$PackageDownloadStepName = '#{PackageDownloadStepName}'\n\n$projectId = $OctopusParameters[\"Octopus.Project.Id\"]\n$releaseNumber = $OctopusParameters[\"Octopus.Release.Number\"]\n$nugetPackageId = $OctopusParameters[\"Octopus.Action[$PackageDownloadStepName].Package.NuGetPackageId\"]\n$exportPath = Join-Path (Join-Path $exportPath $projectId) $releaseNumber\n\n$defaultSchemaSyncScript = $OctopusParameters[\"Octopus.Action[$PackageDownloadStepName].Output.Package.InstallationDirectoryPath\"] + '\\SchemaSyncScript.sql'\n$defaultDataSyncScript = $OctopusParameters[\"Octopus.Action[$PackageDownloadStepName].Output.Package.InstallationDirectoryPath\"] + '\\DataSyncScript.sql'\n\nNew-Item -Path $exportPath -Name \"DeploySummary.txt\" -ItemType \"file\" -Force | Out-Null\n$deploySummary = $exportPath + \"\\DeploySummary.txt\"\n\n$schemaSyncScript = $exportPath + '\\SchemaSyncScript.sql'\n$dataSyncScript = $exportPath + '\\DataSyncScript.sql'\n$serverName = Get-ParamValue -ParamName 'ServerName'\n  $database = Get-ParamValue -ParamName 'Database'\n  $username = Get-ParamValue -ParamName 'Username'\n  $password = Get-ParamValue -ParamName 'Password'\n  $auth = ''\n  \n  if (-not ($null -eq $username -and $null -eq $password))\n  {\t\n      $auth = \" -U \"\"$($username)\"\" -P \"\"$($password)\"\"\"\n  }\n  else\n  {\t\n      $auth = \" -E\"\n  }\n\n$sqlcmdProps = \"sqlcmd.exe -S \"\"$($serverName)\"\" -d \"\"$($database)\"\"$auth -b -i\"\n\tif(Test-Path $schemaSyncScript) \n    {\n\t\t$result = Invoke-Expression -Command \"$sqlcmdProps \"\"$schemaSyncScript\"\"\"\n        $content = \"Sync summary: \" + $result\n        if (Test-Path $deploySummary)\n        {\n        \tAdd-Content $deploySummary $content\n        }\n\t}\n  \tif(Test-Path $dataSyncScript) \n    {\n\t\t$result = Invoke-Expression -Command \"$sqlcmdProps \"\"$dataSyncScript\"\"\"\n        $content = \"Sync data summary: \" + $result\n        if (Test-Path $deploySummary)\n        {\n        \tAdd-Content $deploySummary $content\n        }\n\t}\n\n\tif(Test-Path $defaultSchemaSyncScript) \n    {\n\t\t$result = Invoke-Expression -Command \"$sqlcmdProps \"\"$defaultSchemaSyncScript\"\"\"\n\t}\n    if(Test-Path $defaultDataSyncScript) \n    {\n\t\t$result = Invoke-Expression -Command \"$sqlcmdProps \"\"$defaultDataSyncScript\"\"\"\n\t}\n\nAddArtifact(\"$deploySummary\")",
    "Octopus.Action.EnabledFeatures": ""
  },
  "Category": "ApexSQL",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/apexsql-devops-toolkit-deploy.json",
  "Website": "/step-templates/42412324-a768-4943-baf8-bfe26ed2dff3",
  "Logo": "https://i.octopus.com/library/step-templates/apexsql.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/apexsql-devops-toolkit-deploy.json)

</div>
