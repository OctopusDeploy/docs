---
layout: src/layouts/Default.astro
pubDate: 2015-11-03
title: 'Web Deploy to Azure by convention'
description: 'Makes it super simple to deploy websites to different regions inside a single process.

This script assumes that you want to deploy websites like these to multiple regions:

- playground.mydomain.com
- status.mydomain.com

When you deploy to staging and production to 3 regions, this means that each website requires 3 (regions) * 2 (deployment slots) = 6 scripts. If you want this deployed using ms web deploy, you will need 6 * 5 = 30 variables (for a single website).

With this convention script you only need a few variables, but it requires some convention (mostly done by Azure anyway):

- [prefix]-[websitename]-[region]
- [prefix]-[websitename]-[region]-staging

So

- mydomain-playground-eu-west
- mydomain-playground-eu-west-staging

The following variables are required:

- AzurePrefix
- AzureName
- AzurePassword-[region]
- AzurePassword-[region]-staging

The password is required for each region and deployment slot, the rest is fully determined by convention.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2015-11-03 by GeertvanHorrik belongs to 'Web Deploy' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Website Name

`WebsiteName`

The name of the website (e.g. playground)

If you leave this empty, this field will use the _AzureName_ variable.

</div>
        
<div class="param">

### Region Name

`RegionName`

The name of the region (e.g. eu-west)

</div>
        
<div class="param">

### Is Staging

`IsStaging = False`

Determines whether this is staging or not.

</div>
        
<div class="param">

### Prefix

`Prefix = `

The prefix. If you are smart, your websites look like this:

[prefix]-[websitename]-[region]

This allows you to deploy a lot of subdomains for a complete solution to multiple regions.

If you leave this empty, this field will use the _AzurePrefix_ variable.

</div>
        
<div class="param">

### Package step name

`WebDeployPackageStepName = `

Name of the previously-deployed package step that contains the files that you want to deploy.

If you leave this empty, this field will default to 'Extract package'

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.Web.Deployment")
# A collection of functions that can be used by script steps to determine where packages installed
# by previous steps are located on the filesystem.
 
function Find-InstallLocations {
    $result = @()
    $OctopusParameters.Keys | foreach {
        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {
            $result += $OctopusParameters[$_]
        }
    }
    return $result
}
 
function Find-InstallLocation($stepName) {
    $result = $OctopusParameters.Keys | where {
        $_.Equals("Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath",  [System.StringComparison]::OrdinalIgnoreCase)
    } | select -first 1
 
    if ($result) {
        return $OctopusParameters[$result]
    }
 
    throw "No install location found for step: $stepName"
}
 
function Find-SingleInstallLocation {
    $all = @(Find-InstallLocations)
    if ($all.Length -eq 1) {
        return $all[0]
    }
    if ($all.Length -eq 0) {
        throw "No package steps found"
    }
    throw "Multiple package steps have run; please specify a single step"
}

function Test-LastExit($cmd) {
    if ($LastExitCode -ne 0) {
        Write-Host "##octopus[stderr-error]"
        write-error "$cmd failed with exit code: $LastExitCode"
    }
}

# Somehow we can only check for exactly 'True'
$isStagingText = $OctopusParameters['IsStaging'];
$isStaging = $isStagingText -eq "True"

Write-Host "Is staging text: $isStagingText"
Write-Host "Is staging: $isStaging"

$stepName = $OctopusParameters['WebDeployPackageStepName']
if ([string]::IsNullOrEmpty($stepName)) {
	Write-Host "Defaulting to step name Extract package"
	$stepName = "Extract package"
}

if ($isStaging) {
	$stepName = $stepName + " - staging"
}

$stepPath = ""
if (-not [string]::IsNullOrEmpty($stepName)) {
    Write-Host "Finding path to package step: $stepName"
    $stepPath = Find-InstallLocation $stepName
} else {
    $stepPath = Find-SingleInstallLocation
}
Write-Host "Package was installed to: $stepPath"

Write-Host "##octopus[stderr-progress]"
 
Write-Host "Publishing Website"

$prefix = $OctopusParameters['Prefix']
if ([string]::IsNullOrEmpty($prefix)) {
	Write-Host "Prefix is empty, reading prefix from variable set using AzurePrefix"
	$prefix = $OctopusParameters['AzurePrefix']
}

$websiteName = $OctopusParameters['WebsiteName']
if ([string]::IsNullOrEmpty($websiteName)) {
	Write-Host "WebsiteName is empty, reading website name from variable set using AzureName"
	$websiteName = $OctopusParameters['AzureName']
}

$regionName = $OctopusParameters['RegionName']

$publishUrl = "$prefix-$websiteName-$regionName"
if ($isStaging) {
	$publishUrl = $publishUrl + "-staging"
}
$publishUrl = $publishUrl + ".scm.azurewebsites.net:443"

$userName = '$' + "$prefix-$websiteName-$regionName"
if ($isStaging) {
	$userName = $userName + "__staging"
}

$passwordKey = "AzurePassword-$regionName"
if ($isStaging) {
	$passwordKey = $passwordKey + "-staging"
}

Write-Host "Using the following values to publish:"
Write-Host " * Publish url: $publishUrl"
Write-Host " * Website name: $websiteName"
Write-Host " * User name: $userName"
Write-Host " * Password variable: $passwordKey"

$destBaseOptions = new-object Microsoft.Web.Deployment.DeploymentBaseOptions
$destBaseOptions.UserName = $userName
$destBaseOptions.Password =  $OctopusParameters[$passwordKey]
$destBaseOptions.ComputerName = "https://$publishUrl/msdeploy.axd?site=$websiteName"
$destBaseOptions.AuthenticationType = "Basic"

$syncOptions = new-object Microsoft.Web.Deployment.DeploymentSyncOptions
#$syncOptions.WhatIf = $false
$syncOptions.UseChecksum = $true

$deploymentObject = [Microsoft.Web.Deployment.DeploymentManager]::CreateObject("contentPath", $stepPath)
$deploymentObject.SyncTo("contentPath", $websiteName, $destBaseOptions, $syncOptions)
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Web%20Deploy%20to%20Azure%20by%20convention&step-template=Web%20Deploy%20to%20Azure%20by%20convention)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "c3ff8c78-c1cd-43ea-aedb-f5ac7dac3352",
  "Name": "Web Deploy to Azure by convention",
  "Description": "Makes it super simple to deploy websites to different regions inside a single process.\n\nThis script assumes that you want to deploy websites like these to multiple regions:\n\n- playground.mydomain.com\n- status.mydomain.com\n\nWhen you deploy to staging and production to 3 regions, this means that each website requires 3 (regions) * 2 (deployment slots) = 6 scripts. If you want this deployed using ms web deploy, you will need 6 * 5 = 30 variables (for a single website).\n\nWith this convention script you only need a few variables, but it requires some convention (mostly done by Azure anyway):\n\n- [prefix]-[websitename]-[region]\n- [prefix]-[websitename]-[region]-staging\n\nSo\n\n- mydomain-playground-eu-west\n- mydomain-playground-eu-west-staging\n\nThe following variables are required:\n\n- AzurePrefix\n- AzureName\n- AzurePassword-[region]\n- AzurePassword-[region]-staging\n\nThe password is required for each region and deployment slot, the rest is fully determined by convention.",
  "Version": 29,
  "ExportedAt": "2015-11-03T00:25:05.516+00:00",
  "ActionType": "Octopus.Script",
  "Author": "GeertvanHorrik",
  "Parameters": [
    {
      "Name": "WebsiteName",
      "Label": "Website Name",
      "HelpText": "The name of the website (e.g. playground)\n\nIf you leave this empty, this field will use the _AzureName_ variable.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "RegionName",
      "Label": "Region Name",
      "HelpText": "The name of the region (e.g. eu-west)",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "IsStaging",
      "Label": "Is Staging",
      "HelpText": "Determines whether this is staging or not.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "Prefix",
      "Label": "Prefix",
      "HelpText": "The prefix. If you are smart, your websites look like this:\n\n[prefix]-[websitename]-[region]\n\nThis allows you to deploy a lot of subdomains for a complete solution to multiple regions.\n\nIf you leave this empty, this field will use the _AzurePrefix_ variable.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "WebDeployPackageStepName",
      "Label": "Package step name",
      "HelpText": "Name of the previously-deployed package step that contains the files that you want to deploy.\n\nIf you leave this empty, this field will default to 'Extract package'",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "[System.Reflection.Assembly]::LoadWithPartialName(\"Microsoft.Web.Deployment\")\n# A collection of functions that can be used by script steps to determine where packages installed\n# by previous steps are located on the filesystem.\n \nfunction Find-InstallLocations {\n    $result = @()\n    $OctopusParameters.Keys | foreach {\n        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {\n            $result += $OctopusParameters[$_]\n        }\n    }\n    return $result\n}\n \nfunction Find-InstallLocation($stepName) {\n    $result = $OctopusParameters.Keys | where {\n        $_.Equals(\"Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath\",  [System.StringComparison]::OrdinalIgnoreCase)\n    } | select -first 1\n \n    if ($result) {\n        return $OctopusParameters[$result]\n    }\n \n    throw \"No install location found for step: $stepName\"\n}\n \nfunction Find-SingleInstallLocation {\n    $all = @(Find-InstallLocations)\n    if ($all.Length -eq 1) {\n        return $all[0]\n    }\n    if ($all.Length -eq 0) {\n        throw \"No package steps found\"\n    }\n    throw \"Multiple package steps have run; please specify a single step\"\n}\n\nfunction Test-LastExit($cmd) {\n    if ($LastExitCode -ne 0) {\n        Write-Host \"##octopus[stderr-error]\"\n        write-error \"$cmd failed with exit code: $LastExitCode\"\n    }\n}\n\n# Somehow we can only check for exactly 'True'\n$isStagingText = $OctopusParameters['IsStaging'];\n$isStaging = $isStagingText -eq \"True\"\n\nWrite-Host \"Is staging text: $isStagingText\"\nWrite-Host \"Is staging: $isStaging\"\n\n$stepName = $OctopusParameters['WebDeployPackageStepName']\nif ([string]::IsNullOrEmpty($stepName)) {\n\tWrite-Host \"Defaulting to step name Extract package\"\n\t$stepName = \"Extract package\"\n}\n\nif ($isStaging) {\n\t$stepName = $stepName + \" - staging\"\n}\n\n$stepPath = \"\"\nif (-not [string]::IsNullOrEmpty($stepName)) {\n    Write-Host \"Finding path to package step: $stepName\"\n    $stepPath = Find-InstallLocation $stepName\n} else {\n    $stepPath = Find-SingleInstallLocation\n}\nWrite-Host \"Package was installed to: $stepPath\"\n\nWrite-Host \"##octopus[stderr-progress]\"\n \nWrite-Host \"Publishing Website\"\n\n$prefix = $OctopusParameters['Prefix']\nif ([string]::IsNullOrEmpty($prefix)) {\n\tWrite-Host \"Prefix is empty, reading prefix from variable set using AzurePrefix\"\n\t$prefix = $OctopusParameters['AzurePrefix']\n}\n\n$websiteName = $OctopusParameters['WebsiteName']\nif ([string]::IsNullOrEmpty($websiteName)) {\n\tWrite-Host \"WebsiteName is empty, reading website name from variable set using AzureName\"\n\t$websiteName = $OctopusParameters['AzureName']\n}\n\n$regionName = $OctopusParameters['RegionName']\n\n$publishUrl = \"$prefix-$websiteName-$regionName\"\nif ($isStaging) {\n\t$publishUrl = $publishUrl + \"-staging\"\n}\n$publishUrl = $publishUrl + \".scm.azurewebsites.net:443\"\n\n$userName = '$' + \"$prefix-$websiteName-$regionName\"\nif ($isStaging) {\n\t$userName = $userName + \"__staging\"\n}\n\n$passwordKey = \"AzurePassword-$regionName\"\nif ($isStaging) {\n\t$passwordKey = $passwordKey + \"-staging\"\n}\n\nWrite-Host \"Using the following values to publish:\"\nWrite-Host \" * Publish url: $publishUrl\"\nWrite-Host \" * Website name: $websiteName\"\nWrite-Host \" * User name: $userName\"\nWrite-Host \" * Password variable: $passwordKey\"\n\n$destBaseOptions = new-object Microsoft.Web.Deployment.DeploymentBaseOptions\n$destBaseOptions.UserName = $userName\n$destBaseOptions.Password =  $OctopusParameters[$passwordKey]\n$destBaseOptions.ComputerName = \"https://$publishUrl/msdeploy.axd?site=$websiteName\"\n$destBaseOptions.AuthenticationType = \"Basic\"\n\n$syncOptions = new-object Microsoft.Web.Deployment.DeploymentSyncOptions\n#$syncOptions.WhatIf = $false\n$syncOptions.UseChecksum = $true\n\n$deploymentObject = [Microsoft.Web.Deployment.DeploymentManager]::CreateObject(\"contentPath\", $stepPath)\n$deploymentObject.SyncTo(\"contentPath\", $websiteName, $destBaseOptions, $syncOptions)"
  },
  "Category": "Web Deploy",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/web-deploy-azure-convention.json",
  "Website": "/step-templates/c3ff8c78-c1cd-43ea-aedb-f5ac7dac3352",
  "Logo": "https://i.octopus.com/library/step-templates/webdeploy.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/web-deploy-azure-convention.json)

</div>
