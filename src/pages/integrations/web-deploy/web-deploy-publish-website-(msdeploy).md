---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2015-07-25
title: 'Web Deploy - Publish Website (MSDeploy)'
description: 'Ensure that Web Deploy 3.5 is installed on the system. The installer is downloaded from http://www.iis.net/downloads/microsoft/web-deploy if required.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2015-07-25 by bobjwalker belongs to 'Web Deploy' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Publish Url

`PublishUrl`

Publish url to use when publishing the website.

</div>
        
<div class="param">

### Allow Untrusted Certificate

`AllowUntrustedCertificate = False`

Allow untrusted certificate at the publish URL.

</div>
        
<div class="param">

### Website Name

`WebsiteName`

Website name to use when publishing the website.

</div>
        
<div class="param">

### Username

`Username`

Username to use when authenticating with the HTTPS server.

</div>
        
<div class="param">

### null

`Password`

Password to use when authenticating with the HTTPS server. You should create a sensitive variable in your project variables, and then bind this value.

</div>
        
<div class="param">

### Package Step Name

`WebDeployPackageStepName`

Name of the previously-deployed package step that contains the files that you want to deploy.

</div>
        
<div class="param">

### Enable App Offline Rule

`EnableAppOfflineRule = False`

Enables the App Offline Rule. [See here for more details](http://www.iis.net/learn/publish/deploying-application-packages/taking-an-application-offline-before-publishing)

</div>
        
<div class="param">

### Skip Paths From Sync

`SkipSyncPaths`

Semi-colon separated, absolute reg-ex paths to skip/not-sync during deployment. Handy for folders that you don't want deleted etc. (Escape slashes)

</div>
        
<div class="param">

### Preserve App_Data

`PreserveApp_Data = True`

The App_Data and its files will not be deleted when this option is enabled

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.Web.Deployment")

# A collection of functions that can be used by script steps to determine where packages installed
# by previous steps are located on the filesystem.
 
function Find-InstallLocations {
    $result = @()
    $OctopusParameters.Keys | foreach {
        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {
            $result += $OctopusParameters[$_]
        }
    }
    return $result
}
 
function Find-InstallLocation($stepName) {
    $result = $OctopusParameters.Keys | where {
        $_.Equals("Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath",  [System.StringComparison]::OrdinalIgnoreCase)
    } | select -first 1
 
    if ($result) {
        return $OctopusParameters[$result]
    }
 
    throw "No install location found for step: $stepName"
}
 
function Find-SingleInstallLocation {
    $all = @(Find-InstallLocations)
    if ($all.Length -eq 1) {
        return $all[0]
    }
    if ($all.Length -eq 0) {
        throw "No package steps found"
    }
    throw "Multiple package steps have run; please specify a single step"
}

function Test-LastExit($cmd) {
    if ($LastExitCode -ne 0) {
        Write-Host "##octopus[stderr-error]"
        write-error "$cmd failed with exit code: $LastExitCode"
    }
}

$stepName = $OctopusParameters['WebDeployPackageStepName']

$stepPath = ""
if (-not [string]::IsNullOrEmpty($stepName)) {
    Write-Host "Finding path to package step: $stepName"
    $stepPath = Find-InstallLocation $stepName
} else {
    $stepPath = Find-SingleInstallLocation
}
Write-Host "Package was installed to: $stepPath"

Write-Host "##octopus[stderr-progress]"
 
$websiteName = $OctopusParameters['WebsiteName']
$publishUrl = $OctopusParameters['PublishUrl']

$destBaseOptions = new-object Microsoft.Web.Deployment.DeploymentBaseOptions
$destBaseOptions.UserName = $OctopusParameters['Username']
$destBaseOptions.Password = $OctopusParameters['Password']
$destBaseOptions.ComputerName = "https://$publishUrl/msdeploy.axd?site=$websiteName"
$destBaseOptions.AuthenticationType = "Basic"

$syncOptions = new-object Microsoft.Web.Deployment.DeploymentSyncOptions
$syncOptions.WhatIf = $false
$syncOptions.UseChecksum = $true

$enableAppOfflineRule = $OctopusParameters['EnableAppOfflineRule']
if($enableAppOfflineRule -eq $true)
{
    $appOfflineRule = $null
    $availableRules = [Microsoft.Web.Deployment.DeploymentSyncOptions]::GetAvailableRules()
    if (!$availableRules.TryGetValue('AppOffline', [ref]$appOfflineRule))
    {
        throw "Failed to find AppOffline Rule"
    }
    else
    {
        $syncOptions.Rules.Add($appOfflineRule)
        Write-Host "Enabled AppOffline Rule"
    }
}

$preserveAppData = [boolean]::Parse($OctopusParameters['PreserveApp_Data'])

if ($preserveAppData -eq $true) {
    
    Write-Host "Skipping delete actions on App_Data"
    $skipAppDataFiles = new-object Microsoft.Web.Deployment.DeploymentSkipRule("appDataFiles", "Delete", "filePath", "\App_Data\.*", $null)
    $skipAppDataDirectories = new-object Microsoft.Web.Deployment.DeploymentSkipRule("appDataDirectories", "Delete", "dirPath", "\App_Data(\.*|$)", $null)

    $syncOptions.Rules.Add($skipAppDataFiles);
    $syncOptions.Rules.Add($skipAppDataDirectories);
}

$SkipSyncPaths = $OctopusParameters['SkipSyncPaths']
if ([string]::IsNullOrEmpty($SkipSyncPaths) -eq $false)
{
    $skipPaths = $SkipSyncPaths.Split(";", [System.StringSplitOptions]::RemoveEmptyEntries)
    foreach($item in $skipPaths) {
        $index = $skipPaths.IndexOf($item)
        Write-Host "Skipping sync of AbsolutePath: $item."
        $name = "SkipDirective$index"
        $value = "absolutePath=$item"
        $skipDirective = new-object Microsoft.Web.Deployment.DeploymentSkipDirective($name, $value)
        $destBaseOptions.SkipDirectives.Add($skipDirective)
    }
}

if ($OctopusParameters['AllowUntrustedCertificate'] -eq $true) {
    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { return $true; }
}

Write-Host "Publishing Website"
$deploymentObject = [Microsoft.Web.Deployment.DeploymentManager]::CreateObject("contentPath", $stepPath)

$changes = $deploymentObject.SyncTo("contentPath", $websiteName, $destBaseOptions, $syncOptions)

#Write out all the changes.
$changes | Select-Object -Property *
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Web%20Deploy%20-%20Publish%20Website%20(MSDeploy)&step-template=Web%20Deploy%20-%20Publish%20Website%20(MSDeploy))

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "ba8581a6-c463-40fb-ab98-3800e761b6f4",
  "Name": "Web Deploy - Publish Website (MSDeploy)",
  "Description": "Ensure that Web Deploy 3.5 is installed on the system. The installer is downloaded from http://www.iis.net/downloads/microsoft/web-deploy if required.",
  "Version": 2,
  "ExportedAt": "2015-07-25T22:00:43.204+00:00",
  "ActionType": "Octopus.Script",
  "Author": "bobjwalker",
  "Parameters": [
    {
      "Name": "PublishUrl",
      "Label": "Publish Url",
      "HelpText": "Publish url to use when publishing the website.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "AllowUntrustedCertificate",
      "Label": "Allow Untrusted Certificate",
      "HelpText": "Allow untrusted certificate at the publish URL.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "WebsiteName",
      "Label": "Website Name",
      "HelpText": "Website name to use when publishing the website.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "Username",
      "Label": "Username",
      "HelpText": "Username to use when authenticating with the HTTPS server.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "Password",
      "Label": null,
      "HelpText": "Password to use when authenticating with the HTTPS server. You should create a sensitive variable in your project variables, and then bind this value.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "WebDeployPackageStepName",
      "Label": "Package Step Name",
      "HelpText": "Name of the previously-deployed package step that contains the files that you want to deploy.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "EnableAppOfflineRule",
      "Label": "Enable App Offline Rule",
      "HelpText": "Enables the App Offline Rule. [See here for more details](http://www.iis.net/learn/publish/deploying-application-packages/taking-an-application-offline-before-publishing)",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "SkipSyncPaths",
      "Label": "Skip Paths From Sync",
      "HelpText": "Semi-colon separated, absolute reg-ex paths to skip/not-sync during deployment. Handy for folders that you don't want deleted etc. (Escape slashes)",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "PreserveApp_Data",
      "Label": "Preserve App_Data",
      "HelpText": "The App_Data and its files will not be deleted when this option is enabled",
      "DefaultValue": "True",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "[System.Reflection.Assembly]::LoadWithPartialName(\"Microsoft.Web.Deployment\")\n\n# A collection of functions that can be used by script steps to determine where packages installed\n# by previous steps are located on the filesystem.\n \nfunction Find-InstallLocations {\n    $result = @()\n    $OctopusParameters.Keys | foreach {\n        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {\n            $result += $OctopusParameters[$_]\n        }\n    }\n    return $result\n}\n \nfunction Find-InstallLocation($stepName) {\n    $result = $OctopusParameters.Keys | where {\n        $_.Equals(\"Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath\",  [System.StringComparison]::OrdinalIgnoreCase)\n    } | select -first 1\n \n    if ($result) {\n        return $OctopusParameters[$result]\n    }\n \n    throw \"No install location found for step: $stepName\"\n}\n \nfunction Find-SingleInstallLocation {\n    $all = @(Find-InstallLocations)\n    if ($all.Length -eq 1) {\n        return $all[0]\n    }\n    if ($all.Length -eq 0) {\n        throw \"No package steps found\"\n    }\n    throw \"Multiple package steps have run; please specify a single step\"\n}\n\nfunction Test-LastExit($cmd) {\n    if ($LastExitCode -ne 0) {\n        Write-Host \"##octopus[stderr-error]\"\n        write-error \"$cmd failed with exit code: $LastExitCode\"\n    }\n}\n\n$stepName = $OctopusParameters['WebDeployPackageStepName']\n\n$stepPath = \"\"\nif (-not [string]::IsNullOrEmpty($stepName)) {\n    Write-Host \"Finding path to package step: $stepName\"\n    $stepPath = Find-InstallLocation $stepName\n} else {\n    $stepPath = Find-SingleInstallLocation\n}\nWrite-Host \"Package was installed to: $stepPath\"\n\nWrite-Host \"##octopus[stderr-progress]\"\n \n$websiteName = $OctopusParameters['WebsiteName']\n$publishUrl = $OctopusParameters['PublishUrl']\n\n$destBaseOptions = new-object Microsoft.Web.Deployment.DeploymentBaseOptions\n$destBaseOptions.UserName = $OctopusParameters['Username']\n$destBaseOptions.Password = $OctopusParameters['Password']\n$destBaseOptions.ComputerName = \"https://$publishUrl/msdeploy.axd?site=$websiteName\"\n$destBaseOptions.AuthenticationType = \"Basic\"\n\n$syncOptions = new-object Microsoft.Web.Deployment.DeploymentSyncOptions\n$syncOptions.WhatIf = $false\n$syncOptions.UseChecksum = $true\n\n$enableAppOfflineRule = $OctopusParameters['EnableAppOfflineRule']\nif($enableAppOfflineRule -eq $true)\n{\n    $appOfflineRule = $null\n    $availableRules = [Microsoft.Web.Deployment.DeploymentSyncOptions]::GetAvailableRules()\n    if (!$availableRules.TryGetValue('AppOffline', [ref]$appOfflineRule))\n    {\n        throw \"Failed to find AppOffline Rule\"\n    }\n    else\n    {\n        $syncOptions.Rules.Add($appOfflineRule)\n        Write-Host \"Enabled AppOffline Rule\"\n    }\n}\n\n$preserveAppData = [boolean]::Parse($OctopusParameters['PreserveApp_Data'])\n\nif ($preserveAppData -eq $true) {\n    \n    Write-Host \"Skipping delete actions on App_Data\"\n    $skipAppDataFiles = new-object Microsoft.Web.Deployment.DeploymentSkipRule(\"appDataFiles\", \"Delete\", \"filePath\", \"\\App_Data\\.*\", $null)\n    $skipAppDataDirectories = new-object Microsoft.Web.Deployment.DeploymentSkipRule(\"appDataDirectories\", \"Delete\", \"dirPath\", \"\\App_Data(\\.*|$)\", $null)\n\n    $syncOptions.Rules.Add($skipAppDataFiles);\n    $syncOptions.Rules.Add($skipAppDataDirectories);\n}\n\n$SkipSyncPaths = $OctopusParameters['SkipSyncPaths']\nif ([string]::IsNullOrEmpty($SkipSyncPaths) -eq $false)\n{\n    $skipPaths = $SkipSyncPaths.Split(\";\", [System.StringSplitOptions]::RemoveEmptyEntries)\n    foreach($item in $skipPaths) {\n        $index = $skipPaths.IndexOf($item)\n        Write-Host \"Skipping sync of AbsolutePath: $item.\"\n        $name = \"SkipDirective$index\"\n        $value = \"absolutePath=$item\"\n        $skipDirective = new-object Microsoft.Web.Deployment.DeploymentSkipDirective($name, $value)\n        $destBaseOptions.SkipDirectives.Add($skipDirective)\n    }\n}\n\nif ($OctopusParameters['AllowUntrustedCertificate'] -eq $true) {\n    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { return $true; }\n}\n\nWrite-Host \"Publishing Website\"\n$deploymentObject = [Microsoft.Web.Deployment.DeploymentManager]::CreateObject(\"contentPath\", $stepPath)\n\n$changes = $deploymentObject.SyncTo(\"contentPath\", $websiteName, $destBaseOptions, $syncOptions)\n\n#Write out all the changes.\n$changes | Select-Object -Property *",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Category": "Web Deploy",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/web-deploy-publish-website-msdeploy.json",
  "Website": "/step-templates/ba8581a6-c463-40fb-ab98-3800e761b6f4",
  "Logo": "https://i.octopus.com/library/step-templates/webdeploy.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/web-deploy-publish-website-msdeploy.json)

</div>
