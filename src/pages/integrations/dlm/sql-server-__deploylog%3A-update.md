---
layout: src/layouts/Default.astro
pubDate: 2020-10-02
title: 'SQL Server __DeployLog: Update'
description: 'To be used with:
SQL Server __DeployLog: Read

Requires sqlserver PowerShell module on target machine.

For more information: https://octopus.com/blog/100x-faster-db-deploys'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2020-10-02 by Alex-Yates belongs to 'dlm' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Database package deployment step (Required)

`DLM_PackageStep = `

The step that deploys the package containing the database source code to the target machine.

</div>
        
<div class="param">

### Database update step (Required)

`DLM_DeployStep = `

The step that updates the target database.

</div>
        
<div class="param">

### Target SQL Server Instance (Required)

`DLM_ServerInstance = `

The name of the target SQL Server instance.
e.g. SQLSERVER01\myInstance

</div>
        
<div class="param">

### Target SQL Server Database (Required)

`DLM_Database = `

The name of the target database.

</div>
        
<div class="param">

### SQL Auth User (Optional)

`DLM_Username = `

The SQL Auth user used to authenticate against the target database. (For Windows Auth, leave blank.)

</div>
        
<div class="param">

### SQL Auth Password (Optional)

`DLM_Password = `

The SQL Auth password used to authenticate against the target database. (For Windows Auth, leave blank.)

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
<#
Required variables:
$DLM_PackageStep
$DLM_DeployStep
$DLM_ServerInstance
$DLM_Database

Optional variables (include for SQL Auth, exclude for WinAuth):
$DLM_Username
$DLM_Password
#>

$errorActionPreference = "stop"

# Verifying that sqlserver module is installed
If (-not(Get-InstalledModule sqlserver -ErrorAction silentlycontinue)) {
  Write-Error "This step requires the sqlserver PowerShell module. Please install it and try again."
}
Else {
  Write-Output "PowerShell module sqlserver is already installed."
}

# Declaring variabes
$deployed_by = ([Environment]::UserDomainName + "\" + [Environment]::UserName)
$currentPackageVersion = $OctopusParameters["Octopus.Action[$DLM_PackageStep].Package.PackageVersion"]
$octo_release_number = $OctopusParameters["Octopus.Release.Number"]
$octo_deployment_id = $OctopusParameters["Octopus.Deployment.Id"]
$octo_deployment_created_by = $OctopusParameters["Octopus.Deployment.CreatedBy.Username"]
$deployStatusCode = $OctopusParameters["Octopus.Step[$DLM_DeployStep].Status.Code"]
$deployStatusError = $OctopusParameters["Octopus.Step[$DLM_DeployStep].Status.Error"]
$deployStatusErrorDetail = $OctopusParameters["Octopus.Step[$DLM_DeployStep].Status.ErrorDetail"]
$timestamp = Get-Date
$utcTime = [datetime]::Now.ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss")

# Escaping single quotes to avoid breaking T-SQL INSERT statements
$deployStatusError = $deployStatusError -replace "'", "''"
$deployStatusErrorDetail = $deployStatusErrorDetail -replace "'", "''"

# Logging input variables
Write-Verbose "DLM_PackageStep step is: $DLM_PackageStep"
Write-Verbose "DLM_DeployStep step is: $DLM_DeployStep"
Write-Verbose "DLM_ServerInstance instance is: $DLM_ServerInstance"
Write-Verbose "DLM_Database is: $DLM_Database"
Write-Verbose "DLM_Username is: $DLM_Username"
Write-Verbose "deployed_by is: $deployed_by"
Write-Verbose "currentPackageVersion is: $currentPackageVersion"
Write-Verbose "octo_release_number is: $octo_release_number"
Write-Verbose "octo_deployment_id is: $octo_deployment_id"
Write-Verbose "octo_deployment_created_by is: $octo_deployment_created_by"
Write-Verbose "deployStatusCode is: $deployStatusCode"
Write-Verbose "deployStatusError is: $deployStatusError"
Write-Verbose "deployStatusErrorDetail is: $deployStatusErrorDetail"
Write-Verbose "utcTime is: $utcTime"

# For invoke-sqlcmd authentication
$auth=@{}
if($DLM_Username){$auth=@{UserName=$DLM_Username;Password=$DLM_Password}}

# Script to check whether __DeployLog exists in target database
$CheckDeployLogExists = @'
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES
           WHERE TABLE_NAME = N'__DeployLog')
    BEGIN
    SELECT 'TRUE'
    END 
ELSE
    BEGIN
    SELECT 'FALSE'
    End
'@

# Script to create the __DeployLog table if it does not already exist
$CreateDeployLogTbl = @'
CREATE TABLE [dbo].[__DeployLog](
	[deploy_id] [int] IDENTITY(1,1) PRIMARY KEY,
	[package_version] [varchar](255) NOT NULL,
 	[octo_release_number] [nvarchar](50) NOT NULL,
   	[octo_deployment_id] [nvarchar](50) NOT NULL,
    [octo_deployment_created_by] [nvarchar](255) NOT NULL,
	[utc_time] [datetime2](7) NOT NULL,
	[deployed_by] [nvarchar](50) NULL,
    [status_code] [nvarchar](50) NULL,
    [status_error] [nvarchar](MAX) NULL,
    [status_error_detail] [nvarchar](MAX) NULL
    )
GO
'@

# Checking if __DeployLog still exists following deployment 
# (it may have been dropped if it wasn't included in source code)
$DeployLogExists = Invoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $CheckDeployLogExists @Auth
$DeployLogExists = $DeployLogExists[0]

# If __DeployLog has been dropped, recreate it
if($DeployLogExists -eq "FALSE") {
    Write-Warning "Table __DeployLog does not exist in $DLM_Database on $DLM_ServerInstance post-deployment. It may have been deleted. You should either add the table to your source code or your filter to avoid data loss."
    Write-Output "Redeploying __DeployLog table"
    Invoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $CreateDeployLogTbl @Auth
}

# Script to update __DeployLog with info about this deployment
$updateDeployLog = @"
INSERT INTO [dbo].[__DeployLog]
           ([package_version]
           ,[octo_release_number]
           ,[octo_deployment_id]
           ,[octo_deployment_created_by]
           ,[utc_time]
           ,[deployed_by]
           ,[status_code]
           ,[status_error]
           ,[status_error_detail])
     VALUES
           ('$currentPackageVersion'
           ,'$octo_release_number'
           ,'$octo_deployment_id'
           ,'$octo_deployment_created_by'
           ,'$utcTime'
           ,'$deployed_by'
           ,'$deployStatusCode'
           ,'$deployStatusError'
           ,'$deployStatusErrorDetail')
GO
"@

Write-Output "Updating __DeployLog in $DLM_Database on $DLM_ServerInstance."
Invoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $updateDeployLog @Auth
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20SQL%20Server%20__DeployLog%3A%20Update&step-template=SQL%20Server%20__DeployLog%3A%20Update)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "a9f7644c-3e27-4e46-a591-eee7f3542032",
  "Name": "SQL Server __DeployLog: Update",
  "Description": "To be used with:\nSQL Server __DeployLog: Read\r\n\r\nRequires sqlserver PowerShell module on target machine.\r\n\r\nFor more information: https://octopus.com/blog/100x-faster-db-deploys",
  "Version": 2,
  "ExportedAt": "2020-10-02T14:46:20.483Z",
  "ActionType": "Octopus.Script",
  "Author": "Alex-Yates",
  "Packages": [],
  "Parameters": [
    {
      "Id": "a2328977-2df7-42bb-9f23-263031f27fe7",
      "Name": "DLM_PackageStep",
      "Label": "Database package deployment step (Required)",
      "HelpText": "The step that deploys the package containing the database source code to the target machine.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Id": "c4668938-09ea-4b42-9be5-61dfcee9eae6",
      "Name": "DLM_DeployStep",
      "Label": "Database update step (Required)",
      "HelpText": "The step that updates the target database.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Id": "871c40e6-9435-4cc5-8f52-a54eaf8c71ad",
      "Name": "DLM_ServerInstance",
      "Label": "Target SQL Server Instance (Required)",
      "HelpText": "The name of the target SQL Server instance.\ne.g. SQLSERVER01\\myInstance",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "553359a5-9ee8-43a8-b6fc-aa7e5f9d9d9e",
      "Name": "DLM_Database",
      "Label": "Target SQL Server Database (Required)",
      "HelpText": "The name of the target database.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "61f123b1-cb7d-423f-bf3e-da979c3aa539",
      "Name": "DLM_Username",
      "Label": "SQL Auth User (Optional)",
      "HelpText": "The SQL Auth user used to authenticate against the target database. (For Windows Auth, leave blank.)",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "b373aa81-7807-4653-928b-acf39f6a4888",
      "Name": "DLM_Password",
      "Label": "SQL Auth Password (Optional)",
      "HelpText": "The SQL Auth password used to authenticate against the target database. (For Windows Auth, leave blank.)",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "<#\nRequired variables:\n$DLM_PackageStep\n$DLM_DeployStep\n$DLM_ServerInstance\n$DLM_Database\n\nOptional variables (include for SQL Auth, exclude for WinAuth):\n$DLM_Username\n$DLM_Password\n#>\n\n$errorActionPreference = \"stop\"\n\n# Verifying that sqlserver module is installed\nIf (-not(Get-InstalledModule sqlserver -ErrorAction silentlycontinue)) {\n  Write-Error \"This step requires the sqlserver PowerShell module. Please install it and try again.\"\n}\nElse {\n  Write-Output \"PowerShell module sqlserver is already installed.\"\n}\n\n# Declaring variabes\n$deployed_by = ([Environment]::UserDomainName + \"\\\" + [Environment]::UserName)\n$currentPackageVersion = $OctopusParameters[\"Octopus.Action[$DLM_PackageStep].Package.PackageVersion\"]\n$octo_release_number = $OctopusParameters[\"Octopus.Release.Number\"]\n$octo_deployment_id = $OctopusParameters[\"Octopus.Deployment.Id\"]\n$octo_deployment_created_by = $OctopusParameters[\"Octopus.Deployment.CreatedBy.Username\"]\n$deployStatusCode = $OctopusParameters[\"Octopus.Step[$DLM_DeployStep].Status.Code\"]\n$deployStatusError = $OctopusParameters[\"Octopus.Step[$DLM_DeployStep].Status.Error\"]\n$deployStatusErrorDetail = $OctopusParameters[\"Octopus.Step[$DLM_DeployStep].Status.ErrorDetail\"]\n$timestamp = Get-Date\n$utcTime = [datetime]::Now.ToUniversalTime().ToString(\"yyyy-MM-dd HH:mm:ss\")\n\n# Escaping single quotes to avoid breaking T-SQL INSERT statements\n$deployStatusError = $deployStatusError -replace \"'\", \"''\"\n$deployStatusErrorDetail = $deployStatusErrorDetail -replace \"'\", \"''\"\n\n# Logging input variables\nWrite-Verbose \"DLM_PackageStep step is: $DLM_PackageStep\"\nWrite-Verbose \"DLM_DeployStep step is: $DLM_DeployStep\"\nWrite-Verbose \"DLM_ServerInstance instance is: $DLM_ServerInstance\"\nWrite-Verbose \"DLM_Database is: $DLM_Database\"\nWrite-Verbose \"DLM_Username is: $DLM_Username\"\nWrite-Verbose \"deployed_by is: $deployed_by\"\nWrite-Verbose \"currentPackageVersion is: $currentPackageVersion\"\nWrite-Verbose \"octo_release_number is: $octo_release_number\"\nWrite-Verbose \"octo_deployment_id is: $octo_deployment_id\"\nWrite-Verbose \"octo_deployment_created_by is: $octo_deployment_created_by\"\nWrite-Verbose \"deployStatusCode is: $deployStatusCode\"\nWrite-Verbose \"deployStatusError is: $deployStatusError\"\nWrite-Verbose \"deployStatusErrorDetail is: $deployStatusErrorDetail\"\nWrite-Verbose \"utcTime is: $utcTime\"\n\n# For invoke-sqlcmd authentication\n$auth=@{}\nif($DLM_Username){$auth=@{UserName=$DLM_Username;Password=$DLM_Password}}\n\n# Script to check whether __DeployLog exists in target database\n$CheckDeployLogExists = @'\nIF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES\n           WHERE TABLE_NAME = N'__DeployLog')\n    BEGIN\n    SELECT 'TRUE'\n    END \nELSE\n    BEGIN\n    SELECT 'FALSE'\n    End\n'@\n\n# Script to create the __DeployLog table if it does not already exist\n$CreateDeployLogTbl = @'\nCREATE TABLE [dbo].[__DeployLog](\n\t[deploy_id] [int] IDENTITY(1,1) PRIMARY KEY,\n\t[package_version] [varchar](255) NOT NULL,\n \t[octo_release_number] [nvarchar](50) NOT NULL,\n   \t[octo_deployment_id] [nvarchar](50) NOT NULL,\n    [octo_deployment_created_by] [nvarchar](255) NOT NULL,\n\t[utc_time] [datetime2](7) NOT NULL,\n\t[deployed_by] [nvarchar](50) NULL,\n    [status_code] [nvarchar](50) NULL,\n    [status_error] [nvarchar](MAX) NULL,\n    [status_error_detail] [nvarchar](MAX) NULL\n    )\nGO\n'@\n\n# Checking if __DeployLog still exists following deployment \n# (it may have been dropped if it wasn't included in source code)\n$DeployLogExists = Invoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $CheckDeployLogExists @Auth\n$DeployLogExists = $DeployLogExists[0]\n\n# If __DeployLog has been dropped, recreate it\nif($DeployLogExists -eq \"FALSE\") {\n    Write-Warning \"Table __DeployLog does not exist in $DLM_Database on $DLM_ServerInstance post-deployment. It may have been deleted. You should either add the table to your source code or your filter to avoid data loss.\"\n    Write-Output \"Redeploying __DeployLog table\"\n    Invoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $CreateDeployLogTbl @Auth\n}\n\n# Script to update __DeployLog with info about this deployment\n$updateDeployLog = @\"\nINSERT INTO [dbo].[__DeployLog]\n           ([package_version]\n           ,[octo_release_number]\n           ,[octo_deployment_id]\n           ,[octo_deployment_created_by]\n           ,[utc_time]\n           ,[deployed_by]\n           ,[status_code]\n           ,[status_error]\n           ,[status_error_detail])\n     VALUES\n           ('$currentPackageVersion'\n           ,'$octo_release_number'\n           ,'$octo_deployment_id'\n           ,'$octo_deployment_created_by'\n           ,'$utcTime'\n           ,'$deployed_by'\n           ,'$deployStatusCode'\n           ,'$deployStatusError'\n           ,'$deployStatusErrorDetail')\nGO\n\"@\n\nWrite-Output \"Updating __DeployLog in $DLM_Database on $DLM_ServerInstance.\"\nInvoke-Sqlcmd -ServerInstance $DLM_ServerInstance -Database $DLM_Database -Query $updateDeployLog @Auth"
  },
  "Category": "dlm",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/sql-deploylog-update.json",
  "Website": "/step-templates/a9f7644c-3e27-4e46-a591-eee7f3542032",
  "Logo": "https://i.octopus.com/library/step-templates/dlm.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/sql-deploylog-update.json)

</div>
