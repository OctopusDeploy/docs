---
layout: src/layouts/Default.astro
pubDate: 2023-02-16
title: 'Worker - Health check'
description: 'Run a health check against a worker.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2023-02-16 by harrisonmeister belongs to 'Octopus' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Worker name

`WorkerName = `

Name of the worker to do a health check on.

</div>
        
<div class="param">

### Worker Pool

`WorkerPoolName = `

(Optional) Worker pool the worker belongs to.

</div>
        
<div class="param">

### Api Key

`WorkerApiKey = `

Api Key to use to issue health check.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
# Define parameters
$baseUrl = $OctopusParameters['Octopus.Web.ServerUri'] 
$apiKey = $WorkerApiKey
$spaceId = $OctopusParameters['Octopus.Space.Id']
$spaceName = $OctopusParameters['Octopus.Space.Name']
$environmentName = $OctopusParameters['Octopus.Environment.Name']
$workerName = $OctopusParameters['WorkerName']
$workerPoolName = $OctopusParameters['WorkerPoolName']

# Check for null or empty
if ([string]::IsNullOrEmpty($baseUrl))
{
	$baseUrl = $OctopusParameters['#{if Octopus.Web.ServerUri}Octopus.Web.ServerUri#{else}Octopus.Web.BaseUrl#{/if}']
}

# Get worker
if (![string]::IsNullOrEmpty($workerPoolName))
{
    # Get worker pool
    $workerPool = (Invoke-RestMethod -Method Get -Uri "$baseUrl/api/$spaceId/workerpools/all" -Headers @{"X-Octopus-ApiKey"="$apiKey"}) | Where-Object {$_.Name -eq $workerPoolName}
    
    # Check to make sure it exists
    if ($null -ne $workerPool)
    {
        $worker = (Invoke-RestMethod -Method Get -Uri "$baseUrl/api/$spaceId/workerpools/$($workerPool.Id)/workers" -Headers @{"X-Octopus-ApiKey"="$apiKey"}).Items | Where-Object {$_.Name -eq "$workerName"}
    }
    else
    {
    	Write-Error "Worker pool $workerPoolName not found!"
    }
}
else
{
    $worker = (Invoke-RestMethod -Method Get -Uri "$baseUrl/api/$spaceId/workers/all" -Headers @{"X-Octopus-ApiKey"="$apiKey"}) | Where-Object {$_.Name -eq "$workerName"}
}

# Check to make sure something was returned
if ($null -eq $worker)
{
	if (![string]::IsNullOrEmpty($workerPoolName))
    {
    	Write-Error "Unable to find $workerName in $workerPoolName!"
    }
    else
    {
    	Write-Error "Unable to find $workerName!"
    }
}

# Build payload
$jsonPayload = @{
	Name = "Health"
    Description = "Check $workerName health"
    Arguments = @{
    	Timeout = "00:05:00"
        MachineIds = @(
        	$worker.Id
        )
    OnlyTestConnection = "false"
    }
    SpaceId = "$spaceId"
}

# Display message
Write-Output "Beginning health check of $workerName ..."

# Execute health check
$healthCheck = (Invoke-RestMethod -Method Post -Uri "$baseUrl/api/tasks" -Body ($jsonPayload | ConvertTo-Json -Depth 10) -Headers @{"X-Octopus-ApiKey"="$apiKey"})

# Check to see if the health check is queued
while ($healthCheck.IsCompleted -eq $false)
{
    $healthCheck = (Invoke-RestMethod -Method Get -Uri "$baseUrl/api/tasks/$($healthCheck.Id)" -Headers @{"X-Octopus-ApiKey"="$apiKey"})
}

if ($healthCheck.State -eq "Failed")
{
	Write-Error "Health check failed!"
}
else
{
	Write-Output "Health check completed with $($healthCheck.State)."
}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Worker%20-%20Health%20check&step-template=Worker%20-%20Health%20check)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "c6c23c7b-876d-4758-a908-511f066156d7",
  "Name": "Worker - Health check",
  "Description": "Run a health check against a worker.",
  "Version": 4,
  "ExportedAt": "2023-02-16T15:38:44.043Z",
  "ActionType": "Octopus.Script",
  "Author": "harrisonmeister",
  "Packages": [],
  "Parameters": [
    {
      "Id": "4ec84f25-8c23-4576-b7fe-3b60ca6f0f3c",
      "Name": "WorkerName",
      "Label": "Worker name",
      "HelpText": "Name of the worker to do a health check on.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "d876958b-1d93-45fa-996e-2005de2919ee",
      "Name": "WorkerPoolName",
      "Label": "Worker Pool",
      "HelpText": "(Optional) Worker pool the worker belongs to.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "1939947b-e777-4e4a-8caf-729dacb25aed",
      "Name": "WorkerApiKey",
      "Label": "Api Key",
      "HelpText": "Api Key to use to issue health check.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "# Define parameters\n$baseUrl = $OctopusParameters['Octopus.Web.ServerUri'] \n$apiKey = $WorkerApiKey\n$spaceId = $OctopusParameters['Octopus.Space.Id']\n$spaceName = $OctopusParameters['Octopus.Space.Name']\n$environmentName = $OctopusParameters['Octopus.Environment.Name']\n$workerName = $OctopusParameters['WorkerName']\n$workerPoolName = $OctopusParameters['WorkerPoolName']\n\n# Check for null or empty\nif ([string]::IsNullOrEmpty($baseUrl))\n{\n\t$baseUrl = $OctopusParameters['#{if Octopus.Web.ServerUri}Octopus.Web.ServerUri#{else}Octopus.Web.BaseUrl#{/if}']\n}\n\n# Get worker\nif (![string]::IsNullOrEmpty($workerPoolName))\n{\n    # Get worker pool\n    $workerPool = (Invoke-RestMethod -Method Get -Uri \"$baseUrl/api/$spaceId/workerpools/all\" -Headers @{\"X-Octopus-ApiKey\"=\"$apiKey\"}) | Where-Object {$_.Name -eq $workerPoolName}\n    \n    # Check to make sure it exists\n    if ($null -ne $workerPool)\n    {\n        $worker = (Invoke-RestMethod -Method Get -Uri \"$baseUrl/api/$spaceId/workerpools/$($workerPool.Id)/workers\" -Headers @{\"X-Octopus-ApiKey\"=\"$apiKey\"}).Items | Where-Object {$_.Name -eq \"$workerName\"}\n    }\n    else\n    {\n    \tWrite-Error \"Worker pool $workerPoolName not found!\"\n    }\n}\nelse\n{\n    $worker = (Invoke-RestMethod -Method Get -Uri \"$baseUrl/api/$spaceId/workers/all\" -Headers @{\"X-Octopus-ApiKey\"=\"$apiKey\"}) | Where-Object {$_.Name -eq \"$workerName\"}\n}\n\n# Check to make sure something was returned\nif ($null -eq $worker)\n{\n\tif (![string]::IsNullOrEmpty($workerPoolName))\n    {\n    \tWrite-Error \"Unable to find $workerName in $workerPoolName!\"\n    }\n    else\n    {\n    \tWrite-Error \"Unable to find $workerName!\"\n    }\n}\n\n# Build payload\n$jsonPayload = @{\n\tName = \"Health\"\n    Description = \"Check $workerName health\"\n    Arguments = @{\n    \tTimeout = \"00:05:00\"\n        MachineIds = @(\n        \t$worker.Id\n        )\n    OnlyTestConnection = \"false\"\n    }\n    SpaceId = \"$spaceId\"\n}\n\n# Display message\nWrite-Output \"Beginning health check of $workerName ...\"\n\n# Execute health check\n$healthCheck = (Invoke-RestMethod -Method Post -Uri \"$baseUrl/api/tasks\" -Body ($jsonPayload | ConvertTo-Json -Depth 10) -Headers @{\"X-Octopus-ApiKey\"=\"$apiKey\"})\n\n# Check to see if the health check is queued\nwhile ($healthCheck.IsCompleted -eq $false)\n{\n    $healthCheck = (Invoke-RestMethod -Method Get -Uri \"$baseUrl/api/tasks/$($healthCheck.Id)\" -Headers @{\"X-Octopus-ApiKey\"=\"$apiKey\"})\n}\n\nif ($healthCheck.State -eq \"Failed\")\n{\n\tWrite-Error \"Health check failed!\"\n}\nelse\n{\n\tWrite-Output \"Health check completed with $($healthCheck.State).\"\n}\n"
  },
  "Category": "Octopus",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/octopus-worker-healthcheck.json",
  "Website": "/step-templates/c6c23c7b-876d-4758-a908-511f066156d7",
  "Logo": "https://i.octopus.com/library/step-templates/octopus.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/octopus-worker-healthcheck.json)

</div>
