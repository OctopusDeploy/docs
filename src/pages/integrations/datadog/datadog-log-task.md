---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2021-03-04
title: 'Datadog - Log Task'
description: 'Log details of a task to Datadog, including error detail.

**Configuration**: 

* In Datadog, add a [standard attribute](https://docs.datadoghq.com/logs/processing/attributes_naming_convention/#standard-attributes-and-aliasing) of `octopus.deployment.properties` to see and access JSON details of the task.  

* When using the step, set the [run condition](https://octopus.com/docs/projects/steps/conditions) of the step to `Always run` to ensure logs are sent for errors as well as successful tasks.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2021-03-04 by octocrock belongs to 'Datadog' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Datadog URL

`DatadogUrl = https://http-intake.logs.datadoghq.eu/v1/input`

The URL for POSTing log information

</div>
        
<div class="param">

### Datadog API Key

`DatadogAPIKey = `

[API Key](https://docs.datadoghq.com/account_management/api-app-keys/#api-keys) required for accessing API.

</div>
        
<div class="param">

### Datadog Application Key

`DatadogApplicationKey = `

Information on Datadog [Application Keys](https://docs.datadoghq.com/account_management/api-app-keys/#application-keys)

</div>
        
<div class="param">

### Datadog Service Name

`DatadogServiceName = Octopus Deploy`

null

</div>
        
<div class="param">

### 

`DatadogOctopusAPIKey = `

Only used when an exception has occurred.

Octopus instance [API Key](https://octopus.com/docs/octopus-rest-api/how-to-create-an-api-key).   Requires at least `TaskView` [permission](https://octopus.com/docs/security/users-and-teams/system-and-space-permissions).

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
  
function Send-DatadogEvent (
    $datadog,
    [string] $text,
    [string] $level,
    $properties = @{},
    [string] $exception = $null,
    [switch] $template) {
    
    
    if (-not $level) {
        $level = 'Information'
    }

    if (@('Verbose', 'Debug', 'Information', 'Warning', 'Error', 'Fatal') -notcontains $level) {
        $level = 'Information'
    }


    $ddtags = "project:$($properties.ProjectName),deploymentname:$($properties.DeploymentName),env:$($properties.EnvironmentName)"
    if ($properties["TaskType"] -eq "Runbook") {
        $ddtags += ",runbookname:$($properties.RunbookName),tasktype:runbook"
    }
    else {
        $ddtags += ",tasktype:deployment"    
    }

    $body = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
    $body.Add("ddsource", "Octopus Deploy")
    $body.Add("ddtags", $ddtags)
    $body.Add("service", $DatadogServiceName)
    $body.Add("hostname", "https://octopus.the-crock.com/")
    $body.Add("http.url", "$($properties["TaskLink"])")
    $body.Add("octopus.deployment.properties", "$($properties | ConvertTo-Json)")

    if ($exception) {
        $body.Add("error.message", "$($properties["Error"])")
        $body.Add("error.stack", "$($exception)")
    }
    
    $body.Add("level", "$($level)")
  
    $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
    $headers.Add("Content-Type", "application/json")
    $headers.Add("DD-APPLICATION-KEY", "$($DatadogApplicationKey)")
    $headers.Add("DD-API-KEY", "$($DatadogApiKey)")

    Invoke-RestMethod -Uri $DatadogUrl -Body $($body | ConvertTo-Json)  -ContentType "application/json" -Method POST -Headers $headers
}

function Set-ErrorDetails(){

    $octopusAPIHeader = @{ "X-Octopus-ApiKey" = $DatadogOctopusAPIKey }
    $taskDetailUri = "$($OctopusParameters['Octopus.Web.ServerUri'])/api/tasks/$($OctopusParameters["Octopus.Task.Id"])/details"

    $taskDetails = Invoke-RestMethod -Method Get -Uri $taskDetailUri -Headers $octopusAPIHeader 
    $errorMessage = "";
    $errorFirstLine = "";
    $isFirstLine = $true;

    foreach ($activityLog in $taskDetails.ActivityLogs) {
        foreach ($activityLogChild1 in $activityLog.Children) {
            foreach ($activityLogChild2 in $activityLogChild1.Children) {
                foreach ($logElement in $activityLogChild2.LogElements) {
                    if ($logElement.Category -eq "Error") {
                        if ($isFirstLine -eq $true) {
                            $errorFirstLine = $logElement.MessageText;
                            $isFirstLine = $false;
                        }

                        $errorMessage += $logElement.MessageText + " `n"
                    }
                }
            }
        }
    }

    $exInfo = @{
        firstLine = $errorFirstLine
        message = $errorMessage
    }

    return $exInfo;
}

function Set-TaskProperties(){
    $taskProperties = @{
        ProjectName     = $OctopusParameters['Octopus.Project.Name'];
        Result          = "succeeded";
        InstanceUrl     = $OctopusParameters['Octopus.Web.ServerUri'];
        EnvironmentName = $OctopusParameters['Octopus.Environment.Name'];
        DeploymentName  = $OctopusParameters['Octopus.Deployment.Name'];
        TenantName      = $OctopusParameters["Octopus.Deployment.Tenant.Name"]
        TaskLink        = $taskLink
    }
    
    if ([string]::IsNullOrEmpty($OctopusParameters["Octopus.Runbook.Id"]) -eq $false) {
        $taskProperties["TaskType"] 			= "Runbook"
        $taskProperties["RunbookSnapshotName"] 	= $OctopusParameters["Octopus.RunbookSnapshot.Name"]
        $taskProperties["RunbookName"]         	= $OctopusParameters["Octopus.Runbook.Name"]
    }
    else {
        $taskProperties["TaskType"] 		= "Deployment"
        $taskProperties["ReleaseNumber"] 	= $OctopusParameters['Octopus.Release.Number'];
        $taskProperties["Channel"]  		= $OctopusParameters['Octopus.Release.Channel.Name'];
    }

    return $taskProperties;
}

#******************************************************************

$taskLink = $OctopusParameters['Octopus.Web.ServerUri'] + "/app#/" + $OctopusParameters["Octopus.Space.Id"] + "/tasks/" + $OctopusParameters["Octopus.Task.Id"]
$level = "Information"
$exception = $null

Write-Output "Logging the deployment result to Datadog at $DatadogServerUrl..."

$properties = Set-TaskProperties

if ($OctopusParameters['Octopus.Deployment.Error']) {
    $exceptionInfo = Set-ErrorDetails
    $properties["Result"] = "failed"
    $properties["Error"] = $exceptionInfo["firstLine"]
    $exception = $exceptionInfo["message"]
    $level = "Error"
}

try {
    Send-DatadogEvent $datadog "A deployment of $($properties.ProjectName) release $($properties.ReleaseNumber) $($properties.Result) in $($properties.EnvironmentName)" -level $level -template -properties $properties -exception $exception
}
catch [Exception] {
    Write-Error "Unable to write task details to Datadog"
    $_.Exception | format-list -force
}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Datadog%20-%20Log%20Task&step-template=Datadog%20-%20Log%20Task)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "e8550a62-3ed7-4200-b5c7-ba91cbda5e2a",
  "Name": "Datadog - Log Task",
  "Description": "Log details of a task to Datadog, including error detail.\n\n**Configuration**: \n\n* In Datadog, add a [standard attribute](https://docs.datadoghq.com/logs/processing/attributes_naming_convention/#standard-attributes-and-aliasing) of `octopus.deployment.properties` to see and access JSON details of the task.  \n\n* When using the step, set the [run condition](https://octopus.com/docs/projects/steps/conditions) of the step to `Always run` to ensure logs are sent for errors as well as successful tasks.",
  "Version": 1,
  "ExportedAt": "2021-03-04T11:25:36.400Z",
  "ActionType": "Octopus.Script",
  "Author": "octocrock",
  "Packages": [],
  "Parameters": [
    {
      "Id": "6a1f7310-294a-4593-898b-afc32bd93bb3",
      "Name": "DatadogUrl",
      "Label": "Datadog URL",
      "HelpText": "The URL for POSTing log information",
      "DefaultValue": "https://http-intake.logs.datadoghq.eu/v1/input",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "2eb26500-3ced-466c-962e-18b91ce6ea46",
      "Name": "DatadogAPIKey",
      "Label": "Datadog API Key",
      "HelpText": "[API Key](https://docs.datadoghq.com/account_management/api-app-keys/#api-keys) required for accessing API.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Id": "289728cb-9442-41b3-a3be-17f4e8287380",
      "Name": "DatadogApplicationKey",
      "Label": "Datadog Application Key",
      "HelpText": "Information on Datadog [Application Keys](https://docs.datadoghq.com/account_management/api-app-keys/#application-keys)",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Id": "6afbdc2a-3f85-4807-abff-d7f3e0dcba77",
      "Name": "DatadogServiceName",
      "Label": "Datadog Service Name",
      "HelpText": null,
      "DefaultValue": "Octopus Deploy",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "62b47d15-e05f-4e0b-a4b9-4a80b98b62f9",
      "Name": "DatadogOctopusAPIKey",
      "Label": "",
      "HelpText": "Only used when an exception has occurred.\n\nOctopus instance [API Key](https://octopus.com/docs/octopus-rest-api/how-to-create-an-api-key).   Requires at least `TaskView` [permission](https://octopus.com/docs/security/users-and-teams/system-and-space-permissions).",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "  \nfunction Send-DatadogEvent (\n    $datadog,\n    [string] $text,\n    [string] $level,\n    $properties = @{},\n    [string] $exception = $null,\n    [switch] $template) {\n    \n    \n    if (-not $level) {\n        $level = 'Information'\n    }\n\n    if (@('Verbose', 'Debug', 'Information', 'Warning', 'Error', 'Fatal') -notcontains $level) {\n        $level = 'Information'\n    }\n\n\n    $ddtags = \"project:$($properties.ProjectName),deploymentname:$($properties.DeploymentName),env:$($properties.EnvironmentName)\"\n    if ($properties[\"TaskType\"] -eq \"Runbook\") {\n        $ddtags += \",runbookname:$($properties.RunbookName),tasktype:runbook\"\n    }\n    else {\n        $ddtags += \",tasktype:deployment\"    \n    }\n\n    $body = New-Object \"System.Collections.Generic.Dictionary[[String],[String]]\"\n    $body.Add(\"ddsource\", \"Octopus Deploy\")\n    $body.Add(\"ddtags\", $ddtags)\n    $body.Add(\"service\", $DatadogServiceName)\n    $body.Add(\"hostname\", \"https://octopus.the-crock.com/\")\n    $body.Add(\"http.url\", \"$($properties[\"TaskLink\"])\")\n    $body.Add(\"octopus.deployment.properties\", \"$($properties | ConvertTo-Json)\")\n\n    if ($exception) {\n        $body.Add(\"error.message\", \"$($properties[\"Error\"])\")\n        $body.Add(\"error.stack\", \"$($exception)\")\n    }\n    \n    $body.Add(\"level\", \"$($level)\")\n  \n    $headers = New-Object \"System.Collections.Generic.Dictionary[[String],[String]]\"\n    $headers.Add(\"Content-Type\", \"application/json\")\n    $headers.Add(\"DD-APPLICATION-KEY\", \"$($DatadogApplicationKey)\")\n    $headers.Add(\"DD-API-KEY\", \"$($DatadogApiKey)\")\n\n    Invoke-RestMethod -Uri $DatadogUrl -Body $($body | ConvertTo-Json)  -ContentType \"application/json\" -Method POST -Headers $headers\n}\n\nfunction Set-ErrorDetails(){\n\n    $octopusAPIHeader = @{ \"X-Octopus-ApiKey\" = $DatadogOctopusAPIKey }\n    $taskDetailUri = \"$($OctopusParameters['Octopus.Web.ServerUri'])/api/tasks/$($OctopusParameters[\"Octopus.Task.Id\"])/details\"\n\n    $taskDetails = Invoke-RestMethod -Method Get -Uri $taskDetailUri -Headers $octopusAPIHeader \n    $errorMessage = \"\";\n    $errorFirstLine = \"\";\n    $isFirstLine = $true;\n\n    foreach ($activityLog in $taskDetails.ActivityLogs) {\n        foreach ($activityLogChild1 in $activityLog.Children) {\n            foreach ($activityLogChild2 in $activityLogChild1.Children) {\n                foreach ($logElement in $activityLogChild2.LogElements) {\n                    if ($logElement.Category -eq \"Error\") {\n                        if ($isFirstLine -eq $true) {\n                            $errorFirstLine = $logElement.MessageText;\n                            $isFirstLine = $false;\n                        }\n\n                        $errorMessage += $logElement.MessageText + \" `n\"\n                    }\n                }\n            }\n        }\n    }\n\n    $exInfo = @{\n        firstLine = $errorFirstLine\n        message = $errorMessage\n    }\n\n    return $exInfo;\n}\n\nfunction Set-TaskProperties(){\n    $taskProperties = @{\n        ProjectName     = $OctopusParameters['Octopus.Project.Name'];\n        Result          = \"succeeded\";\n        InstanceUrl     = $OctopusParameters['Octopus.Web.ServerUri'];\n        EnvironmentName = $OctopusParameters['Octopus.Environment.Name'];\n        DeploymentName  = $OctopusParameters['Octopus.Deployment.Name'];\n        TenantName      = $OctopusParameters[\"Octopus.Deployment.Tenant.Name\"]\n        TaskLink        = $taskLink\n    }\n    \n    if ([string]::IsNullOrEmpty($OctopusParameters[\"Octopus.Runbook.Id\"]) -eq $false) {\n        $taskProperties[\"TaskType\"] \t\t\t= \"Runbook\"\n        $taskProperties[\"RunbookSnapshotName\"] \t= $OctopusParameters[\"Octopus.RunbookSnapshot.Name\"]\n        $taskProperties[\"RunbookName\"]         \t= $OctopusParameters[\"Octopus.Runbook.Name\"]\n    }\n    else {\n        $taskProperties[\"TaskType\"] \t\t= \"Deployment\"\n        $taskProperties[\"ReleaseNumber\"] \t= $OctopusParameters['Octopus.Release.Number'];\n        $taskProperties[\"Channel\"]  \t\t= $OctopusParameters['Octopus.Release.Channel.Name'];\n    }\n\n    return $taskProperties;\n}\n\n#******************************************************************\n\n$taskLink = $OctopusParameters['Octopus.Web.ServerUri'] + \"/app#/\" + $OctopusParameters[\"Octopus.Space.Id\"] + \"/tasks/\" + $OctopusParameters[\"Octopus.Task.Id\"]\n$level = \"Information\"\n$exception = $null\n\nWrite-Output \"Logging the deployment result to Datadog at $DatadogServerUrl...\"\n\n$properties = Set-TaskProperties\n\nif ($OctopusParameters['Octopus.Deployment.Error']) {\n    $exceptionInfo = Set-ErrorDetails\n    $properties[\"Result\"] = \"failed\"\n    $properties[\"Error\"] = $exceptionInfo[\"firstLine\"]\n    $exception = $exceptionInfo[\"message\"]\n    $level = \"Error\"\n}\n\ntry {\n    Send-DatadogEvent $datadog \"A deployment of $($properties.ProjectName) release $($properties.ReleaseNumber) $($properties.Result) in $($properties.EnvironmentName)\" -level $level -template -properties $properties -exception $exception\n}\ncatch [Exception] {\n    Write-Error \"Unable to write task details to Datadog\"\n    $_.Exception | format-list -force\n}\n"
  },
  "Category": "Datadog",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/datadog-task-log.json",
  "Website": "/step-templates/e8550a62-3ed7-4200-b5c7-ba91cbda5e2a",
  "Logo": "https://i.octopus.com/library/step-templates/datadog.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/datadog-task-log.json)

</div>
