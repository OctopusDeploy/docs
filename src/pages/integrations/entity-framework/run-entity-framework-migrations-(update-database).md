---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2019-10-18
title: 'Run Entity Framework migrations (Update-Database)'
description: 'Runs `Update-Database` to update the database to the latest Entity Framework migrations'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2019-10-18 by rikrak belongs to 'Entity Framework' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Path to EF Tools folder

`EfToolsFolder`

Please provide a full path to a folder where Migrate.exe (along with other EF files are contained, available from EF nuget package) on Tentacle

</div>
        
<div class="param">

### Base Directory

`BaseDirectory = /bin`

Path to where your application files are located. For ASP.NET applications this would be `/bin`

</div>
        
<div class="param">

### Site Path

`NugetPackageStepName`

Name of the previously-deployed package step that contains the applications files

</div>
        
<div class="param">

### Config File Name

`configFileName = web.config`

Name of your applications config file. For ASP.NET applications this would be `web.config`, for Windows Service applications this would be `yourapplication.dll.config` and for console applications this would be `yourapplication.exe.config`

</div>
        
<div class="param">

### Name of Assembly file with EF-Context

`AssemblyDllName`

Please provide a name of the assembly file where EF-context is stored

</div>
        
<div class="param">

### ConnectionStringName

`ConnectionStringName`

Name of the key in <connectionStrings> section in Web.Config

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
# A collection of functions that can be used by script steps to determine where packages installed
# by previous steps are located on the filesystem.
 
function Find-InstallLocations {
    $result = @()
    $OctopusParameters.Keys | foreach {
        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {
            $result += $OctopusParameters[$_]
        }
    }
    return $result
}
 
function Find-InstallLocation($stepName) {
    $result = $OctopusParameters.Keys | where {
        $_.Equals("Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath",  [System.StringComparison]::OrdinalIgnoreCase)
    } | select -first 1
 
    if ($result) {
        return $OctopusParameters[$result]
    }
 
    throw "No install location found for step: $stepName"
}
 
function Find-SingleInstallLocation {
    $all = @(Find-InstallLocations)
    if ($all.Length -eq 1) {
        return $all[0]
    }
    if ($all.Length -eq 0) {
        throw "No package steps found"
    }
    throw "Multiple package steps have run; please specify a single step"
}

function Test-LastExit($cmd) {
    if ($LastExitCode -ne 0) {
        Write-Host "##octopus[stderr-error]"
        write-error "$cmd failed with exit code: $LastExitCode"
    }
}




$stepName = $OctopusParameters['NugetPackageStepName']

$stepPath = ""
if (-not [string]::IsNullOrEmpty($stepName)) {
    Write-Host "Finding path to package step: $stepName"
    $stepPath = Find-InstallLocation $stepName
} else {
    $stepPath = Find-SingleInstallLocation
}
Write-Host "Package was installed to: $stepPath"

$baseDirectory = $OctopusParameters['BaseDirectory']

$binPath = Join-Path $stepPath $baseDirectory

#Locate Migrate.exe
$efToolsFolder = $OctopusParameters['EfToolsFolder']
$originalMigrateExe = Join-Path $efToolsFolder "migrate.exe"

if (-Not(Test-Path $originalMigrateExe)){
    throw ("Unable to locate migrate.exe file. Specifed path $originalMigrateExe does not exist.")
}
Write-Host("Found Migrate.Exe from $originalMigrateExe")

$migrateExe = Join-Path $binPath "migrate.exe"
if (-Not(Test-Path $migrateExe)) {
    # Move migrate.exe to ASP.NET Project's bin folder as per https://msdn.microsoft.com/de-de/data/jj618307.aspx?f=255&MSPPError=-2147217396
    Copy-Item $originalMigrateExe -Destination $binPath
    Write-Host("Copied $originalMigrateExe into $binPath")
}

#Locate Assembly with DbContext class
$contextDllName = $OctopusParameters['AssemblyDllName']
$contextDllPath = Join-Path $binPath $contextDllName
if (-Not(Test-Path $contextDllPath)){
    throw ("Unable to locate assembly file with DbContext class. Specifed path $contextDllPath does not exist.")
}
Write-Host("Using $contextDllName from $contextDllPath")

#Locate web.config. Migrate.exe needs it for some reason, even if connection string is provided
$configFile = $OctopusParameters['ConfigFileName']
$configPath = Join-Path $stepPath $configFile
if (-Not(Test-Path $configPath)){
    throw ("Unable to locate config file. Specifed path $webConfigPath does not exist.")
}

$connectionStringName = $OctopusParameters['ConnectionStringName']

$migrateCommand = "& ""$migrateExe"" ""$contextDllName"" /connectionStringName=""$connectionStringName"" /startupConfigurationFile=""$configPath"" /startUpDirectory=""$binPath"" /Verbose"

Write-Host "##octopus[stderr-error]"        # Stderr is an error
Write-Host "Executing: " $migrateCommand
Write-Host 

Invoke-Expression $migrateCommand | Write-Host

# Remove migrate.exe from the bin folder as it is not part of the application
If (Test-Path $migrateExe)
{
  Write-Host "Deleting " $migrateExe
  Remove-Item $migrateExe
}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Run%20Entity%20Framework%20migrations%20(Update-Database)&step-template=Run%20Entity%20Framework%20migrations%20(Update-Database))

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "a6cd35d6-164a-4e57-a0f8-0d327129783a",
  "Name": "Run Entity Framework migrations (Update-Database)",
  "Description": "Runs `Update-Database` to update the database to the latest Entity Framework migrations",
  "Version": 6,
  "ExportedAt": "2019-10-18T09:11:34.909Z",
  "ActionType": "Octopus.Script",
  "Author": "rikrak",
  "Parameters": [
    {
      "Name": "EfToolsFolder",
      "Label": "Path to EF Tools folder",
      "HelpText": "Please provide a full path to a folder where Migrate.exe (along with other EF files are contained, available from EF nuget package) on Tentacle",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "BaseDirectory",
      "Label": "Base Directory",
      "HelpText": "Path to where your application files are located. For ASP.NET applications this would be `/bin`",
      "DefaultValue": "/bin",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "NugetPackageStepName",
      "Label": "Site Path",
      "HelpText": "Name of the previously-deployed package step that contains the applications files",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Name": "configFileName",
      "Label": "Config File Name",
      "HelpText": "Name of your applications config file. For ASP.NET applications this would be `web.config`, for Windows Service applications this would be `yourapplication.dll.config` and for console applications this would be `yourapplication.exe.config`",
      "DefaultValue": "web.config",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "AssemblyDllName",
      "Label": "Name of Assembly file with EF-Context",
      "HelpText": "Please provide a name of the assembly file where EF-context is stored",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "ConnectionStringName",
      "Label": "ConnectionStringName",
      "HelpText": "Name of the key in <connectionStrings> section in Web.Config",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "# A collection of functions that can be used by script steps to determine where packages installed\n# by previous steps are located on the filesystem.\n \nfunction Find-InstallLocations {\n    $result = @()\n    $OctopusParameters.Keys | foreach {\n        if ($_.EndsWith('].Output.Package.InstallationDirectoryPath')) {\n            $result += $OctopusParameters[$_]\n        }\n    }\n    return $result\n}\n \nfunction Find-InstallLocation($stepName) {\n    $result = $OctopusParameters.Keys | where {\n        $_.Equals(\"Octopus.Action[$stepName].Output.Package.InstallationDirectoryPath\",  [System.StringComparison]::OrdinalIgnoreCase)\n    } | select -first 1\n \n    if ($result) {\n        return $OctopusParameters[$result]\n    }\n \n    throw \"No install location found for step: $stepName\"\n}\n \nfunction Find-SingleInstallLocation {\n    $all = @(Find-InstallLocations)\n    if ($all.Length -eq 1) {\n        return $all[0]\n    }\n    if ($all.Length -eq 0) {\n        throw \"No package steps found\"\n    }\n    throw \"Multiple package steps have run; please specify a single step\"\n}\n\nfunction Test-LastExit($cmd) {\n    if ($LastExitCode -ne 0) {\n        Write-Host \"##octopus[stderr-error]\"\n        write-error \"$cmd failed with exit code: $LastExitCode\"\n    }\n}\n\n\n\n\n$stepName = $OctopusParameters['NugetPackageStepName']\n\n$stepPath = \"\"\nif (-not [string]::IsNullOrEmpty($stepName)) {\n    Write-Host \"Finding path to package step: $stepName\"\n    $stepPath = Find-InstallLocation $stepName\n} else {\n    $stepPath = Find-SingleInstallLocation\n}\nWrite-Host \"Package was installed to: $stepPath\"\n\n$baseDirectory = $OctopusParameters['BaseDirectory']\n\n$binPath = Join-Path $stepPath $baseDirectory\n\n#Locate Migrate.exe\n$efToolsFolder = $OctopusParameters['EfToolsFolder']\n$originalMigrateExe = Join-Path $efToolsFolder \"migrate.exe\"\n\nif (-Not(Test-Path $originalMigrateExe)){\n    throw (\"Unable to locate migrate.exe file. Specifed path $originalMigrateExe does not exist.\")\n}\nWrite-Host(\"Found Migrate.Exe from $originalMigrateExe\")\n\n$migrateExe = Join-Path $binPath \"migrate.exe\"\nif (-Not(Test-Path $migrateExe)) {\n    # Move migrate.exe to ASP.NET Project's bin folder as per https://msdn.microsoft.com/de-de/data/jj618307.aspx?f=255&MSPPError=-2147217396\n    Copy-Item $originalMigrateExe -Destination $binPath\n    Write-Host(\"Copied $originalMigrateExe into $binPath\")\n}\n\n#Locate Assembly with DbContext class\n$contextDllName = $OctopusParameters['AssemblyDllName']\n$contextDllPath = Join-Path $binPath $contextDllName\nif (-Not(Test-Path $contextDllPath)){\n    throw (\"Unable to locate assembly file with DbContext class. Specifed path $contextDllPath does not exist.\")\n}\nWrite-Host(\"Using $contextDllName from $contextDllPath\")\n\n#Locate web.config. Migrate.exe needs it for some reason, even if connection string is provided\n$configFile = $OctopusParameters['ConfigFileName']\n$configPath = Join-Path $stepPath $configFile\nif (-Not(Test-Path $configPath)){\n    throw (\"Unable to locate config file. Specifed path $webConfigPath does not exist.\")\n}\n\n$connectionStringName = $OctopusParameters['ConnectionStringName']\n\n$migrateCommand = \"& \"\"$migrateExe\"\" \"\"$contextDllName\"\" /connectionStringName=\"\"$connectionStringName\"\" /startupConfigurationFile=\"\"$configPath\"\" /startUpDirectory=\"\"$binPath\"\" /Verbose\"\n\nWrite-Host \"##octopus[stderr-error]\"        # Stderr is an error\nWrite-Host \"Executing: \" $migrateCommand\nWrite-Host \n\nInvoke-Expression $migrateCommand | Write-Host\n\n# Remove migrate.exe from the bin folder as it is not part of the application\nIf (Test-Path $migrateExe)\n{\n  Write-Host \"Deleting \" $migrateExe\n  Remove-Item $migrateExe\n}\n",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline"
  },
  "Category": "Entity Framework",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/run-entity-framework-migrations.json",
  "Website": "/step-templates/a6cd35d6-164a-4e57-a0f8-0d327129783a",
  "Logo": "https://i.octopus.com/library/step-templates/entityframework.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/run-entity-framework-migrations.json)

</div>
