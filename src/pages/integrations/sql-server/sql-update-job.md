---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2020-11-20
title: 'SQL - Update Job'
description: 'Updates a MS SQL server job with provided ID to be enabled or disabled'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2020-11-20 by aqovia belongs to 'SQL Server' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Job Id

`JobId = `

The SQL server job id which is a `GUID`.

</div>
        
<div class="param">

### Job name

`JobName = `

Optional job name to show on the logs instead of JobId

</div>
        
<div class="param">

### Job Status

`JobStatus = `

Choose `Enable` to enable the job, and `Disabled` to disable the job

</div>
        
<div class="param">

### ConnectionString

`ConnectionString = `

The connection string to connect to the target SQL Server

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
param(
    [string]$ConnectionString,
    [string]$JobId,
    [string]$JobName,
    [string]$JobStatus
)

$ErrorActionPreference = "Stop"

function Get-Param($Name, [switch]$Required, $Default) {
    $result = $null

    if ($OctopusParameters -ne $null) {
        $result = $OctopusParameters[$Name]
    }

    if ($result -eq $null) {
        $variable = Get-Variable $Name -EA SilentlyContinue
        if ($variable -ne $null) {
            $result = $variable.Value
        }
    }

    if ($result -eq $null) {
        if ($Required) {
            throw "Missing parameter value $Name"
        } else {
            $result = $Default
        }
    }

    return $result
}

function Execute-SqlQuery($query) {
    $queries = [System.Text.RegularExpressions.Regex]::Split($query, "^\s*GO\s*$$", [System.Text.RegularExpressions.RegexOptions]::IgnoreCase -bor [System.Text.RegularExpressions.RegexOptions]::Multiline)

    $queries | ForEach-Object {
        $q = $_
        if (!(StringIsNullOrWhitespace($q)) -and ($q.Trim().ToLowerInvariant() -ne "go")) {
            $command = $connection.CreateCommand()
            $command.CommandText = $q
            $command.ExecuteNonQuery() | Out-Null
        }
    }
}

& {
    param(
        [string]$ConnectionString,
        [string]$JobId,
        [string]$JobName,
        [string]$JobStatus
    )

    $jobStatusText = ''
    if ($JobStatus -eq '1') {
        $jobStatusText = "Enabling"
    } elseif ($JobStatus -eq '0') {
        $jobStatusText = "Disabling"
    }

    $jobDisplayName = ''
    if ($JobName) {
        $jobDisplayName = $JobName
    } else {
    	$jobDisplayName = $JobId
    }

    Write-Highlight "$jobStatusText SQL Server job: [$jobDisplayName]"
    Write-Verbose "SQL Server Job Id: [$JobId]"

    $query = @"
GO
USE [msdb]
GO
EXEC msdb.dbo.sp_update_job @job_id=N'$JobId', @enabled=$JobStatus
GO
"@

	$connection = New-Object System.Data.SqlClient.SqlConnection
    $connection.ConnectionString = $ConnectionString
    Register-ObjectEvent -inputobject $connection -eventname InfoMessage -action {
        write-host $event.SourceEventArgs
    } | Out-Null

    Write-Verbose "Connecting"
    try {
        $connection.Open()

        Write-Verbose "Executing script"
        Write-Verbose $query
        Execute-SqlQuery -query $query
    }
    catch [Exception]
    {
        Write-Verbose $_.Exception|format-list -force
        throw $_
    }
    finally {
        Write-Verbose "Closing connection"
        $connection.Dispose()
    }

  } `
   (Get-Param 'ConnectionString' -Required) `
   (Get-Param 'JobId' -Required) `
   (Get-Param 'JobName') `
   (Get-Param 'JobStatus' -Required)
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20SQL%20-%20Update%20Job&step-template=SQL%20-%20Update%20Job)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "91bbd24f-8975-4d0e-9f55-736587f945e9",
  "Name": "SQL - Update Job",
  "Description": "Updates a MS SQL server job with provided ID to be enabled or disabled",
  "Version": 1,
  "ExportedAt": "2020-11-20T12:26:07.817Z",
  "ActionType": "Octopus.Script",
  "Author": "aqovia",
  "Packages": [],
  "Parameters": [
    {
      "Id": "41a33da5-012d-4871-a3e8-983fa4a5dcbe",
      "Name": "JobId",
      "Label": "Job Id",
      "HelpText": "The SQL server job id which is a `GUID`.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "ba6bdd3b-ebfb-4c47-b214-f95044c8460e",
      "Name": "JobName",
      "Label": "Job name",
      "HelpText": "Optional job name to show on the logs instead of JobId",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "a2ea4eca-77e3-4733-9714-9fa2b87929e7",
      "Name": "JobStatus",
      "Label": "Job Status",
      "HelpText": "Choose `Enable` to enable the job, and `Disabled` to disable the job",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "0|Disabled\n1|Enabled"
      }
    },
    {
      "Id": "0bdc16b0-0086-4597-9dcd-970ddbdda258",
      "Name": "ConnectionString",
      "Label": "ConnectionString",
      "HelpText": "The connection string to connect to the target SQL Server",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "param(\n    [string]$ConnectionString,\n    [string]$JobId,\n    [string]$JobName,\n    [string]$JobStatus\n)\n\n$ErrorActionPreference = \"Stop\"\n\nfunction Get-Param($Name, [switch]$Required, $Default) {\n    $result = $null\n\n    if ($OctopusParameters -ne $null) {\n        $result = $OctopusParameters[$Name]\n    }\n\n    if ($result -eq $null) {\n        $variable = Get-Variable $Name -EA SilentlyContinue\n        if ($variable -ne $null) {\n            $result = $variable.Value\n        }\n    }\n\n    if ($result -eq $null) {\n        if ($Required) {\n            throw \"Missing parameter value $Name\"\n        } else {\n            $result = $Default\n        }\n    }\n\n    return $result\n}\n\nfunction Execute-SqlQuery($query) {\n    $queries = [System.Text.RegularExpressions.Regex]::Split($query, \"^\\s*GO\\s*$$\", [System.Text.RegularExpressions.RegexOptions]::IgnoreCase -bor [System.Text.RegularExpressions.RegexOptions]::Multiline)\n\n    $queries | ForEach-Object {\n        $q = $_\n        if (!(StringIsNullOrWhitespace($q)) -and ($q.Trim().ToLowerInvariant() -ne \"go\")) {\n            $command = $connection.CreateCommand()\n            $command.CommandText = $q\n            $command.ExecuteNonQuery() | Out-Null\n        }\n    }\n}\n\n& {\n    param(\n        [string]$ConnectionString,\n        [string]$JobId,\n        [string]$JobName,\n        [string]$JobStatus\n    )\n\n    $jobStatusText = ''\n    if ($JobStatus -eq '1') {\n        $jobStatusText = \"Enabling\"\n    } elseif ($JobStatus -eq '0') {\n        $jobStatusText = \"Disabling\"\n    }\n\n    $jobDisplayName = ''\n    if ($JobName) {\n        $jobDisplayName = $JobName\n    } else {\n    \t$jobDisplayName = $JobId\n    }\n\n    Write-Highlight \"$jobStatusText SQL Server job: [$jobDisplayName]\"\n    Write-Verbose \"SQL Server Job Id: [$JobId]\"\n\n    $query = @\"\nGO\nUSE [msdb]\nGO\nEXEC msdb.dbo.sp_update_job @job_id=N'$JobId', @enabled=$JobStatus\nGO\n\"@\n\n\t$connection = New-Object System.Data.SqlClient.SqlConnection\n    $connection.ConnectionString = $ConnectionString\n    Register-ObjectEvent -inputobject $connection -eventname InfoMessage -action {\n        write-host $event.SourceEventArgs\n    } | Out-Null\n\n    Write-Verbose \"Connecting\"\n    try {\n        $connection.Open()\n\n        Write-Verbose \"Executing script\"\n        Write-Verbose $query\n        Execute-SqlQuery -query $query\n    }\n    catch [Exception]\n    {\n        Write-Verbose $_.Exception|format-list -force\n        throw $_\n    }\n    finally {\n        Write-Verbose \"Closing connection\"\n        $connection.Dispose()\n    }\n\n  } `\n   (Get-Param 'ConnectionString' -Required) `\n   (Get-Param 'JobId' -Required) `\n   (Get-Param 'JobName') `\n   (Get-Param 'JobStatus' -Required)"
  },
  "Category": "SQL Server",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/sql-update-job.json",
  "Website": "/step-templates/91bbd24f-8975-4d0e-9f55-736587f945e9",
  "Logo": "https://i.octopus.com/library/step-templates/sql.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/sql-update-job.json)

</div>
