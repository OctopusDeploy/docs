---
layout: src/layouts/Default.astro
pubDate: 2021-05-25
title: 'SQL - Query Octopus Database for Fragmentation'
description: 'This step template will run a fragmentation query on your Octopus database and report the results of the tables.

If you would like to set this up as a scheduled runbook and get the results in an email, please follow these instructions:
1) Create a Send an Email step after this step in your process
2) Set the body type of that email to HTML, and the body to#{Octopus.Action[STEPNAMEHERE].Output.EmailData} 
3) Set the Run Condition of that Send an Email step to Variable, and the value to #{if Octopus.Action[STEPNAMEHERE].Output.Alert== "True"}True#{/if}. If you don't do this, you will receive an email regardless of if the threshold was hit.''
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2021-05-25 by millerjn21 belongs to 'SQL Server' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### SQL Server

`IndexFragmentSQLServer = `

Enter the Hostname or IP address of your server. Include \Instance if necessary.

</div>
        
<div class="param">

### SQL Server Port

`IndexFragmentSQLPort = `

If left blank, 1433 will be used by default.

</div>
        
<div class="param">

### SQL Server Database Name

`IndexFragmentDatabaseName = `

null

</div>
        
<div class="param">

### Fragmentation Threshold

`IndexFragmentFragmentation = `

Input the percentage of Fragmentation you would like to be alerted for.

</div>
        
<div class="param">

### Page Count Threshold

`IndexFragmentPageCount = `

Input the minimum page count a table must have to be considered in the results.

</div>
        
<div class="param">

### SQL Server Authentication Username

`IndexFragmentSQLUsername = `

Please leave blank if you want to use Integrated Security.

</div>
        
<div class="param">

### SQL Server Authentication Password

`IndexFragmentSQLPassword = `

Please leave blank if you want to use Integrated Security.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
###PARAMETERS

[string]$sqlUsername = $OctopusParameters["IndexFragmentSQLUsername"]
[string]$sqlPassword = $OctopusParameters["IndexFragmentSQLPassword"]
[int]$threshold = $OctopusParameters["IndexFragmentFragmentation"]
[string]$SQLServer = $OctopusParameters["IndexFragmentSQLServer"]
[string]$SQLPort = $OctopusParameters["IndexFragmentSQLPort"]
[string]$databaseName = $OctopusParameters["IndexFragmentDatabaseName"]
[string]$pageCount = $OctopusParameters["IndexFragmentPageCount"]


if ([string]::IsNullOrWhiteSpace($SQLPort)){
$SQLPort = "1433"
}

#create the full sql server string
[string]$SQLServerFull = $SQLServer + "," + $SQLPort

#creating the connectionString based on choice of auth
if ([string]::IsNullOrWhiteSpace($sqlUserName)){
	Write-Highlight "Integrated Authentication being used to connect to SQL."
    $connectionString = "Server=$SQLServerFull;Database=$databaseName;integrated security=true;"
}
else {
	Write-Highlight "SQL Authentication being used to connect to SQL"
    $connectionString = "Server=$SQLServerFull;Database=$databaseName;User ID=$sqlUsername;Password=$sqlPassword;"
}

#function for running the query
function ExecuteSqlQuery ($connectionString, $SQLQuery) {
    $Datatable = New-Object System.Data.DataTable
    $Connection = New-Object System.Data.SQLClient.SQLConnection
    $Connection.ConnectionString = $connectionString
	try{
    	$Connection.Open()
    	$Command = New-Object System.Data.SQLClient.SQLCommand
    	$Command.Connection = $Connection
    	$Command.CommandText = $SQLQuery
    	$Reader = $Command.ExecuteReader()
    	$Datatable.Load($Reader)
    }
    catch{
    	Write-Error $_.Exception.Message
    }
    finally{
    	if (($Connection.State) -ne "Closed"){
        Write-Highlight "Closing the SQL Connection."
    	$Connection.Close()   
        }
    }
    return $Datatable
}

#Create the query for fragmentation check
$query = @"
SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0
ORDER BY DDIPS.avg_fragmentation_in_percent desc
"@

#Run the query against the server and return as a dataset
$resultsDataTable = New-Object System.Data.DataTable
$resultsDataTable = ExecuteSqlQuery $connectionString $query 

#creating variables for later use
$highestFrag = 0
$array = @()

#build an array of html so the data is readable
$dataforemail = @()
$dataforemail += "<header>  <h1>SQL Fragmentation Report</h1></header><br>"
$dataforemail += '<table border="1">'
$dataforemail += "<tr> <td> Table </td><td>Index</td><td>Fragmentation %</td><td>Page Count</td></td>"
foreach ($row in $resultsDataTable){
	#checking if the current row's fragmentation % is higher than our highest if it is, set it
	if ($row.avg_fragmentation_in_percent -gt $highestFrag -and $row.page_count -gt $pageCount){
		$highestFrag = $row.avg_fragmentation_in_percent
	}
    #if both thresholds are hit, put the data in HTML format and also an array to later write to console.
	if ($row.avg_fragmentation_in_percent -gt $threshold -and $row.page_count -gt $pageCount){
        $percent = [math]::Round($row.avg_fragmentation_in_percent,2)
		$dataforemail += "<tr>" 
		$dataforemail += "<td>" + $row.Table + "</td>"
		$dataforemail += "<td>" + $row.Index + "</td>"
        $dataforemail += "<td>" + [string]$percent + "</td>"
        $dataforemail += "<td>" + $row.page_count + "</td>"
		$dataforemail += "</tr>"
        
        $arrayRow = "" | Select Table,Index,avg_fragmentation_in_percent,page_count
    	$arrayRow.Table = $Row.Table
    	$arrayRow.Index = $Row.Index
        $arrayRow.avg_fragmentation_in_percent = [string]$percent
        $arrayRow.page_count = $Row.page_count
    	$array += $arrayRow
	}
}
$dataforemail += "</table>"

#if the threshold has been reached, output data and create output variable for sending email.
if ($highestFrag -gt $threshold){

	#convert the array to a string to email
	[string]$bodyofemail = [string]$dataforemail

	#Create all of the necessary variables and output the data
		Set-OctopusVariable -name "EmailData" -value "$dataforemail"
        Set-OctopusVariable -name "Alert" -value "True"
        $output = $array | Out-String
        Write-Highlight 'Here are the results for your database fragmentation. The following tables had above the provided fragmentation % and minimum page count. If you would like to get an email alert with the data, please refer to the description of the step template for instructions on setting that up.'
        Write-Highlight $output
}
else{

	Write-Highlight "No alert is required."
    Set-OctopusVariable -name "Alert" -value "False"


}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20SQL%20-%20Query%20Octopus%20Database%20for%20Fragmentation&step-template=SQL%20-%20Query%20Octopus%20Database%20for%20Fragmentation)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "b362bd69-4a69-42c1-bcb5-2a134549ef3f",
  "Name": "SQL - Query Octopus Database for Fragmentation",
  "Description": "This step template will run a fragmentation query on your Octopus database and report the results of the tables.\n\nIf you would like to set this up as a scheduled runbook and get the results in an email, please follow these instructions:\n1) Create a Send an Email step after this step in your process\n2) Set the body type of that email to HTML, and the body to#{Octopus.Action[STEPNAMEHERE].Output.EmailData} \n3) Set the Run Condition of that Send an Email step to Variable, and the value to #{if Octopus.Action[STEPNAMEHERE].Output.Alert== \"True\"}True#{/if}. If you don't do this, you will receive an email regardless of if the threshold was hit.'",
  "Version": 1,
  "ExportedAt": "2021-05-25T19:02:40.382Z",
  "ActionType": "Octopus.Script",
  "Author": "millerjn21",
  "Packages": [],
  "Parameters": [
    {
      "Id": "05a6a3f3-3cb9-4d75-abac-b2125fb84a3b",
      "Name": "IndexFragmentSQLServer",
      "Label": "SQL Server",
      "HelpText": "Enter the Hostname or IP address of your server. Include \\Instance if necessary.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "8d6081b3-b934-475b-8b73-cde72f5d085d",
      "Name": "IndexFragmentSQLPort",
      "Label": "SQL Server Port",
      "HelpText": "If left blank, 1433 will be used by default.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "42671f3c-763e-4dbd-836d-ed794d4b0005",
      "Name": "IndexFragmentDatabaseName",
      "Label": "SQL Server Database Name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "0e439749-1fa9-40f2-9843-126ade5576b1",
      "Name": "IndexFragmentFragmentation",
      "Label": "Fragmentation Threshold",
      "HelpText": "Input the percentage of Fragmentation you would like to be alerted for.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "7050d208-a267-412a-9677-95e90909264c",
      "Name": "IndexFragmentPageCount",
      "Label": "Page Count Threshold",
      "HelpText": "Input the minimum page count a table must have to be considered in the results.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "4a9d3846-c454-483f-9066-60a1f2cf7413",
      "Name": "IndexFragmentSQLUsername",
      "Label": "SQL Server Authentication Username",
      "HelpText": "Please leave blank if you want to use Integrated Security.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "f04df930-bb05-49c1-b6f0-51e97dce3bad",
      "Name": "IndexFragmentSQLPassword",
      "Label": "SQL Server Authentication Password",
      "HelpText": "Please leave blank if you want to use Integrated Security.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "###PARAMETERS\n\n[string]$sqlUsername = $OctopusParameters[\"IndexFragmentSQLUsername\"]\n[string]$sqlPassword = $OctopusParameters[\"IndexFragmentSQLPassword\"]\n[int]$threshold = $OctopusParameters[\"IndexFragmentFragmentation\"]\n[string]$SQLServer = $OctopusParameters[\"IndexFragmentSQLServer\"]\n[string]$SQLPort = $OctopusParameters[\"IndexFragmentSQLPort\"]\n[string]$databaseName = $OctopusParameters[\"IndexFragmentDatabaseName\"]\n[string]$pageCount = $OctopusParameters[\"IndexFragmentPageCount\"]\n\n\nif ([string]::IsNullOrWhiteSpace($SQLPort)){\n$SQLPort = \"1433\"\n}\n\n#create the full sql server string\n[string]$SQLServerFull = $SQLServer + \",\" + $SQLPort\n\n#creating the connectionString based on choice of auth\nif ([string]::IsNullOrWhiteSpace($sqlUserName)){\n\tWrite-Highlight \"Integrated Authentication being used to connect to SQL.\"\n    $connectionString = \"Server=$SQLServerFull;Database=$databaseName;integrated security=true;\"\n}\nelse {\n\tWrite-Highlight \"SQL Authentication being used to connect to SQL\"\n    $connectionString = \"Server=$SQLServerFull;Database=$databaseName;User ID=$sqlUsername;Password=$sqlPassword;\"\n}\n\n#function for running the query\nfunction ExecuteSqlQuery ($connectionString, $SQLQuery) {\n    $Datatable = New-Object System.Data.DataTable\n    $Connection = New-Object System.Data.SQLClient.SQLConnection\n    $Connection.ConnectionString = $connectionString\n\ttry{\n    \t$Connection.Open()\n    \t$Command = New-Object System.Data.SQLClient.SQLCommand\n    \t$Command.Connection = $Connection\n    \t$Command.CommandText = $SQLQuery\n    \t$Reader = $Command.ExecuteReader()\n    \t$Datatable.Load($Reader)\n    }\n    catch{\n    \tWrite-Error $_.Exception.Message\n    }\n    finally{\n    \tif (($Connection.State) -ne \"Closed\"){\n        Write-Highlight \"Closing the SQL Connection.\"\n    \t$Connection.Close()   \n        }\n    }\n    return $Datatable\n}\n\n#Create the query for fragmentation check\n$query = @\"\nSELECT S.name as 'Schema',\nT.name as 'Table',\nI.name as 'Index',\nDDIPS.avg_fragmentation_in_percent,\nDDIPS.page_count\nFROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS\nINNER JOIN sys.tables T on T.object_id = DDIPS.object_id\nINNER JOIN sys.schemas S on T.schema_id = S.schema_id\nINNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id\nAND DDIPS.index_id = I.index_id\nWHERE DDIPS.database_id = DB_ID()\nand I.name is not null\nAND DDIPS.avg_fragmentation_in_percent > 0\nORDER BY DDIPS.avg_fragmentation_in_percent desc\n\"@\n\n#Run the query against the server and return as a dataset\n$resultsDataTable = New-Object System.Data.DataTable\n$resultsDataTable = ExecuteSqlQuery $connectionString $query \n\n#creating variables for later use\n$highestFrag = 0\n$array = @()\n\n#build an array of html so the data is readable\n$dataforemail = @()\n$dataforemail += \"<header>  <h1>SQL Fragmentation Report</h1></header><br>\"\n$dataforemail += '<table border=\"1\">'\n$dataforemail += \"<tr> <td> Table </td><td>Index</td><td>Fragmentation %</td><td>Page Count</td></td>\"\nforeach ($row in $resultsDataTable){\n\t#checking if the current row's fragmentation % is higher than our highest if it is, set it\n\tif ($row.avg_fragmentation_in_percent -gt $highestFrag -and $row.page_count -gt $pageCount){\n\t\t$highestFrag = $row.avg_fragmentation_in_percent\n\t}\n    #if both thresholds are hit, put the data in HTML format and also an array to later write to console.\n\tif ($row.avg_fragmentation_in_percent -gt $threshold -and $row.page_count -gt $pageCount){\n        $percent = [math]::Round($row.avg_fragmentation_in_percent,2)\n\t\t$dataforemail += \"<tr>\" \n\t\t$dataforemail += \"<td>\" + $row.Table + \"</td>\"\n\t\t$dataforemail += \"<td>\" + $row.Index + \"</td>\"\n        $dataforemail += \"<td>\" + [string]$percent + \"</td>\"\n        $dataforemail += \"<td>\" + $row.page_count + \"</td>\"\n\t\t$dataforemail += \"</tr>\"\n        \n        $arrayRow = \"\" | Select Table,Index,avg_fragmentation_in_percent,page_count\n    \t$arrayRow.Table = $Row.Table\n    \t$arrayRow.Index = $Row.Index\n        $arrayRow.avg_fragmentation_in_percent = [string]$percent\n        $arrayRow.page_count = $Row.page_count\n    \t$array += $arrayRow\n\t}\n}\n$dataforemail += \"</table>\"\n\n#if the threshold has been reached, output data and create output variable for sending email.\nif ($highestFrag -gt $threshold){\n\n\t#convert the array to a string to email\n\t[string]$bodyofemail = [string]$dataforemail\n\n\t#Create all of the necessary variables and output the data\n\t\tSet-OctopusVariable -name \"EmailData\" -value \"$dataforemail\"\n        Set-OctopusVariable -name \"Alert\" -value \"True\"\n        $output = $array | Out-String\n        Write-Highlight 'Here are the results for your database fragmentation. The following tables had above the provided fragmentation % and minimum page count. If you would like to get an email alert with the data, please refer to the description of the step template for instructions on setting that up.'\n        Write-Highlight $output\n}\nelse{\n\n\tWrite-Highlight \"No alert is required.\"\n    Set-OctopusVariable -name \"Alert\" -value \"False\"\n\n\n}\n"
  },
  "Category": "SQL Server",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/SQL-Query-Octopus-Database-for-Fragmentation.json",
  "Website": "/step-templates/b362bd69-4a69-42c1-bcb5-2a134549ef3f",
  "Logo": "https://i.octopus.com/library/step-templates/sql.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/SQL-Query-Octopus-Database-for-Fragmentation.json)

</div>
