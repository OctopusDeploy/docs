---
layout: src/layouts/Default.astro
pubDate: 2020-08-10
title: 'Snowchange - Deploy Scripts'
description: '[Snowchange](https://github.com/jamesweakley/snowchange#overview) is a Python script that applies migration scripts to [Snowflake](https://www.snowflake.com/) systems.

**Dependencies:**
This step is a PowerShell script which requires Python (and pip) to run.
For the scripts package, ensure scripts follow the [naming convention](https://github.com/jamesweakley/snowchange#script-naming) presribed by SnowChange, which uses the Flyway naming convention.

**Activities:**
* Uses pip to update itself and install `wheel` and `snowflake-connector-python`.
* If a path to Snowchange.py is not provided, retrieves the latest version of the file from Github.
* Generates a process-level environment variable, `SNOWSQL_PWD`, which Snowchange requires in order to function.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2020-08-10 by apfinger belongs to 'Snowflake' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Scripts Package

`SnowChangeDeploySnowflakeScriptsPackage = `

The deployment package that contains the scripts to implement.

</div>
        
<div class="param">

### Path to Snowchange

`SnowChangeDeployPath = `

_Optional:_ Provide an absolute path to an installed copy of snowchange.py. If left blank, the latest version will be downloaded from Github.

</div>
        
<div class="param">

### Snowflake Account

`SnowChangeDeploySnowflakeAccountName = `

This is the prefix to the Snowflake Url e.g. `contoso` and not `contoso.us-east-1.snowflake...`

</div>
        
<div class="param">

### Snowflake Region

`SnowChangeDeploySnowflakeRegion = `

The cloud region of the Snowflake account. e.g. `us-east-1`

</div>
        
<div class="param">

### Warehouse

`SnowChangeDeploySnowflakeWarehouse = `

The Snowflake warehouse that will receive the changes from the script.

</div>
        
<div class="param">

### Database Name

`SnowChangeDeploySnowflakeDatabaseName = `

_Optional:_ Database name is used to contain the metadata changes within the database. If none is provided, a default `METADATA`
 database is created at the top level.

</div>
        
<div class="param">

### Role

`SnowChangeDeploySnowflakeDeploymentRole = `

The role used by the user to execute the scripts.

</div>
        
<div class="param">

### Snowflake Deployment User Name

`SnowChangeDeploySnowflakeDeploymentUser = `

The username Snowchange will use to run the scripts.

</div>
        
<div class="param">

### Snowflake Deployment User Password

`SnowChangeDeploySNOWSQL_PWD = `

The script will create a process-level environment variable SNOWSQL_PWD, which Snowchange uses for authenticating to Snowflake.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
function Get-Param($Name, [switch]$Required, $Default) {
    $result = $null

    if ($OctopusParameters -ne $null) {
        $result = $OctopusParameters[$Name]
    }

    if ($result -eq $null) {
        $variable = Get-Variable $Name -EA SilentlyContinue
        if ($variable -ne $null) {
            $result = $variable.Value
        }
    }

    if ($result -eq $null) {
        if ($Required) {
            throw "Missing parameter value $Name"
        } else {
            $result = $Default
        }
    }

    return $result
}

& {
	param(
    	[string]$SnowChangeDeploySnowflakeDatabaseName,
    	[string]$SnowChangeDeploySnowflakeWarehouse,
        [string]$SnowChangeDeploySnowflakeDeploymentRole,
        [string]$SnowChangeDeploySnowflakeDeploymentUser,
        [string]$SnowChangeDeploySnowflakeRegion,
        [string]$SnowChangeDeploySnowflakeAccountName,
        [string]$SnowChangeDeploySNOWSQL_PWD,
        [string]$SnowChangeDeployPath
      )

	python --version

# Acquire snowchange.py dependencies
	python.exe -m pip install --upgrade pip
	pip install --upgrade wheel
	pip install --upgrade snowflake-connector-python

# Identify or acquire path to snowchange.py

	if (!$SnowChangeDeployPath) {
      Write-Host "Snowchange path not provided. Downloading from Github."

      $wc = New-Object System.Net.WebClient
      $wc.Encoding = [System.Text.Encoding]::UTF8

      $targetFolder = Join-Path $Env:OctopusCalamariWorkingDirectory 'snowchange'
      $file = "snowchange.py"
      $targetPath = Join-Path $targetFolder $file
      $url = "https://raw.githubusercontent.com/jamesweakley/snowchange/master/$file"

      Write-Host -Message "Attempting to create $targetFolder"
      New-Item -ItemType "directory" -Path "$targetFolder"                
      Write-Host -Message "Attempting to download from $url"
      $wc.DownloadFile("$url", "$targetPath")

		$SnowChangeDeployPath = $targetPath
	}

# Identify path to Scripts for snowchange.py to execute

	$scriptsPath = $OctopusParameters["Octopus.Action.Package[SnowChangeDeploySnowflakeScriptsPackage].ExtractedPath"]

# Set Process-level Environment variable for SNOWSQL_PWD

	$pword = "$SnowChangeDeploySNOWSQL_PWD"
	Set-Item -Path Env:SNOWSQL_PWD -Value $pword

# If a DB was specified, generate the metadata table name

	if ($SnowChangeDeploySnowflakeDatabaseName) {
    	$metadataTable = "$SnowChangeDeploySnowflakeDatabaseName",".SNOWCHANGE.CHANGE_HISTORY" -Join ""
    }

# Invoke snowchange.py

	if ($metadataTable) {
      python $SnowChangeDeployPath `
      -f "$scriptsPath" `
      -a "$SnowChangeDeploySnowflakeAccountName" `
      --snowflake-region "$SnowChangeDeploySnowflakeRegion" `
      -u "$SnowChangeDeploySnowflakeDeploymentUser" `
      -r "$SnowChangeDeploySnowflakeDeploymentRole" `
      -w "$SnowChangeDeploySnowflakeWarehouse" `
      -c "$metadataTable"
    } else {
      python $SnowChangeDeployPath `
      -f "$scriptsPath" `
      -a "$SnowChangeDeploySnowflakeAccountName" `
      --snowflake-region "$SnowChangeDeploySnowflakeRegion" `
      -u "$SnowChangeDeploySnowflakeDeploymentUser" `
      -r "$SnowChangeDeploySnowflakeDeploymentRole" `
      -w "$SnowChangeDeploySnowflakeWarehouse"    
    }
} `
(Get-Param 'SnowChangeDeploySnowflakeDatabaseName') `
(Get-Param 'SnowChangeDeploySnowflakeWarehouse' -Required) `
(Get-Param 'SnowChangeDeploySnowflakeDeploymentRole' -Required) `
(Get-Param 'SnowChangeDeploySnowflakeDeploymentUser' -Required) `
(Get-Param 'SnowChangeDeploySnowflakeRegion' -Required) `
(Get-Param 'SnowChangeDeploySnowflakeAccountName' -Required) `
(Get-Param 'SnowChangeDeploySNOWSQL_PWD' -Required) `
(Get-Param 'SnowChangeDeployPath')

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Snowchange%20-%20Deploy%20Scripts&step-template=Snowchange%20-%20Deploy%20Scripts)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "83d55334-d68e-4062-a84a-810eea445236",
  "Name": "Snowchange - Deploy Scripts",
  "Description": "[Snowchange](https://github.com/jamesweakley/snowchange#overview) is a Python script that applies migration scripts to [Snowflake](https://www.snowflake.com/) systems.\n\n**Dependencies:**\nThis step is a PowerShell script which requires Python (and pip) to run.\nFor the scripts package, ensure scripts follow the [naming convention](https://github.com/jamesweakley/snowchange#script-naming) presribed by SnowChange, which uses the Flyway naming convention.\n\n**Activities:**\n* Uses pip to update itself and install `wheel` and `snowflake-connector-python`.\n* If a path to Snowchange.py is not provided, retrieves the latest version of the file from Github.\n* Generates a process-level environment variable, `SNOWSQL_PWD`, which Snowchange requires in order to function.",
  "Version": 2,
  "ExportedAt": "2020-08-10T15:44:23.481Z",
  "ActionType": "Octopus.Script",
  "Author": "apfinger",
  "Packages": [
    {
      "Id": "4d8e376e-2736-4b9d-bae5-074c07748e85",
      "Name": "SnowChangeDeploySnowflakeScriptsPackage",
      "PackageId": null,
      "FeedId": null,
      "AcquisitionLocation": "Server",
      "Properties": {
        "Extract": "True",
        "SelectionMode": "deferred",
        "PackageParameterName": "SnowChangeDeploySnowflakeScriptsPackage"
      }
    }
  ],
  "Parameters": [
    {
      "Id": "4f9e0178-8c8d-4603-b88f-5159e21d2e1f",
      "Name": "SnowChangeDeploySnowflakeScriptsPackage",
      "Label": "Scripts Package",
      "HelpText": "The deployment package that contains the scripts to implement.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Package"
      }
    },
    {
      "Id": "a7dd8952-f09d-4088-b659-d84aca3590f9",
      "Name": "SnowChangeDeployPath",
      "Label": "Path to Snowchange",
      "HelpText": "_Optional:_ Provide an absolute path to an installed copy of snowchange.py. If left blank, the latest version will be downloaded from Github.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "70beb1b0-d737-4fc4-8712-2d8ad8bd9d66",
      "Name": "SnowChangeDeploySnowflakeAccountName",
      "Label": "Snowflake Account",
      "HelpText": "This is the prefix to the Snowflake Url e.g. `contoso` and not `contoso.us-east-1.snowflake...`",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "5f959b70-5be6-4ad1-ac9b-1390b8a706e9",
      "Name": "SnowChangeDeploySnowflakeRegion",
      "Label": "Snowflake Region",
      "HelpText": "The cloud region of the Snowflake account. e.g. `us-east-1`",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "73c860ec-25d1-4775-93a9-68480c2e7ebf",
      "Name": "SnowChangeDeploySnowflakeWarehouse",
      "Label": "Warehouse",
      "HelpText": "The Snowflake warehouse that will receive the changes from the script.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "f09080f6-4990-4553-9893-a0455567c56e",
      "Name": "SnowChangeDeploySnowflakeDatabaseName",
      "Label": "Database Name",
      "HelpText": "_Optional:_ Database name is used to contain the metadata changes within the database. If none is provided, a default `METADATA`\n database is created at the top level.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "55db8635-2aa6-41c9-991c-75ce8fa8b9ed",
      "Name": "SnowChangeDeploySnowflakeDeploymentRole",
      "Label": "Role",
      "HelpText": "The role used by the user to execute the scripts.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "87385639-099f-4758-adbc-127ccb7774c9",
      "Name": "SnowChangeDeploySnowflakeDeploymentUser",
      "Label": "Snowflake Deployment User Name",
      "HelpText": "The username Snowchange will use to run the scripts.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "9debfcd7-e85e-48c6-ae90-2428d76ce13e",
      "Name": "SnowChangeDeploySNOWSQL_PWD",
      "Label": "Snowflake Deployment User Password",
      "HelpText": "The script will create a process-level environment variable SNOWSQL_PWD, which Snowchange uses for authenticating to Snowflake.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "function Get-Param($Name, [switch]$Required, $Default) {\n    $result = $null\n\n    if ($OctopusParameters -ne $null) {\n        $result = $OctopusParameters[$Name]\n    }\n\n    if ($result -eq $null) {\n        $variable = Get-Variable $Name -EA SilentlyContinue\n        if ($variable -ne $null) {\n            $result = $variable.Value\n        }\n    }\n\n    if ($result -eq $null) {\n        if ($Required) {\n            throw \"Missing parameter value $Name\"\n        } else {\n            $result = $Default\n        }\n    }\n\n    return $result\n}\n\n& {\n\tparam(\n    \t[string]$SnowChangeDeploySnowflakeDatabaseName,\n    \t[string]$SnowChangeDeploySnowflakeWarehouse,\n        [string]$SnowChangeDeploySnowflakeDeploymentRole,\n        [string]$SnowChangeDeploySnowflakeDeploymentUser,\n        [string]$SnowChangeDeploySnowflakeRegion,\n        [string]$SnowChangeDeploySnowflakeAccountName,\n        [string]$SnowChangeDeploySNOWSQL_PWD,\n        [string]$SnowChangeDeployPath\n      )\n\n\tpython --version\n\n# Acquire snowchange.py dependencies\n\tpython.exe -m pip install --upgrade pip\n\tpip install --upgrade wheel\n\tpip install --upgrade snowflake-connector-python\n\n# Identify or acquire path to snowchange.py\n\n\tif (!$SnowChangeDeployPath) {\n      Write-Host \"Snowchange path not provided. Downloading from Github.\"\n\n      $wc = New-Object System.Net.WebClient\n      $wc.Encoding = [System.Text.Encoding]::UTF8\n\n      $targetFolder = Join-Path $Env:OctopusCalamariWorkingDirectory 'snowchange'\n      $file = \"snowchange.py\"\n      $targetPath = Join-Path $targetFolder $file\n      $url = \"https://raw.githubusercontent.com/jamesweakley/snowchange/master/$file\"\n\n      Write-Host -Message \"Attempting to create $targetFolder\"\n      New-Item -ItemType \"directory\" -Path \"$targetFolder\"                \n      Write-Host -Message \"Attempting to download from $url\"\n      $wc.DownloadFile(\"$url\", \"$targetPath\")\n\n\t\t$SnowChangeDeployPath = $targetPath\n\t}\n\n# Identify path to Scripts for snowchange.py to execute\n\n\t$scriptsPath = $OctopusParameters[\"Octopus.Action.Package[SnowChangeDeploySnowflakeScriptsPackage].ExtractedPath\"]\n\n# Set Process-level Environment variable for SNOWSQL_PWD\n\n\t$pword = \"$SnowChangeDeploySNOWSQL_PWD\"\n\tSet-Item -Path Env:SNOWSQL_PWD -Value $pword\n\n# If a DB was specified, generate the metadata table name\n\n\tif ($SnowChangeDeploySnowflakeDatabaseName) {\n    \t$metadataTable = \"$SnowChangeDeploySnowflakeDatabaseName\",\".SNOWCHANGE.CHANGE_HISTORY\" -Join \"\"\n    }\n\n# Invoke snowchange.py\n\n\tif ($metadataTable) {\n      python $SnowChangeDeployPath `\n      -f \"$scriptsPath\" `\n      -a \"$SnowChangeDeploySnowflakeAccountName\" `\n      --snowflake-region \"$SnowChangeDeploySnowflakeRegion\" `\n      -u \"$SnowChangeDeploySnowflakeDeploymentUser\" `\n      -r \"$SnowChangeDeploySnowflakeDeploymentRole\" `\n      -w \"$SnowChangeDeploySnowflakeWarehouse\" `\n      -c \"$metadataTable\"\n    } else {\n      python $SnowChangeDeployPath `\n      -f \"$scriptsPath\" `\n      -a \"$SnowChangeDeploySnowflakeAccountName\" `\n      --snowflake-region \"$SnowChangeDeploySnowflakeRegion\" `\n      -u \"$SnowChangeDeploySnowflakeDeploymentUser\" `\n      -r \"$SnowChangeDeploySnowflakeDeploymentRole\" `\n      -w \"$SnowChangeDeploySnowflakeWarehouse\"    \n    }\n} `\n(Get-Param 'SnowChangeDeploySnowflakeDatabaseName') `\n(Get-Param 'SnowChangeDeploySnowflakeWarehouse' -Required) `\n(Get-Param 'SnowChangeDeploySnowflakeDeploymentRole' -Required) `\n(Get-Param 'SnowChangeDeploySnowflakeDeploymentUser' -Required) `\n(Get-Param 'SnowChangeDeploySnowflakeRegion' -Required) `\n(Get-Param 'SnowChangeDeploySnowflakeAccountName' -Required) `\n(Get-Param 'SnowChangeDeploySNOWSQL_PWD' -Required) `\n(Get-Param 'SnowChangeDeployPath')\n"
  },
  "Category": "Snowflake",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/snowchange-deploy-scripts.json",
  "Website": "/step-templates/83d55334-d68e-4062-a84a-810eea445236",
  "Logo": "https://i.octopus.com/library/step-templates/snowflake.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/snowchange-deploy-scripts.json)

</div>
