---
layout: src/layouts/Default.astro
pubDate: 2016-12-16
title: 'F5 API Enable, Disable and Force Offline pool member'
description: 'Enable, Disable and to Force Offline F5 pool member via API.
This step not require iControl snap-in installed.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2016-12-16 by fedelemattia belongs to 'F5' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Node Member Pool

`node`

null

</div>
        
<div class="param">

### Pool Name

`pool`

null

</div>
        
<div class="param">

### F5 Username

`f5user`

null

</div>
        
<div class="param">

### F5 password

`f5pass`

null

</div>
        
<div class="param">

### F5 Server

`f5ipv4`

comma separated (without spaces).

</div>
        
<div class="param">

### Connections limit

`numconn = 10`

null

</div>
        
<div class="param">

### Timeout limit

`timeout = 60`

null

</div>
        
<div class="param">

### Action member node

`action`

Change the status of member pool:
- Enabled;
- Disabled;
- Forced Offline.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
#octopus variables
$node = "#{node}"
$pool = "#{pool}"
$f5pass = "#{f5pass}"
$f5user = "#{f5user}"
$f5ipv4 = "#{f5ipv4}"
$numconn = "#{numconn}"
$timeout = "#{timeout}"
$action= "#{action}"
$f5_ip=$f5ipv4.split(',')

#whitout ssl certificate
if (-not ([System.Management.Automation.PSTypeName]'ServerCertificateValidationCallback').Type)
{
$certCallback=@"
    using System;
    using System.Net;
    using System.Net.Security;
    using System.Security.Cryptography.X509Certificates;
    public class ServerCertificateValidationCallback
    {
        public static void Ignore()
        {
            if(ServicePointManager.ServerCertificateValidationCallback ==null)
            {
                ServicePointManager.ServerCertificateValidationCallback += 
                    delegate
                    (
                        Object obj, 
                        X509Certificate certificate, 
                        X509Chain chain, 
                        SslPolicyErrors errors
                    )
                    {
                        return true;
                    };
            }
        }
    }
"@
    Add-Type $certCallback
 }
[ServerCertificateValidationCallback]::Ignore();

#F5 Credentials
$username= $f5user
$password= $f5pass | ConvertTo-SecureString -AsPlainText -Force
$cred= New-Object System.Management.Automation.PSCredential $username, $password
Write-Output "Cred: $cred"

#retrieve Active F5 server
function Get-StatusF5{
    param(
        $ipserver,
        $credential
    )
    $result=Invoke-WebRequest -Uri "https://$ipserver/mgmt/tm/cm/failover-status" -Credential $credential -ErrorAction Ignore -UseBasicParsing
    $items=$result.Content | ConvertFrom-Json
    $status=$items.entries.'https://localhost/mgmt/tm/cm/failover-status/0'.nestedStats.entries.status
    return $status
}

foreach($ipv4 in $f5_ip){
    $state=Get-StatusF5 -ipserver $ipv4 -credential $cred
    if (($state.description) -like "ACTIVE"){
        $master=$ipv4
        Write-Output "F5 master ACTIVE: $master"
    }
    else{
        Write-Output "$ipv4 is not master active"
    }
}
if (!$master){
    Write-Error "ATTENTION - F5 servers are incorrect"
}

#retrieve informations
$result=Invoke-WebRequest -Uri "https://$master/mgmt/tm/ltm/pool/$pool/members" -Credential $cred -UseBasicParsing
$items=$result.Content | ConvertFrom-Json
$items.items
$name=($items.items | where{$_.name -like "*$node*"}).name
Write-Host "Nome del nodo: $name"

#action based on $action
if($action -like "Enable"){
    $state ='{"state": "user-up", "session": "user-enabled"}' ###ENABLED
    Write-Output "Action: Enable $name"
    Invoke-WebRequest -Uri "https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing
}
else{
    if($action -like "Disable"){
        $state ='{"state": "user-up", "session": "user-disabled"}' ###Disabled
        Write-Output "Action: Enable $name"
        Invoke-WebRequest -Uri "https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing
    }
    else{
        if($action -like "Offline"){
            $state ='{"state": "user-down", "session": "user-disabled"}' ###FORCEDOFFLINE
            Invoke-WebRequest -Uri "https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing
            $current_conn=$numconn + 00

            [int]$time = 0
            Write-Output "Connections accepted: $numconn"
            while($current_conn -gt $numconn){
                if($second -ne $timeout){
                    $url="https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name" + '/stats?$select=serverside.curConns'
                    Start-Sleep 1
                    [int]$second = $time++
                    $result= Invoke-WebRequest -Uri $url -Credential $cred -UseBasicParsing
                    $item=$result.Content | ConvertFrom-Json
                    $current_conn=($item.entries.'serverside.curConns').value
                    Write-Host "Second: $second - Connections: $current_conn"
                }
                else{
                    Write-Output "Timeout - $current_conn connections stopped"
                    $current_conn= 0
                }
            }
    }
        else{
            Write-Error "ACTION IS NOT ACCEPTED"
        }
}
}
Start-sleep 10
Write-Host "Go to next step"

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20F5%20API%20Enable%2C%20Disable%20and%20Force%20Offline%20pool%20member&step-template=F5%20API%20Enable%2C%20Disable%20and%20Force%20Offline%20pool%20member)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "45d3003a-9443-42a0-aa71-38398eb4f9d6",
  "Name": "F5 API Enable, Disable and Force Offline pool member",
  "Description": "Enable, Disable and to Force Offline F5 pool member via API.\nThis step not require iControl snap-in installed.",
  "Version": 2,
  "ExportedAt": "2016-12-16T14:01:28.267Z",
  "ActionType": "Octopus.Script",
  "Author": "fedelemattia",
  "Parameters": [
    {
      "Id": "c011969a-80e9-47d1-8bd3-d3da6a41ec34",
      "Name": "node",
      "Label": "Node Member Pool",
      "HelpText": null,
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "313cf4d5-1006-4e54-9f4a-e4f719ca7988",
      "Name": "pool",
      "Label": "Pool Name",
      "HelpText": null,
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "9619ce36-f913-4fa9-91be-9ac650e0d168",
      "Name": "f5user",
      "Label": "F5 Username",
      "HelpText": null,
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "6374f90c-ca46-4c13-94df-bb374c9b33f9",
      "Name": "f5pass",
      "Label": "F5 password",
      "HelpText": null,
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      },
      "Links": {}
    },
    {
      "Id": "e6402134-71af-4b31-b6a4-f2112edb7e25",
      "Name": "f5ipv4",
      "Label": "F5 Server",
      "HelpText": "comma separated (without spaces).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "1f402f2b-5907-44ec-87f0-d74bb1901dbd",
      "Name": "numconn",
      "Label": "Connections limit",
      "HelpText": null,
      "DefaultValue": "10",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "6b419071-5710-4c47-a1e5-da8434ba190a",
      "Name": "timeout",
      "Label": "Timeout limit",
      "HelpText": null,
      "DefaultValue": "60",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "e85c607e-3511-4ae9-8f90-272964fd080f",
      "Name": "action",
      "Label": "Action member node",
      "HelpText": "Change the status of member pool:\n- Enabled;\n- Disabled;\n- Forced Offline.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "Enable|Member Enabled in GUI\nDisable|Member Disabled in GUI\nOffline|Member Forced Offline in GUI"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptBody": "#octopus variables\n$node = \"#{node}\"\n$pool = \"#{pool}\"\n$f5pass = \"#{f5pass}\"\n$f5user = \"#{f5user}\"\n$f5ipv4 = \"#{f5ipv4}\"\n$numconn = \"#{numconn}\"\n$timeout = \"#{timeout}\"\n$action= \"#{action}\"\n$f5_ip=$f5ipv4.split(',')\n\n#whitout ssl certificate\nif (-not ([System.Management.Automation.PSTypeName]'ServerCertificateValidationCallback').Type)\n{\n$certCallback=@\"\n    using System;\n    using System.Net;\n    using System.Net.Security;\n    using System.Security.Cryptography.X509Certificates;\n    public class ServerCertificateValidationCallback\n    {\n        public static void Ignore()\n        {\n            if(ServicePointManager.ServerCertificateValidationCallback ==null)\n            {\n                ServicePointManager.ServerCertificateValidationCallback += \n                    delegate\n                    (\n                        Object obj, \n                        X509Certificate certificate, \n                        X509Chain chain, \n                        SslPolicyErrors errors\n                    )\n                    {\n                        return true;\n                    };\n            }\n        }\n    }\n\"@\n    Add-Type $certCallback\n }\n[ServerCertificateValidationCallback]::Ignore();\n\n#F5 Credentials\n$username= $f5user\n$password= $f5pass | ConvertTo-SecureString -AsPlainText -Force\n$cred= New-Object System.Management.Automation.PSCredential $username, $password\nWrite-Output \"Cred: $cred\"\n\n#retrieve Active F5 server\nfunction Get-StatusF5{\n    param(\n        $ipserver,\n        $credential\n    )\n    $result=Invoke-WebRequest -Uri \"https://$ipserver/mgmt/tm/cm/failover-status\" -Credential $credential -ErrorAction Ignore -UseBasicParsing\n    $items=$result.Content | ConvertFrom-Json\n    $status=$items.entries.'https://localhost/mgmt/tm/cm/failover-status/0'.nestedStats.entries.status\n    return $status\n}\n\nforeach($ipv4 in $f5_ip){\n    $state=Get-StatusF5 -ipserver $ipv4 -credential $cred\n    if (($state.description) -like \"ACTIVE\"){\n        $master=$ipv4\n        Write-Output \"F5 master ACTIVE: $master\"\n    }\n    else{\n        Write-Output \"$ipv4 is not master active\"\n    }\n}\nif (!$master){\n    Write-Error \"ATTENTION - F5 servers are incorrect\"\n}\n\n#retrieve informations\n$result=Invoke-WebRequest -Uri \"https://$master/mgmt/tm/ltm/pool/$pool/members\" -Credential $cred -UseBasicParsing\n$items=$result.Content | ConvertFrom-Json\n$items.items\n$name=($items.items | where{$_.name -like \"*$node*\"}).name\nWrite-Host \"Nome del nodo: $name\"\n\n#action based on $action\nif($action -like \"Enable\"){\n    $state ='{\"state\": \"user-up\", \"session\": \"user-enabled\"}' ###ENABLED\n    Write-Output \"Action: Enable $name\"\n    Invoke-WebRequest -Uri \"https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name\"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing\n}\nelse{\n    if($action -like \"Disable\"){\n        $state ='{\"state\": \"user-up\", \"session\": \"user-disabled\"}' ###Disabled\n        Write-Output \"Action: Enable $name\"\n        Invoke-WebRequest -Uri \"https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name\"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing\n    }\n    else{\n        if($action -like \"Offline\"){\n            $state ='{\"state\": \"user-down\", \"session\": \"user-disabled\"}' ###FORCEDOFFLINE\n            Invoke-WebRequest -Uri \"https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name\"  -Credential $cred -ContentType application/json -Method PUT -Body $state  -Verbose -UseBasicParsing\n            $current_conn=$numconn + 00\n\n            [int]$time = 0\n            Write-Output \"Connections accepted: $numconn\"\n            while($current_conn -gt $numconn){\n                if($second -ne $timeout){\n                    $url=\"https://$master/mgmt/tm/ltm/pool/$pool/members/~Common~$name\" + '/stats?$select=serverside.curConns'\n                    Start-Sleep 1\n                    [int]$second = $time++\n                    $result= Invoke-WebRequest -Uri $url -Credential $cred -UseBasicParsing\n                    $item=$result.Content | ConvertFrom-Json\n                    $current_conn=($item.entries.'serverside.curConns').value\n                    Write-Host \"Second: $second - Connections: $current_conn\"\n                }\n                else{\n                    Write-Output \"Timeout - $current_conn connections stopped\"\n                    $current_conn= 0\n                }\n            }\n    }\n        else{\n            Write-Error \"ACTION IS NOT ACCEPTED\"\n        }\n}\n}\nStart-sleep 10\nWrite-Host \"Go to next step\"\n",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Category": "F5",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/F5-API-enable-disable-member.json",
  "Website": "/step-templates/45d3003a-9443-42a0-aa71-38398eb4f9d6",
  "Logo": "https://i.octopus.com/library/step-templates/f5.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/F5-API-enable-disable-member.json)

</div>
