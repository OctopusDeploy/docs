---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2023-03-16
title: 'Proxmox Shutdown LXC Container'
description: 'Shutdown or Stop a Proxmox LXC container using the Proxmox API.

Requires a Proxmox [API token](https://pve.proxmox.com/wiki/Proxmox_VE_API#API_Tokens) to authenticate to the Proxmox Server/Cluster'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2023-03-16 by domrichardson belongs to 'Proxmox' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Proxmox Host

`Proxmox.Host = 1.2.3.4`

The hostname or IP address of the Proxmox cluster/host

</div>
        
<div class="param">

### Proxmox Port

`Proxmox.Port = 8006`

Port number for Proxmox Cluster/Host

</div>
        
<div class="param">

### Proxmox User Account

`Proxmox.User = root@pam`

The Proxmox user account associated with the api token.

</div>
        
<div class="param">

### Proxmox Node

`Proxmox.Node = `

The Proxmox node in the cluster.

</div>
        
<div class="param">

### Proxmox Token ID

`Proxmox.TokenID = `

This is token id that was used to create an API token in proxmox.

</div>
        
<div class="param">

### Proxmox API Token

`Proxmox.Token = `

The API Token secret key

</div>
        
<div class="param">

### LXC VM ID

`Proxmox.LXC.VMID = `

The LXC VMID you want to shutdown

</div>
        
<div class="param">

### Force Stop LXC

`Proxmox.LXC.Stop = False`

If enabled it will Force Stop the LXC Container Non-gracefully.
If disabled it will gracefully shutdown the LXC Container.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
# Proxmox Connection Variables
$ProxmoxHost = $OctopusParameters["Proxmox.Host"];
$ProxmoxPort = [int]$OctopusParameters["Proxmox.Port"];
$ProxmoxUser = $OctopusParameters["Proxmox.User"];

$ProxmoxNode = $OctopusParameters["Proxmox.Node"];

$ProxmoxTokenID = $OctopusParameters["Proxmox.TokenID"];
$ProxmoxToken = $OctopusParameters["Proxmox.Token"];

# LXC Variables
$LXC_VMID = [int]$OctopusParameters["Proxmox.LXC.VMID"];

$BaseURL = "https://$($ProxmoxHost):$($ProxmoxPort)/api2/json"

$header = @{
	"Authorization" = "PVEAPIToken=$($ProxmoxUser)!$($ProxmoxTokenID)=$($ProxmoxToken)"
}


Write-Host "Testing Connection To Proxmox Server/Cluster ..."

try{
	Invoke-RestMethod -Method GET -uri "$($BaseURL)" -Headers $header | out-null
}catch{
	throw "Couldn't Connect to the Proxmox Server/Cluster"
}

Write-Host "Successfully Connected To Proxmox Server/Cluster"

$CheckLXCExists = Invoke-RestMethod -Method GET -uri "$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/current" -Headers $header

if($CheckLXCExists.data -eq $null){
	throw "The LXC container with vmid ($LXC_VMID) does not exist!"
}


$LXC_Stop = $False
try {
  $Stop = [System.Convert]::ToBoolean($OctopusParameters["Proxmox.LXC.Stop"])
  
  if($Stop -eq $True){
  	$LXC_Stop = $True
  }
  
} catch {}

$LXCData = @{}

if($LXC_Stop -eq $True){
	$LXCStopAsyncTask = (Invoke-RestMethod -Method POST -uri "$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/stop" -Headers $header -Body $LXCData)
} else{
	$LXCStopAsyncTask = (Invoke-RestMethod -Method POST -uri "$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/shutdown" -Headers $header -Body $LXCData)
}

$count = 1;
$maxCount = 10;

$TaskID = $LXCStopAsyncTask.Data;

DO
{
    Write-Host "Checking if LXC has finished Shutting Down.."
    $LXCStopAsyncTaskStatus = (Invoke-RestMethod -Method GET -uri "$($BaseURL)/nodes/$($ProxmoxNode)/tasks/$($TaskID)/status" -Headers $header).data
    
    if($LXCStopAsyncTaskStatus.status -eq "stopped"){
    	if($LXCStopAsyncTaskStatus.exitstatus -ne "OK"){
        	Write-Error "LXC shutdown task finished with error: $($LXCStopAsyncTaskStatus.exitstatus)"
        }else{
        	Write-Host "LXC shutdown task has successfully completed!"
        }
        
        break;
    }
    
	Write-Host "LXC shutdown task has not finished yet, retring in 5 seconds.."
    Write-Host "Task Status: $($LXCStopAsyncTaskStatus.status)"
    sleep 5
    
    If($count -gt $maxCount) {
      Write-Warning "Task Timed out!"
      break;
    }
    $count++

} While ($count -le $maxCount)

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Proxmox%20Shutdown%20LXC%20Container&step-template=Proxmox%20Shutdown%20LXC%20Container)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "402a0407-9fa7-4d6a-8e13-9bbfa7228960",
  "Name": "Proxmox Shutdown LXC Container",
  "Description": "Shutdown or Stop a Proxmox LXC container using the Proxmox API.\n\nRequires a Proxmox [API token](https://pve.proxmox.com/wiki/Proxmox_VE_API#API_Tokens) to authenticate to the Proxmox Server/Cluster",
  "Version": 1,
  "ExportedAt": "2023-03-16T12:30:15.168Z",
  "ActionType": "Octopus.Script",
  "Author": "domrichardson",
  "Packages": [],
  "Parameters": [
    {
      "Id": "9f1a3789-a4fe-4fc4-9a66-78e73d384248",
      "Name": "Proxmox.Host",
      "Label": "Proxmox Host",
      "HelpText": "The hostname or IP address of the Proxmox cluster/host",
      "DefaultValue": "1.2.3.4",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "240b1180-7b10-48ac-90fb-796fc8eaaf41",
      "Name": "Proxmox.Port",
      "Label": "Proxmox Port",
      "HelpText": "Port number for Proxmox Cluster/Host",
      "DefaultValue": "8006",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "37d5fad7-2bd3-45da-b30c-62116f0b1940",
      "Name": "Proxmox.User",
      "Label": "Proxmox User Account",
      "HelpText": "The Proxmox user account associated with the api token.",
      "DefaultValue": "root@pam",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "72a89f72-2571-435b-b0f7-a383f08572b9",
      "Name": "Proxmox.Node",
      "Label": "Proxmox Node",
      "HelpText": "The Proxmox node in the cluster.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "b33b88c3-3949-4563-91a2-4ae264bc2d7f",
      "Name": "Proxmox.TokenID",
      "Label": "Proxmox Token ID",
      "HelpText": "This is token id that was used to create an API token in proxmox.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "eff9ca9b-b3ea-44e9-aa79-489d1d9161ee",
      "Name": "Proxmox.Token",
      "Label": "Proxmox API Token",
      "HelpText": "The API Token secret key",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Id": "f7be6495-cc3b-4492-bb1b-e8a178a36a91",
      "Name": "Proxmox.LXC.VMID",
      "Label": "LXC VM ID",
      "HelpText": "The LXC VMID you want to shutdown",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "94de0cbc-b722-4788-858f-fb2b32b57fd8",
      "Name": "Proxmox.LXC.Stop",
      "Label": "Force Stop LXC",
      "HelpText": "If enabled it will Force Stop the LXC Container Non-gracefully.\nIf disabled it will gracefully shutdown the LXC Container.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "# Proxmox Connection Variables\n$ProxmoxHost = $OctopusParameters[\"Proxmox.Host\"];\n$ProxmoxPort = [int]$OctopusParameters[\"Proxmox.Port\"];\n$ProxmoxUser = $OctopusParameters[\"Proxmox.User\"];\n\n$ProxmoxNode = $OctopusParameters[\"Proxmox.Node\"];\n\n$ProxmoxTokenID = $OctopusParameters[\"Proxmox.TokenID\"];\n$ProxmoxToken = $OctopusParameters[\"Proxmox.Token\"];\n\n# LXC Variables\n$LXC_VMID = [int]$OctopusParameters[\"Proxmox.LXC.VMID\"];\n\n$BaseURL = \"https://$($ProxmoxHost):$($ProxmoxPort)/api2/json\"\n\n$header = @{\n\t\"Authorization\" = \"PVEAPIToken=$($ProxmoxUser)!$($ProxmoxTokenID)=$($ProxmoxToken)\"\n}\n\n\nWrite-Host \"Testing Connection To Proxmox Server/Cluster ...\"\n\ntry{\n\tInvoke-RestMethod -Method GET -uri \"$($BaseURL)\" -Headers $header | out-null\n}catch{\n\tthrow \"Couldn't Connect to the Proxmox Server/Cluster\"\n}\n\nWrite-Host \"Successfully Connected To Proxmox Server/Cluster\"\n\n$CheckLXCExists = Invoke-RestMethod -Method GET -uri \"$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/current\" -Headers $header\n\nif($CheckLXCExists.data -eq $null){\n\tthrow \"The LXC container with vmid ($LXC_VMID) does not exist!\"\n}\n\n\n$LXC_Stop = $False\ntry {\n  $Stop = [System.Convert]::ToBoolean($OctopusParameters[\"Proxmox.LXC.Stop\"])\n  \n  if($Stop -eq $True){\n  \t$LXC_Stop = $True\n  }\n  \n} catch {}\n\n$LXCData = @{}\n\nif($LXC_Stop -eq $True){\n\t$LXCStopAsyncTask = (Invoke-RestMethod -Method POST -uri \"$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/stop\" -Headers $header -Body $LXCData)\n} else{\n\t$LXCStopAsyncTask = (Invoke-RestMethod -Method POST -uri \"$($BaseURL)/nodes/$($ProxmoxNode)/lxc/$($LXC_VMID)/status/shutdown\" -Headers $header -Body $LXCData)\n}\n\n$count = 1;\n$maxCount = 10;\n\n$TaskID = $LXCStopAsyncTask.Data;\n\nDO\n{\n    Write-Host \"Checking if LXC has finished Shutting Down..\"\n    $LXCStopAsyncTaskStatus = (Invoke-RestMethod -Method GET -uri \"$($BaseURL)/nodes/$($ProxmoxNode)/tasks/$($TaskID)/status\" -Headers $header).data\n    \n    if($LXCStopAsyncTaskStatus.status -eq \"stopped\"){\n    \tif($LXCStopAsyncTaskStatus.exitstatus -ne \"OK\"){\n        \tWrite-Error \"LXC shutdown task finished with error: $($LXCStopAsyncTaskStatus.exitstatus)\"\n        }else{\n        \tWrite-Host \"LXC shutdown task has successfully completed!\"\n        }\n        \n        break;\n    }\n    \n\tWrite-Host \"LXC shutdown task has not finished yet, retring in 5 seconds..\"\n    Write-Host \"Task Status: $($LXCStopAsyncTaskStatus.status)\"\n    sleep 5\n    \n    If($count -gt $maxCount) {\n      Write-Warning \"Task Timed out!\"\n      break;\n    }\n    $count++\n\n} While ($count -le $maxCount)\n"
  },
  "Category": "Proxmox",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/proxmox-stop-lxc.json",
  "Website": "/step-templates/402a0407-9fa7-4d6a-8e13-9bbfa7228960",
  "Logo": "https://i.octopus.com/library/step-templates/proxmox.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/proxmox-stop-lxc.json)

</div>
