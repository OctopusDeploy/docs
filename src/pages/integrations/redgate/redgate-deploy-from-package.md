---
layout: src/layouts/Default.astro
pubDate: 2021-08-23
title: 'Redgate - Deploy from Package'
description: 'Uses Redgate's [SQL Change Automation](http://www.red-gate.com/sca/productpage) to deploy a package containing a database schema to a SQL Server database, without a review step.

Requires SQL Change Automation version 3.0.2 or later.

*Version date: 2020-12-21*'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2021-08-23 by benjimac93 belongs to 'Redgate' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Database package step

`DLMAutomationNuGetDbPackageDownloadStepName`

Select the step in this project which downloads the database package.

</div>
        
<div class="param">

### Target SQL Server instance

`DLMAutomationTargetDatabaseServer`

The fully qualified SQL Server instance name for the target database.

</div>
        
<div class="param">

### Target database name

`DLMAutomationTargetDatabaseName`

The name of the database to deploy changes to.

</div>
        
<div class="param">

### Username (optional)

`DLMAutomationTargetUsername`

The SQL Server username used to connect to the database. If you leave this field and 'Password' blank, Windows authentication will be used to connect instead, using the account that runs the Tentacle service.

</div>
        
<div class="param">

### Password (optional)

`DLMAutomationTargetPassword`

You must enter a password if you entered a username.

</div>
        
<div class="param">

### Encrypt

`DLMAutomationTargetEncrypt = false`

Specify whether SSL encryption is used by SQL Server when a certificate is installed.

</div>
        
<div class="param">

### Trust Server Certificate

`DLMAutomationTargetTrustServerCertificate = false`

Specify whether to force SQL Server to skip certificate validation.

</div>
        
<div class="param">

### Filter path (optional)

`DLMAutomationFilterPath`

Specify the location of a SQL Compare filter file (.scpf), which defines objects to include/exclude in the schema comparison. Filter files are generated by SQL Source Control.

For more help see [Using SQL Compare filters in SQL Change Automation](http://www.red-gate.com/sca/ps/help/filters).

</div>
        
<div class="param">

### SQL Compare options (optional)

`DLMAutomationCompareOptions`

Enter SQL Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Compare options in SQL Change Automation](http://www.red-gate.com/sca/add-ons/compare-options).

</div>
        
<div class="param">

### SQL Data Compare options (optional)

`DLMAutomationDataCompareOptions`

Enter SQL Data Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Data Compare options in SQL Change Automation](http://www.red-gate.com/sca/ps/help/datacompareoptions).

</div>
        
<div class="param">

### Transaction isolation level (optional)

`DLMAutomationTransactionIsolationLevel = Serializable`

Select the transaction isolation level to be used in deployment scripts.

</div>
        
<div class="param">

### Ignore static data

`DLMAutomationIgnoreStaticData`

Exclude changes to static data when generating the deployment resources.

</div>
        
<div class="param">

### Query batch timeout (in seconds)

`DLMAutomationQueryBatchTimeout = 30`

The execution timeout, in seconds, for each batch of queries in the update script. The default value is 30 seconds. A value of zero indicates no execution timeout.

</div>
        
<div class="param">

### Skip post update schema check

`DLMAutomationSkipPostUpdateSchemaCheck = False`

Don't check that the target database has the correct schema after the update has run.

</div>
        
<div class="param">

### SQL Change Automation version (optional)

`SpecificModuleVersion`

If you wish to use a specific version of SQL Change Automation rather than the latest, enter the version number here.

</div>
        
<div class="param">

### Only use a version of SQL Change Automation that is already installed

`UseInstalledModuleVersion = False`

This prevents attempting to access PowerShell Gallery, which can be helpful when the build agent does not have access to the internet

</div>
        
<div class="param">

### Module Installation Folder (optional)

`DLMAutomationModuleInstallationFolder`

By default, module folders do not persist between steps. Setting this field to a specific folder will ensure that modules persist, and do not have to be downloaded again.

</div>
        
<div class="param">

### Proxy URL (optional)

`DLMAutomationProxyUrl`

By default, no proxy is used when connecting to Powershell Gallery. Alternatively, a proxy URL can be specified here that can be used for Powershell Gallery.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
function GetModuleInstallationFolder
{
    if (ModuleInstallationFolderIsValid)
    {
        return [System.IO.Path]::GetFullPath($DLMAutomationModuleInstallationFolder)
    }

    return "$PSScriptRoot\Modules"
}

function ModuleInstallationFolderIsValid
{
    if ([string]::IsNullOrWhiteSpace($DLMAutomationModuleInstallationFolder))
    {
        return $false
    }

    return (Test-Path $DLMAutomationModuleInstallationFolder -IsValid) -eq $true;
}

$DlmAutomationModuleName = "DLMAutomation"
$SqlChangeAutomationModuleName = "SqlChangeAutomation"
$ModulesFolder = GetModuleInstallationFolder
$LocalModules = (New-Item "$ModulesFolder" -ItemType Directory -Force).FullName
$env:PSModulePath = "$LocalModules;$env:PSModulePath"

function IsScaAvailable
{
    if ((Get-Module $SqlChangeAutomationModuleName) -ne $null) {
        return $true
    }

    return $false
}

function InstallCorrectSqlChangeAutomation
{
    [CmdletBinding()]
    Param(
        [Parameter(Mandatory = $false)]
        [Version]$requiredVersion,
        [Parameter(Mandatory = $false)]
        [bool]$useInstalledVersion
    )

    $moduleName = $SqlChangeAutomationModuleName

    # this will be null if $requiredVersion is not specified - which is exactly what we want
    $maximumVersion = $requiredVersion

    if ($requiredVersion) {
        if ($requiredVersion.Revision -eq -1) {
            #If provided with a 3 part version number (the 4th part, revision, == -1), we should allow any value for the revision
            $maximumVersion = [Version]"$requiredVersion.$([System.Int32]::MaxValue)"
        }

        if ($requiredVersion.Major -lt 3) {
            # If the specified version is below V3 then the user is requesting a version of DLMA. We should look for that module name instead
            $moduleName = $DlmAutomationModuleName
        }
    }

    if ($useInstalledVersion) {
        Write-Verbose "Option to use installed version is selected. Skipping update/install using PowerShellGet."
    }
    else {
        $installedModule = GetHighestInstalledModule $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion

        if (!$installedModule) {
            #Either SCA isn't installed at all or $requiredVersion is specified but that version of SCA isn't installed
            Write-Verbose "$moduleName $requiredVersion not available - attempting to download from gallery"
            InstallLocalModule -moduleName $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion
        }
        elseif (!$requiredVersion) {
            #We've got a version of SCA installed, but $requiredVersion isn't specified so we might be able to upgrade
            $newest = GetHighestInstallableModule $moduleName
            if ($newest -and ($installedModule.Version -lt $newest.Version)) {
                Write-Verbose "Updating $moduleName to version $($newest.Version)"
                InstallLocalModule -moduleName $moduleName -minimumVersion $newest.Version
            }
        }
    }

    # Now we're done with install/upgrade, try to import the highest available module that matches our version requirements

    # We can't just use -minimumVersion and -maximumVersion arguments on Import-Module because PowerShell 3 doesn't have them,
    # so we have to find the precise matching installed version using our code, then import that specifically. Note that
    # $requiredVersion and $maximumVersion might be null when there's no specific version we need.
    $installedModule = GetHighestInstalledModule $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion

    if (!$installedModule -and !$requiredVersion) {
        #Did not find SCA, and we don't have a required version so we might be able to use an installed DLMA instead.
        Write-Verbose "$moduleName is not installed - trying to fall back to $DlmAutomationModuleName"
        $installedModule = GetHighestInstalledModule $DlmAutomationModuleName
    }

    if ($installedModule) {
        Write-Verbose "Importing installed $($installedModule.Name) version $($installedModule.Version)"
        Import-Module $installedModule -Force
    }
    else {
        throw "$moduleName $requiredVersion is not installed, and could not be downloaded from the PowerShell gallery"
    }
}

function InstallPowerShellGet {
    [CmdletBinding()]
    Param()

    ConfigureProxyIfVariableSet
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12

    $psget = GetHighestInstalledModule PowerShellGet
    if (!$psget)
    {
        Write-Warning @"
Cannot access the PowerShell Gallery because PowerShellGet is not installed.
To install PowerShellGet, either upgrade to PowerShell 5 or install the PackageManagement MSI.
See https://docs.microsoft.com/en-us/powershell/gallery/installing-psget for more details.
"@
        throw "PowerShellGet is not available"
    }

    if ($psget.Version -lt [Version]'1.6') {
        #Bootstrap the NuGet package provider, which updates NuGet without requiring admin rights
        Write-Debug "Installing NuGet package provider"
        Get-PackageProvider NuGet -ForceBootstrap | Out-Null

        #Use the currently-installed version of PowerShellGet
        Import-PackageProvider PowerShellGet

        #Download the version of PowerShellGet that we actually need
        Write-Debug "Installing PowershellGet"
        Save-Module -Name PowerShellGet -Path $LocalModules -MinimumVersion 1.6 -Force -ErrorAction SilentlyContinue
    }

    Write-Debug "Importing PowershellGet"
    Import-Module PowerShellGet -MinimumVersion 1.6 -Force
    #Make sure we're actually using the package provider from the imported version of PowerShellGet
    Import-PackageProvider ((Get-Module PowerShellGet).Path) | Out-Null
}

function InstallLocalModule {
    [CmdletBinding()]
    Param(
        [Parameter(Mandatory = $true)]
        [string]$moduleName,
        [Parameter(Mandatory = $false)]
        [Version]$minimumVersion,
        [Parameter(Mandatory = $false)]
        [Version]$maximumVersion
    )
    try {
        InstallPowerShellGet

        Write-Debug "Install $moduleName $requiredVersion"
        Save-Module -Name $moduleName -Path $LocalModules -Force -AcceptLicense -MinimumVersion $minimumVersion -MaximumVersion $maximumVersion -ErrorAction Stop
    }
    catch {
        Write-Warning "Could not install $moduleName $requiredVersion from any registered PSRepository"
    }
}

function GetHighestInstalledModule {
    [CmdletBinding()]
    Param(
        [Parameter(Mandatory = $true, Position = 0)]
        [string] $moduleName,

        [Parameter(Mandatory = $false)]
        [Version]$minimumVersion,
        [Parameter(Mandatory = $false)]
        [Version]$maximumVersion
    )

    return Get-Module $moduleName -ListAvailable |
           Where {(!$minimumVersion -or ($_.Version -ge $minimumVersion)) -and (!$maximumVersion -or ($_.Version -le $maximumVersion))} |
           Sort -Property @{Expression = {[System.Version]($_.Version)}; Descending = $True} |
           Select -First 1
}

function GetHighestInstallableModule {
    [CmdletBinding()]
    Param(
        [Parameter(Mandatory = $true, Position = 0)]
        [string] $moduleName
    )

    try {
        InstallPowerShellGet
        Find-Module SqlChangeAutomation -AllVersions |
            Sort -Property @{Expression = {[System.Version]($_.Version)}; Descending = $True} |
            Select -First 1
    }
    catch {
        Write-Warning "Could not find any suitable versions of $moduleName from any registered PSRepository"
    }
}

function GetInstalledSqlChangeAutomationVersion {
    $scaModule = (Get-Module $SqlChangeAutomationModuleName)

    if ($scaModule -ne $null) {
        return $scaModule.Version
    }

    $dlmaModule = (Get-Module $DlmAutomationModuleName)

    if ($dlmaModule -ne $null) {
        return $dlmaModule.Version
    }

    return $null
}

function ConfigureProxyIfVariableSet
{
    if ([string]::IsNullOrWhiteSpace($DLMAutomationProxyUrl) -eq $false)
    {
        Write-Debug "Setting DefaultWebProxy to $proxyUrl"

        [System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy($DLMAutomationProxyUrl)
        [System.Net.WebRequest]::DefaultWebProxy.credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials
        [System.Net.WebRequest]::DefaultWebProxy.BypassProxyOnLocal = $True
    }
}


$ErrorActionPreference = 'Stop'
$VerbosePreference = 'Continue'

# Set process level FUR environment
$env:REDGATE_FUR_ENVIRONMENT = "Octopus Step Templates"

#Helper functions for paramter handling
function Required() {
    Param(
        [Parameter(Mandatory = $false)][string]$Parameter,
        [Parameter(Mandatory = $true)][string]$Name
    )
    if ([string]::IsNullOrWhiteSpace($Parameter)) { throw "You must enter a value for '$Name'" }
}
function Optional() {
    #Default is untyped here - if we specify [string] powershell will convert nulls into empty string
    Param(
        [Parameter(Mandatory = $false)][string]$Parameter,
        [Parameter(Mandatory = $false)]$Default
    )
    if ([string]::IsNullOrWhiteSpace($Parameter)) {
        $Default
    } else {
        $Parameter
    }
}
function RequireBool() {
    Param(
        [Parameter(Mandatory = $false)][string]$Parameter,
        [Parameter(Mandatory = $true)][string]$Name
    )
    $Result = $False
    if (![bool]::TryParse($Parameter , [ref]$Result )) { throw "'$Name' must be a boolean value." }
    $Result
}
function RequirePositiveNumber() {
    Param(
        [Parameter(Mandatory = $false)][string]$Parameter,
        [Parameter(Mandatory = $true)][string]$Name
    )
    $Result = 0
    if (![int32]::TryParse($Parameter , [ref]$Result )) { throw "'$Name' must be a numerical value." }
    if ($Result -lt 0) { throw "'$Name' must be >= 0." }
    $Result
}

$SpecificModuleVersion = Optional -Parameter $SpecificModuleVersion
$UseInstalledModuleVersion = Optional -Parameter $UseInstalledModuleVersion -Default 'False'
$UseInstalledVersionSwitch = [bool]::Parse($UseInstalledModuleVersion)
InstallCorrectSqlChangeAutomation -requiredVersion $SpecificModuleVersion -useInstalledVersion $UseInstalledVersionSwitch

# Check if SQL Change Automation is installed.
$powershellModule = Get-Module -Name SqlChangeAutomation
if ($powershellModule -eq $null) {
    throw "Cannot find SQL Change Automation on your Octopus Tentacle. If SQL Change Automation is installed, try restarting the Tentacle service for it to be detected."
}

$currentVersion = $powershellModule.Version
$minimumRequiredVersion = [version] '3.0.3'
if ($currentVersion -lt $minimumRequiredVersion) {
    throw "This step requires SQL Change Automation version $minimumRequiredVersion or later. The current version is $currentVersion. The latest version can be found at http://www.red-gate.com/sca/productpage"
}

$minimumRequiredVersionDataCompareOptions = [version] '3.3.0'
$minimumRequiredVersionTrustServerCertificate = [version]'4.3.20267'

function AreConnectionOptionsHandled($encryptConnection, $trustServerCertificate)
{
    if ([string]::IsNullOrWhiteSpace($currentVersion) -or $currentVersion -ge $minimumRequiredVersionTrustServerCertificate)
    {
        return $true
    }
    elseif($encryptConnection -or $trustServerCertificate)
    {
        Write-Warning "Encrypt and TrustServerCertificate options require SQL Change Automation version $minimumRequiredVersionTrustServerCertificate or later. The current version is $currentVersion."
        return $false
    }
}

# Check the parameters.
Required -Parameter $DLMAutomationNuGetDbPackageDownloadStepName -Name 'Database package step'
Required -Parameter $DLMAutomationTargetDatabaseServer -Name 'Target SQL Server instance'
Required -Parameter $DLMAutomationTargetDatabaseName -Name 'Target database name'
$DLMAutomationTargetTrustServerCertificate = Optional -Parameter $DLMAutomationTargetTrustServerCertificate
$DLMAutomationTargetEncrypt = Optional -Parameter $DLMAutomationTargetEncrypt
$DLMAutomationTargetUsername = Optional -Parameter $DLMAutomationTargetUsername
$DLMAutomationTargetPassword = Optional -Parameter $DLMAutomationTargetPassword
$DLMAutomationFilterPath = Optional -Parameter $DLMAutomationFilterPath
$DLMAutomationCompareOptions = Optional -Parameter $DLMAutomationCompareOptions
$DLMAutomationDataCompareOptions = Optional -Parameter $DLMAutomationDataCompareOptions
$DLMAutomationTransactionIsolationLevel = Optional -Parameter $DLMAutomationTransactionIsolationLevel -Default "Serializable"
$DLMAutomationIgnoreStaticData = Optional -Parameter $DLMAutomationIgnoreStaticData -Default 'False'
$DLMAutomationSkipPostUpdateSchemaCheck = Optional -Parameter $DLMAutomationSkipPostUpdateSchemaCheck -Default "False"
$DLMAutomationQueryBatchTimeout = Optional -Parameter $DLMAutomationQueryBatchTimeout -Default '30'
$DLMAutomationModuleInstallationFolder = Optional -Parameter $DLMAutomationModuleInstallationFolder
$DLMAutomationProxyUrl = Optional -Parameter $DLMAutomationProxyUrl

$skipPostUpdateSchemaCheck = RequireBool -Parameter $DLMAutomationSkipPostUpdateSchemaCheck -Name 'Skip post update schema check'
$queryBatchTimeout = RequirePositiveNumber -Parameter $DLMAutomationQueryBatchTimeout -Name 'Query Batch Timeout'

# Get the NuGet package installation directory path.
$packageExtractPath = $OctopusParameters["Octopus.Action[$DLMAutomationNuGetDbPackageDownloadStepName].Output.Package.InstallationDirectoryPath"]
if($packageExtractPath -eq $null) {
    throw "The 'Database package download step' is not a 'Deploy a NuGet package' step: '$DLMAutomationNuGetDbPackageDownloadStepName'"
}

$targetConnectionOptions = @{ }

if(AreConnectionOptionsHandled([bool]::Parse($DLMAutomationTargetEncrypt), [bool]::Parse($DLMAutomationTargetTrustServerCertificate))) {
    $targetConnectionOptions += @{ 'Encrypt' = [bool]::Parse($DLMAutomationTargetEncrypt) }
    $targetConnectionOptions += @{ 'TrustServerCertificate' = [bool]::Parse($DLMAutomationTargetTrustServerCertificate) }
}

$targetDB = New-DatabaseConnection @targetConnectionOptions `
                                   -ServerInstance $DLMAutomationTargetDatabaseServer `
                                   -Database $DLMAutomationTargetDatabaseName `
                                   -Username $DLMAutomationTargetUsername `
                                   -Password $DLMAutomationTargetPassword

$importedBuildArtifact = Import-DatabaseBuildArtifact -Path $packageExtractPath

# Only allow sqlcmd variables that don't have special characters like spaces, colon or dashes
$regex = '^[a-zA-Z_][a-zA-Z0-9_]+$'
$sqlCmdVariables = @{}
$OctopusParameters.Keys | Where { $_ -match $regex } | ForEach {
	$sqlCmdVariables[$_] = $OctopusParameters[$_]
}

# Create database deployment resources from the NuGet package to the database
$releaseParams = @{
    Target = $targetDB
    Source = $importedBuildArtifact
    TransactionIsolationLevel = $DLMAutomationTransactionIsolationLevel
    IgnoreStaticData = [bool]::Parse($DLMAutomationIgnoreStaticData)
    FilterPath = $DLMAutomationFilterPath
    SQLCompareOptions = $DLMAutomationCompareOptions
    SqlCmdVariables = $sqlCmdVariables
}

if($currentVersion -ge $minimumRequiredVersionDataCompareOptions) {
    $releaseParams.SQLDataCompareOptions = $DLMAutomationDataCompareOptions
} elseif(-not [string]::IsNullOrWhiteSpace($DLMAutomationDataCompareOptions)) {
    Write-Warning "SQL Data Compare options requires SQL Change Automation version $minimumRequiredVersionDataCompareOptions or later. The current version is $currentVersion."
}

$release = New-DatabaseReleaseArtifact @releaseParams

# Deploy the source schema to the target database.
Write-Host "Timeout = $queryBatchTimeout"
$releaseUrl = $OctopusParameters['#{if Octopus.Web.ServerUri}#{Octopus.Web.ServerUri}#{else}#{Octopus.Web.BaseUrl}#{/if}'] + $OctopusParameters['Octopus.Web.DeploymentLink'];
$release | Use-DatabaseReleaseArtifact -DeployTo $targetDB -SkipPreUpdateSchemaCheck -QueryBatchTimeout $queryBatchTimeout -ReleaseUrl $releaseUrl -SkipPostUpdateSchemaCheck:$skipPostUpdateSchemaCheck


```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Redgate%20-%20Deploy%20from%20Package&step-template=Redgate%20-%20Deploy%20from%20Package)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "19f750fb-2ce8-4361-859e-2dfcdf08a952",
  "Name": "Redgate - Deploy from Package",
  "Description": "Uses Redgate's [SQL Change Automation](http://www.red-gate.com/sca/productpage) to deploy a package containing a database schema to a SQL Server database, without a review step.\r\n\r\nRequires SQL Change Automation version 3.0.2 or later.\r\n\r\n*Version date: 2020-12-21*",
  "Version": 18,
  "ExportedAt": "2021-08-23T12:40:10.975Z",
  "ActionType": "Octopus.Script",
  "Author": "benjimac93",
  "Parameters": [
    {
      "Name": "DLMAutomationNuGetDbPackageDownloadStepName",
      "Label": "Database package step",
      "HelpText": "Select the step in this project which downloads the database package.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Name": "DLMAutomationTargetDatabaseServer",
      "Label": "Target SQL Server instance",
      "HelpText": "The fully qualified SQL Server instance name for the target database.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationTargetDatabaseName",
      "Label": "Target database name",
      "HelpText": "The name of the database to deploy changes to.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationTargetUsername",
      "Label": "Username (optional)",
      "HelpText": "The SQL Server username used to connect to the database. If you leave this field and 'Password' blank, Windows authentication will be used to connect instead, using the account that runs the Tentacle service.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationTargetPassword",
      "Label": "Password (optional)",
      "HelpText": "You must enter a password if you entered a username.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Name": "DLMAutomationTargetEncrypt",
      "Label": "Encrypt",
      "HelpText": "Specify whether SSL encryption is used by SQL Server when a certificate is installed.",
      "DefaultValue": "false",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "DLMAutomationTargetTrustServerCertificate",
      "Label": "Trust Server Certificate",
      "HelpText": "Specify whether to force SQL Server to skip certificate validation.",
      "DefaultValue": "false",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "DLMAutomationFilterPath",
      "Label": "Filter path (optional)",
      "HelpText": "Specify the location of a SQL Compare filter file (.scpf), which defines objects to include/exclude in the schema comparison. Filter files are generated by SQL Source Control.\n\nFor more help see [Using SQL Compare filters in SQL Change Automation](http://www.red-gate.com/sca/ps/help/filters).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationCompareOptions",
      "Label": "SQL Compare options (optional)",
      "HelpText": "Enter SQL Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Compare options in SQL Change Automation](http://www.red-gate.com/sca/add-ons/compare-options).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationDataCompareOptions",
      "Label": "SQL Data Compare options (optional)",
      "HelpText": "Enter SQL Data Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Data Compare options in SQL Change Automation](http://www.red-gate.com/sca/ps/help/datacompareoptions).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationTransactionIsolationLevel",
      "Label": "Transaction isolation level (optional)",
      "HelpText": "Select the transaction isolation level to be used in deployment scripts.",
      "DefaultValue": "Serializable",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "Serializable\nSnapshot\nRepeatableRead\nReadCommitted\nReadUncommitted"
      }
    },
    {
      "Name": "DLMAutomationIgnoreStaticData",
      "Label": "Ignore static data",
      "HelpText": "Exclude changes to static data when generating the deployment resources.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "DLMAutomationQueryBatchTimeout",
      "Label": "Query batch timeout (in seconds)",
      "HelpText": "The execution timeout, in seconds, for each batch of queries in the update script. The default value is 30 seconds. A value of zero indicates no execution timeout.",
      "DefaultValue": "30",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationSkipPostUpdateSchemaCheck",
      "Label": "Skip post update schema check",
      "HelpText": "Don't check that the target database has the correct schema after the update has run.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "SpecificModuleVersion",
      "Label": "SQL Change Automation version (optional)",
      "HelpText": "If you wish to use a specific version of SQL Change Automation rather than the latest, enter the version number here.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "UseInstalledModuleVersion",
      "Label": "Only use a version of SQL Change Automation that is already installed",
      "HelpText": "This prevents attempting to access PowerShell Gallery, which can be helpful when the build agent does not have access to the internet",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "DLMAutomationModuleInstallationFolder",
      "Label": "Module Installation Folder (optional)",
      "HelpText": "By default, module folders do not persist between steps. Setting this field to a specific folder will ensure that modules persist, and do not have to be downloaded again.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DLMAutomationProxyUrl",
      "Label": "Proxy URL (optional)",
      "HelpText": "By default, no proxy is used when connecting to Powershell Gallery. Alternatively, a proxy URL can be specified here that can be used for Powershell Gallery.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "function GetModuleInstallationFolder\n{\n    if (ModuleInstallationFolderIsValid)\n    {\n        return [System.IO.Path]::GetFullPath($DLMAutomationModuleInstallationFolder)\n    }\n\n    return \"$PSScriptRoot\\Modules\"\n}\n\nfunction ModuleInstallationFolderIsValid\n{\n    if ([string]::IsNullOrWhiteSpace($DLMAutomationModuleInstallationFolder))\n    {\n        return $false\n    }\n\n    return (Test-Path $DLMAutomationModuleInstallationFolder -IsValid) -eq $true;\n}\n\n$DlmAutomationModuleName = \"DLMAutomation\"\n$SqlChangeAutomationModuleName = \"SqlChangeAutomation\"\n$ModulesFolder = GetModuleInstallationFolder\n$LocalModules = (New-Item \"$ModulesFolder\" -ItemType Directory -Force).FullName\n$env:PSModulePath = \"$LocalModules;$env:PSModulePath\"\n\nfunction IsScaAvailable\n{\n    if ((Get-Module $SqlChangeAutomationModuleName) -ne $null) {\n        return $true\n    }\n\n    return $false\n}\n\nfunction InstallCorrectSqlChangeAutomation\n{\n    [CmdletBinding()]\n    Param(\n        [Parameter(Mandatory = $false)]\n        [Version]$requiredVersion,\n        [Parameter(Mandatory = $false)]\n        [bool]$useInstalledVersion\n    )\n\n    $moduleName = $SqlChangeAutomationModuleName\n\n    # this will be null if $requiredVersion is not specified - which is exactly what we want\n    $maximumVersion = $requiredVersion\n\n    if ($requiredVersion) {\n        if ($requiredVersion.Revision -eq -1) {\n            #If provided with a 3 part version number (the 4th part, revision, == -1), we should allow any value for the revision\n            $maximumVersion = [Version]\"$requiredVersion.$([System.Int32]::MaxValue)\"\n        }\n\n        if ($requiredVersion.Major -lt 3) {\n            # If the specified version is below V3 then the user is requesting a version of DLMA. We should look for that module name instead\n            $moduleName = $DlmAutomationModuleName\n        }\n    }\n\n    if ($useInstalledVersion) {\n        Write-Verbose \"Option to use installed version is selected. Skipping update/install using PowerShellGet.\"\n    }\n    else {\n        $installedModule = GetHighestInstalledModule $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion\n\n        if (!$installedModule) {\n            #Either SCA isn't installed at all or $requiredVersion is specified but that version of SCA isn't installed\n            Write-Verbose \"$moduleName $requiredVersion not available - attempting to download from gallery\"\n            InstallLocalModule -moduleName $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion\n        }\n        elseif (!$requiredVersion) {\n            #We've got a version of SCA installed, but $requiredVersion isn't specified so we might be able to upgrade\n            $newest = GetHighestInstallableModule $moduleName\n            if ($newest -and ($installedModule.Version -lt $newest.Version)) {\n                Write-Verbose \"Updating $moduleName to version $($newest.Version)\"\n                InstallLocalModule -moduleName $moduleName -minimumVersion $newest.Version\n            }\n        }\n    }\n\n    # Now we're done with install/upgrade, try to import the highest available module that matches our version requirements\n\n    # We can't just use -minimumVersion and -maximumVersion arguments on Import-Module because PowerShell 3 doesn't have them,\n    # so we have to find the precise matching installed version using our code, then import that specifically. Note that\n    # $requiredVersion and $maximumVersion might be null when there's no specific version we need.\n    $installedModule = GetHighestInstalledModule $moduleName -minimumVersion $requiredVersion -maximumVersion $maximumVersion\n\n    if (!$installedModule -and !$requiredVersion) {\n        #Did not find SCA, and we don't have a required version so we might be able to use an installed DLMA instead.\n        Write-Verbose \"$moduleName is not installed - trying to fall back to $DlmAutomationModuleName\"\n        $installedModule = GetHighestInstalledModule $DlmAutomationModuleName\n    }\n\n    if ($installedModule) {\n        Write-Verbose \"Importing installed $($installedModule.Name) version $($installedModule.Version)\"\n        Import-Module $installedModule -Force\n    }\n    else {\n        throw \"$moduleName $requiredVersion is not installed, and could not be downloaded from the PowerShell gallery\"\n    }\n}\n\nfunction InstallPowerShellGet {\n    [CmdletBinding()]\n    Param()\n\n    ConfigureProxyIfVariableSet\n    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12\n\n    $psget = GetHighestInstalledModule PowerShellGet\n    if (!$psget)\n    {\n        Write-Warning @\"\nCannot access the PowerShell Gallery because PowerShellGet is not installed.\nTo install PowerShellGet, either upgrade to PowerShell 5 or install the PackageManagement MSI.\nSee https://docs.microsoft.com/en-us/powershell/gallery/installing-psget for more details.\n\"@\n        throw \"PowerShellGet is not available\"\n    }\n\n    if ($psget.Version -lt [Version]'1.6') {\n        #Bootstrap the NuGet package provider, which updates NuGet without requiring admin rights\n        Write-Debug \"Installing NuGet package provider\"\n        Get-PackageProvider NuGet -ForceBootstrap | Out-Null\n\n        #Use the currently-installed version of PowerShellGet\n        Import-PackageProvider PowerShellGet\n\n        #Download the version of PowerShellGet that we actually need\n        Write-Debug \"Installing PowershellGet\"\n        Save-Module -Name PowerShellGet -Path $LocalModules -MinimumVersion 1.6 -Force -ErrorAction SilentlyContinue\n    }\n\n    Write-Debug \"Importing PowershellGet\"\n    Import-Module PowerShellGet -MinimumVersion 1.6 -Force\n    #Make sure we're actually using the package provider from the imported version of PowerShellGet\n    Import-PackageProvider ((Get-Module PowerShellGet).Path) | Out-Null\n}\n\nfunction InstallLocalModule {\n    [CmdletBinding()]\n    Param(\n        [Parameter(Mandatory = $true)]\n        [string]$moduleName,\n        [Parameter(Mandatory = $false)]\n        [Version]$minimumVersion,\n        [Parameter(Mandatory = $false)]\n        [Version]$maximumVersion\n    )\n    try {\n        InstallPowerShellGet\n\n        Write-Debug \"Install $moduleName $requiredVersion\"\n        Save-Module -Name $moduleName -Path $LocalModules -Force -AcceptLicense -MinimumVersion $minimumVersion -MaximumVersion $maximumVersion -ErrorAction Stop\n    }\n    catch {\n        Write-Warning \"Could not install $moduleName $requiredVersion from any registered PSRepository\"\n    }\n}\n\nfunction GetHighestInstalledModule {\n    [CmdletBinding()]\n    Param(\n        [Parameter(Mandatory = $true, Position = 0)]\n        [string] $moduleName,\n\n        [Parameter(Mandatory = $false)]\n        [Version]$minimumVersion,\n        [Parameter(Mandatory = $false)]\n        [Version]$maximumVersion\n    )\n\n    return Get-Module $moduleName -ListAvailable |\n           Where {(!$minimumVersion -or ($_.Version -ge $minimumVersion)) -and (!$maximumVersion -or ($_.Version -le $maximumVersion))} |\n           Sort -Property @{Expression = {[System.Version]($_.Version)}; Descending = $True} |\n           Select -First 1\n}\n\nfunction GetHighestInstallableModule {\n    [CmdletBinding()]\n    Param(\n        [Parameter(Mandatory = $true, Position = 0)]\n        [string] $moduleName\n    )\n\n    try {\n        InstallPowerShellGet\n        Find-Module SqlChangeAutomation -AllVersions |\n            Sort -Property @{Expression = {[System.Version]($_.Version)}; Descending = $True} |\n            Select -First 1\n    }\n    catch {\n        Write-Warning \"Could not find any suitable versions of $moduleName from any registered PSRepository\"\n    }\n}\n\nfunction GetInstalledSqlChangeAutomationVersion {\n    $scaModule = (Get-Module $SqlChangeAutomationModuleName)\n\n    if ($scaModule -ne $null) {\n        return $scaModule.Version\n    }\n\n    $dlmaModule = (Get-Module $DlmAutomationModuleName)\n\n    if ($dlmaModule -ne $null) {\n        return $dlmaModule.Version\n    }\n\n    return $null\n}\n\nfunction ConfigureProxyIfVariableSet\n{\n    if ([string]::IsNullOrWhiteSpace($DLMAutomationProxyUrl) -eq $false)\n    {\n        Write-Debug \"Setting DefaultWebProxy to $proxyUrl\"\n\n        [System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy($DLMAutomationProxyUrl)\n        [System.Net.WebRequest]::DefaultWebProxy.credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials\n        [System.Net.WebRequest]::DefaultWebProxy.BypassProxyOnLocal = $True\n    }\n}\n\n\n$ErrorActionPreference = 'Stop'\n$VerbosePreference = 'Continue'\n\n# Set process level FUR environment\n$env:REDGATE_FUR_ENVIRONMENT = \"Octopus Step Templates\"\n\n#Helper functions for paramter handling\nfunction Required() {\n    Param(\n        [Parameter(Mandatory = $false)][string]$Parameter,\n        [Parameter(Mandatory = $true)][string]$Name\n    )\n    if ([string]::IsNullOrWhiteSpace($Parameter)) { throw \"You must enter a value for '$Name'\" }\n}\nfunction Optional() {\n    #Default is untyped here - if we specify [string] powershell will convert nulls into empty string\n    Param(\n        [Parameter(Mandatory = $false)][string]$Parameter,\n        [Parameter(Mandatory = $false)]$Default\n    )\n    if ([string]::IsNullOrWhiteSpace($Parameter)) {\n        $Default\n    } else {\n        $Parameter\n    }\n}\nfunction RequireBool() {\n    Param(\n        [Parameter(Mandatory = $false)][string]$Parameter,\n        [Parameter(Mandatory = $true)][string]$Name\n    )\n    $Result = $False\n    if (![bool]::TryParse($Parameter , [ref]$Result )) { throw \"'$Name' must be a boolean value.\" }\n    $Result\n}\nfunction RequirePositiveNumber() {\n    Param(\n        [Parameter(Mandatory = $false)][string]$Parameter,\n        [Parameter(Mandatory = $true)][string]$Name\n    )\n    $Result = 0\n    if (![int32]::TryParse($Parameter , [ref]$Result )) { throw \"'$Name' must be a numerical value.\" }\n    if ($Result -lt 0) { throw \"'$Name' must be >= 0.\" }\n    $Result\n}\n\n$SpecificModuleVersion = Optional -Parameter $SpecificModuleVersion\n$UseInstalledModuleVersion = Optional -Parameter $UseInstalledModuleVersion -Default 'False'\n$UseInstalledVersionSwitch = [bool]::Parse($UseInstalledModuleVersion)\nInstallCorrectSqlChangeAutomation -requiredVersion $SpecificModuleVersion -useInstalledVersion $UseInstalledVersionSwitch\n\n# Check if SQL Change Automation is installed.\n$powershellModule = Get-Module -Name SqlChangeAutomation\nif ($powershellModule -eq $null) {\n    throw \"Cannot find SQL Change Automation on your Octopus Tentacle. If SQL Change Automation is installed, try restarting the Tentacle service for it to be detected.\"\n}\n\n$currentVersion = $powershellModule.Version\n$minimumRequiredVersion = [version] '3.0.3'\nif ($currentVersion -lt $minimumRequiredVersion) {\n    throw \"This step requires SQL Change Automation version $minimumRequiredVersion or later. The current version is $currentVersion. The latest version can be found at http://www.red-gate.com/sca/productpage\"\n}\n\n$minimumRequiredVersionDataCompareOptions = [version] '3.3.0'\n$minimumRequiredVersionTrustServerCertificate = [version]'4.3.20267'\n\nfunction AreConnectionOptionsHandled($encryptConnection, $trustServerCertificate)\n{\n    if ([string]::IsNullOrWhiteSpace($currentVersion) -or $currentVersion -ge $minimumRequiredVersionTrustServerCertificate)\n    {\n        return $true\n    }\n    elseif($encryptConnection -or $trustServerCertificate)\n    {\n        Write-Warning \"Encrypt and TrustServerCertificate options require SQL Change Automation version $minimumRequiredVersionTrustServerCertificate or later. The current version is $currentVersion.\"\n        return $false\n    }\n}\n\n# Check the parameters.\nRequired -Parameter $DLMAutomationNuGetDbPackageDownloadStepName -Name 'Database package step'\nRequired -Parameter $DLMAutomationTargetDatabaseServer -Name 'Target SQL Server instance'\nRequired -Parameter $DLMAutomationTargetDatabaseName -Name 'Target database name'\n$DLMAutomationTargetTrustServerCertificate = Optional -Parameter $DLMAutomationTargetTrustServerCertificate\n$DLMAutomationTargetEncrypt = Optional -Parameter $DLMAutomationTargetEncrypt\n$DLMAutomationTargetUsername = Optional -Parameter $DLMAutomationTargetUsername\n$DLMAutomationTargetPassword = Optional -Parameter $DLMAutomationTargetPassword\n$DLMAutomationFilterPath = Optional -Parameter $DLMAutomationFilterPath\n$DLMAutomationCompareOptions = Optional -Parameter $DLMAutomationCompareOptions\n$DLMAutomationDataCompareOptions = Optional -Parameter $DLMAutomationDataCompareOptions\n$DLMAutomationTransactionIsolationLevel = Optional -Parameter $DLMAutomationTransactionIsolationLevel -Default \"Serializable\"\n$DLMAutomationIgnoreStaticData = Optional -Parameter $DLMAutomationIgnoreStaticData -Default 'False'\n$DLMAutomationSkipPostUpdateSchemaCheck = Optional -Parameter $DLMAutomationSkipPostUpdateSchemaCheck -Default \"False\"\n$DLMAutomationQueryBatchTimeout = Optional -Parameter $DLMAutomationQueryBatchTimeout -Default '30'\n$DLMAutomationModuleInstallationFolder = Optional -Parameter $DLMAutomationModuleInstallationFolder\n$DLMAutomationProxyUrl = Optional -Parameter $DLMAutomationProxyUrl\n\n$skipPostUpdateSchemaCheck = RequireBool -Parameter $DLMAutomationSkipPostUpdateSchemaCheck -Name 'Skip post update schema check'\n$queryBatchTimeout = RequirePositiveNumber -Parameter $DLMAutomationQueryBatchTimeout -Name 'Query Batch Timeout'\n\n# Get the NuGet package installation directory path.\n$packageExtractPath = $OctopusParameters[\"Octopus.Action[$DLMAutomationNuGetDbPackageDownloadStepName].Output.Package.InstallationDirectoryPath\"]\nif($packageExtractPath -eq $null) {\n    throw \"The 'Database package download step' is not a 'Deploy a NuGet package' step: '$DLMAutomationNuGetDbPackageDownloadStepName'\"\n}\n\n$targetConnectionOptions = @{ }\n\nif(AreConnectionOptionsHandled([bool]::Parse($DLMAutomationTargetEncrypt), [bool]::Parse($DLMAutomationTargetTrustServerCertificate))) {\n    $targetConnectionOptions += @{ 'Encrypt' = [bool]::Parse($DLMAutomationTargetEncrypt) }\n    $targetConnectionOptions += @{ 'TrustServerCertificate' = [bool]::Parse($DLMAutomationTargetTrustServerCertificate) }\n}\n\n$targetDB = New-DatabaseConnection @targetConnectionOptions `\n                                   -ServerInstance $DLMAutomationTargetDatabaseServer `\n                                   -Database $DLMAutomationTargetDatabaseName `\n                                   -Username $DLMAutomationTargetUsername `\n                                   -Password $DLMAutomationTargetPassword\n\n$importedBuildArtifact = Import-DatabaseBuildArtifact -Path $packageExtractPath\n\n# Only allow sqlcmd variables that don't have special characters like spaces, colon or dashes\n$regex = '^[a-zA-Z_][a-zA-Z0-9_]+$'\n$sqlCmdVariables = @{}\n$OctopusParameters.Keys | Where { $_ -match $regex } | ForEach {\n\t$sqlCmdVariables[$_] = $OctopusParameters[$_]\n}\n\n# Create database deployment resources from the NuGet package to the database\n$releaseParams = @{\n    Target = $targetDB\n    Source = $importedBuildArtifact\n    TransactionIsolationLevel = $DLMAutomationTransactionIsolationLevel\n    IgnoreStaticData = [bool]::Parse($DLMAutomationIgnoreStaticData)\n    FilterPath = $DLMAutomationFilterPath\n    SQLCompareOptions = $DLMAutomationCompareOptions\n    SqlCmdVariables = $sqlCmdVariables\n}\n\nif($currentVersion -ge $minimumRequiredVersionDataCompareOptions) {\n    $releaseParams.SQLDataCompareOptions = $DLMAutomationDataCompareOptions\n} elseif(-not [string]::IsNullOrWhiteSpace($DLMAutomationDataCompareOptions)) {\n    Write-Warning \"SQL Data Compare options requires SQL Change Automation version $minimumRequiredVersionDataCompareOptions or later. The current version is $currentVersion.\"\n}\n\n$release = New-DatabaseReleaseArtifact @releaseParams\n\n# Deploy the source schema to the target database.\nWrite-Host \"Timeout = $queryBatchTimeout\"\n$releaseUrl = $OctopusParameters['#{if Octopus.Web.ServerUri}#{Octopus.Web.ServerUri}#{else}#{Octopus.Web.BaseUrl}#{/if}'] + $OctopusParameters['Octopus.Web.DeploymentLink'];\n$release | Use-DatabaseReleaseArtifact -DeployTo $targetDB -SkipPreUpdateSchemaCheck -QueryBatchTimeout $queryBatchTimeout -ReleaseUrl $releaseUrl -SkipPostUpdateSchemaCheck:$skipPostUpdateSchemaCheck\n\n",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Category": "Redgate",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/redgate-deploy-from-package.json",
  "Website": "/step-templates/19f750fb-2ce8-4361-859e-2dfcdf08a952",
  "Logo": "https://i.octopus.com/library/step-templates/redgate.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/redgate-deploy-from-package.json)

</div>
