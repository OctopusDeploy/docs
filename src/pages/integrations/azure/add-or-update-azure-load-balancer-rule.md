---
layout: src/layouts/Default.astro
pubDate: 2018-05-04
title: 'Add or update Azure Load balancer Rule'
description: 'Create a new azure load balancer rule. With the default frontend ip configuration and default backend address pool.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.AzurePowerShell exported 2018-05-04 by bobjwalker belongs to 'Azure' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Account

`Azure.LoadBalancerCreateRule.Account = `

null

</div>
        
<div class="param">

### Resource group name

`Azure.LoadBalancerCreateRule.ResourceGroupName = `

null

</div>
        
<div class="param">

### Load balancer name

`Azure.LoadBalancerCreateRule.LoadBalancerName = `

null

</div>
        
<div class="param">

### Rule name

`Azure.LoadBalancerCreateRule.RuleName = `

null

</div>
        
<div class="param">

### Protocol

`Azure.LoadBalancerCreateRule.Protocol = tcp`

null

</div>
        
<div class="param">

### Frontend port

`Azure.LoadBalancerCreateRule.FrontendPort = `

null

</div>
        
<div class="param">

### Backend port

`Azure.LoadBalancerCreateRule.BackendPort = `

null

</div>
        
<div class="param">

### Health probe name

`Azure.LoadBalancerCreateRule.HealthProbeName = `

null

</div>
        
<div class="param">

### Idle timeout

`Azure.LoadBalancerCreateRule.IdleTimeout = `

In minutes

</div>
        
<div class="param">

### Load distribution

`Azure.LoadBalancerCreateRule.LoadDistribution = `

null

</div>
        

## Script body

Steps based on this template will execute the following *undefined* script.

```undefined
Write-Output "Resource group name: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])"
Write-Output "Load balancer name : $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName'])"
Write-Output "Rule name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'])"

Write-Output "Protocol: $($OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'])"
Write-Output "Frontend port: $($OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'])"
Write-Output "Backend port: $($OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'])"
Write-Output "Healt probe name: $($OctopusParameters['Azure.LoadBalancerCreateRule.HealthProbeName'])"
Write-Output "Idle timeout: $($OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'])"
Write-Output "Load distribution: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution'])"

$loadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'] -name $OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']
$rule = Get-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] -LoadBalancer $loadBalancer -ErrorAction:SilentlyContinue
$healthProbe = Get-AzureRmLoadBalancerProbeConfig -name $OctopusParameters['Azure.LoadBalancerCreateRule.HealthProbeName'] -LoadBalancer $loadBalancer -ErrorAction:SilentlyContinue

if($rule -eq $null)
{
	#Create rule
    Write-output "Creating load balancer rule with name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName']) in load balancer: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])"
	
    $loadBalancer | Add-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] `
		-FrontendIpConfigurationId ($loadBalancer.FrontendIpConfigurations[0].Id) `
		-Protocol $OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'] `
		-FrontendPort $OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'] `
		-BackendPort $OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'] `
		-BackendAddressPoolId ($loadBalancer.BackendAddressPools[0].Id) `
		-ProbeId ($healthProbe.Id) `
		-IdleTimeoutInMinutes $OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'] `
		-LoadDistribution $OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution']
}
else
{
	#Update rule
    Write-output "Updating load balancer rule with name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName']) in load balancer: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])"
	
	$loadBalancer | Set-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] `
		-FrontendIpConfigurationId ($loadBalancer.FrontendIpConfigurations[0].Id) `
		-Protocol $OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'] `
		-FrontendPort $OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'] `
		-BackendPort $OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'] `
		-BackendAddressPoolId ($loadBalancer.BackendAddressPools[0].Id) `
		-ProbeId ($healthProbe.Id) `
		-IdleTimeoutInMinutes $OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'] `
		-LoadDistribution $OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution']
}

Write-host "Saving loadbalancer"
Set-AzureRmLoadBalancer -LoadBalancer $loadBalancer
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Add%20or%20update%20Azure%20Load%20balancer%20Rule&step-template=Add%20or%20update%20Azure%20Load%20balancer%20Rule)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "1df09b27-905c-4b24-9ad5-008af574508a",
  "Name": "Add or update Azure Load balancer Rule",
  "Description": "Create a new azure load balancer rule. With the default frontend ip configuration and default backend address pool.",
  "Version": 10,
  "ExportedAt": "2018-05-04T12:53:19.489Z",
  "ActionType": "Octopus.AzurePowerShell",
  "Author": "bobjwalker",
  "Parameters": [
    {
      "Id": "95e211f5-7a85-4116-9eb6-578ffa72314a",
      "Name": "Azure.LoadBalancerCreateRule.Account",
      "Label": "Account",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "AzureAccount"
      },
      "Links": {}
    },
    {
      "Id": "05715167-0ecd-463e-8ede-c2dc6eaa683c",
      "Name": "Azure.LoadBalancerCreateRule.ResourceGroupName",
      "Label": "Resource group name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "c4adbfbd-6023-420b-8582-6d79a65a28f6",
      "Name": "Azure.LoadBalancerCreateRule.LoadBalancerName",
      "Label": "Load balancer name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "8984e095-b895-4d2b-93c9-b62ad67b84b1",
      "Name": "Azure.LoadBalancerCreateRule.RuleName",
      "Label": "Rule name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "fda6f233-707e-4eb3-9d61-12f44b83d92f",
      "Name": "Azure.LoadBalancerCreateRule.Protocol",
      "Label": "Protocol",
      "HelpText": null,
      "DefaultValue": "tcp",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "tcp|tcp\nudp|udp"
      },
      "Links": {}
    },
    {
      "Id": "077dcc26-9058-4b96-95d7-b846c5548b20",
      "Name": "Azure.LoadBalancerCreateRule.FrontendPort",
      "Label": "Frontend port",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "8d68b615-93f3-4412-af5f-5cd2d9403cbd",
      "Name": "Azure.LoadBalancerCreateRule.BackendPort",
      "Label": "Backend port",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "41fdcd90-e5f1-4313-801e-033106a50afa",
      "Name": "Azure.LoadBalancerCreateRule.HealthProbeName",
      "Label": "Health probe name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "eef1ff50-989b-4bc7-9109-08824ac9111b",
      "Name": "Azure.LoadBalancerCreateRule.IdleTimeout",
      "Label": "Idle timeout",
      "HelpText": "In minutes",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "62011de8-c0ec-4c38-8970-ff7a543d2b64",
      "Name": "Azure.LoadBalancerCreateRule.LoadDistribution",
      "Label": "Load distribution",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "default|none\nSourceIP|Client IP\nSourceIPProtocol|Client IPand protocol"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.ScriptBody": "Write-Output \"Resource group name: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])\"\nWrite-Output \"Load balancer name : $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName'])\"\nWrite-Output \"Rule name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'])\"\n\nWrite-Output \"Protocol: $($OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'])\"\nWrite-Output \"Frontend port: $($OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'])\"\nWrite-Output \"Backend port: $($OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'])\"\nWrite-Output \"Healt probe name: $($OctopusParameters['Azure.LoadBalancerCreateRule.HealthProbeName'])\"\nWrite-Output \"Idle timeout: $($OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'])\"\nWrite-Output \"Load distribution: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution'])\"\n\n$loadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'] -name $OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']\n$rule = Get-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] -LoadBalancer $loadBalancer -ErrorAction:SilentlyContinue\n$healthProbe = Get-AzureRmLoadBalancerProbeConfig -name $OctopusParameters['Azure.LoadBalancerCreateRule.HealthProbeName'] -LoadBalancer $loadBalancer -ErrorAction:SilentlyContinue\n\nif($rule -eq $null)\n{\n\t#Create rule\n    Write-output \"Creating load balancer rule with name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName']) in load balancer: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])\"\n\t\n    $loadBalancer | Add-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] `\n\t\t-FrontendIpConfigurationId ($loadBalancer.FrontendIpConfigurations[0].Id) `\n\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'] `\n\t\t-FrontendPort $OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'] `\n\t\t-BackendPort $OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'] `\n\t\t-BackendAddressPoolId ($loadBalancer.BackendAddressPools[0].Id) `\n\t\t-ProbeId ($healthProbe.Id) `\n\t\t-IdleTimeoutInMinutes $OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'] `\n\t\t-LoadDistribution $OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution']\n}\nelse\n{\n\t#Update rule\n    Write-output \"Updating load balancer rule with name: $($OctopusParameters['Azure.LoadBalancerCreateRule.RuleName']) in load balancer: $($OctopusParameters['Azure.LoadBalancerCreateRule.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateRule.ResourceGroupName'])\"\n\t\n\t$loadBalancer | Set-AzureRmLoadBalancerRuleConfig -Name $OctopusParameters['Azure.LoadBalancerCreateRule.RuleName'] `\n\t\t-FrontendIpConfigurationId ($loadBalancer.FrontendIpConfigurations[0].Id) `\n\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateRule.Protocol'] `\n\t\t-FrontendPort $OctopusParameters['Azure.LoadBalancerCreateRule.FrontendPort'] `\n\t\t-BackendPort $OctopusParameters['Azure.LoadBalancerCreateRule.BackendPort'] `\n\t\t-BackendAddressPoolId ($loadBalancer.BackendAddressPools[0].Id) `\n\t\t-ProbeId ($healthProbe.Id) `\n\t\t-IdleTimeoutInMinutes $OctopusParameters['Azure.LoadBalancerCreateRule.IdleTimeout'] `\n\t\t-LoadDistribution $OctopusParameters['Azure.LoadBalancerCreateRule.LoadDistribution']\n}\n\nWrite-host \"Saving loadbalancer\"\nSet-AzureRmLoadBalancer -LoadBalancer $loadBalancer",
    "Octopus.Action.Azure.AccountId": "#{Azure.LoadBalancerCreateRule.Account}"
  },
  "Category": "Azure",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/azure-add-or-update-azure-loadbalancer-rule.json",
  "Website": "/step-templates/1df09b27-905c-4b24-9ad5-008af574508a",
  "Logo": "https://i.octopus.com/library/step-templates/azure.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/azure-add-or-update-azure-loadbalancer-rule.json)

</div>
