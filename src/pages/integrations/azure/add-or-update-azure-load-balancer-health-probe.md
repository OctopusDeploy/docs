---
layout: src/layouts/Default.astro
pubDate: 2018-05-04
title: 'Add or update Azure Load Balancer Health Probe'
description: 'null'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.AzurePowerShell exported 2018-05-04 by prebenh belongs to 'Azure' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Account

`Azure.LoadBalancerCreateHealthProbe.Account = `

null

</div>
        
<div class="param">

### Resource group name

`Azure.LoadBalancerCreateHealthProbe.ResourceGroupName = `

null

</div>
        
<div class="param">

### Load balancer name

`Azure.LoadBalancerCreateHealthProbe.LoadBalancerName = `

null

</div>
        
<div class="param">

### Health probe name

`Azure.LoadBalancerCreateHealthProbe.HealthProbeName = `

null

</div>
        
<div class="param">

### Protocol

`Azure.LoadBalancerCreateHealthProbe.Protocol = tcp`

null

</div>
        
<div class="param">

### Path

`Azure.LoadBalancerCreateHealthProbe.Path = /`

null

</div>
        
<div class="param">

### Port

`Azure.LoadBalancerCreateHealthProbe.Port = `

null

</div>
        
<div class="param">

### Interval

`Azure.LoadBalancerCreateHealthProbe.Interval = `

interval in seconds

</div>
        
<div class="param">

### Unhealty threshold

`Azure.LoadBalancerCreateHealthProbe.ProbeCount = `

number of consecutive failures

</div>
        

## Script body

Steps based on this template will execute the following *undefined* script.

```text


Write-Output "Resource group name: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])"
Write-Output "Load balancer name : $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName'])"
Write-Output "Health probe name: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'])"

Write-Output "Protocol: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'])"
Write-Output "Path: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'])"
Write-Output "Port: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port'])"
Write-Output "Interval: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'])"
Write-Output "Probe count: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'])"


$loadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'] -name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']
$healthProbe = Get-AzureRmLoadBalancerProbeConfig -name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] -LoadBalancer $loadBalancer  -ErrorAction:SilentlyContinue

if($healthProbe -eq $null)
{
	#Create healthProbe
	Write-Output "Creating healt probe: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName']) on load balancer: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])"
	
	if($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] -eq "http")
	{
		#path only used in http
		$loadBalancer  | Add-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `
			-RequestPath  $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'] `
			-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `
			-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `
			-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `
			-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'] 
	}
	else
	{
		# Path is not part of tcp config
		$loadBalancer  | Add-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `
			-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `
			-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `
			-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `
			-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount']
	}
}
else
{
	#Update healthProbe
	Write-Output "Updating healt probe: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName']) on load balancer: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])"
	
	if($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] -eq "http")
	{
		#path only used in http
		$loadBalancer  | Set-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `
			-RequestPath  $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'] `
			-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `
			-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `
			-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `
			-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'] 
	}
	else
	{
		# Path is not part of tcp config
		$loadBalancer  | Set-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `
			-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `
			-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `
			-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `
			-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount']
	}
}

Write-Host "Save changes to loadbalancer"
Set-AzureRmLoadBalancer -LoadBalancer $loadBalancer
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Add%20or%20update%20Azure%20Load%20Balancer%20Health%20Probe&step-template=Add%20or%20update%20Azure%20Load%20Balancer%20Health%20Probe)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "59528692-2107-45eb-9fde-55e7329822a9",
  "Name": "Add or update Azure Load Balancer Health Probe",
  "Description": null,
  "Version": 1,
  "ExportedAt": "2018-05-04T12:46:43.193Z",
  "ActionType": "Octopus.AzurePowerShell",
  "Author": "prebenh",
  "Parameters": [
    {
      "Id": "e720d0e8-14d7-47cc-96a9-b074aa2dcf14",
      "Name": "Azure.LoadBalancerCreateHealthProbe.Account",
      "Label": "Account",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "AzureAccount"
      },
      "Links": {}
    },
    {
      "Id": "87a93c04-2395-4a73-9999-6b6dacc546fe",
      "Name": "Azure.LoadBalancerCreateHealthProbe.ResourceGroupName",
      "Label": "Resource group name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "d155c5eb-7cd8-4f57-b3ca-d6c32c7403e1",
      "Name": "Azure.LoadBalancerCreateHealthProbe.LoadBalancerName",
      "Label": "Load balancer name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "79619a6d-1d28-4900-bc24-1c597c649bf4",
      "Name": "Azure.LoadBalancerCreateHealthProbe.HealthProbeName",
      "Label": "Health probe name",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "beed45f9-6c8d-424b-a072-57c0d1657437",
      "Name": "Azure.LoadBalancerCreateHealthProbe.Protocol",
      "Label": "Protocol",
      "HelpText": null,
      "DefaultValue": "tcp",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "http|http\ntcp|tcp"
      },
      "Links": {}
    },
    {
      "Id": "403a32d1-17c5-4ee9-8095-25919369ded3",
      "Name": "Azure.LoadBalancerCreateHealthProbe.Path",
      "Label": "Path",
      "HelpText": null,
      "DefaultValue": "/",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "6c7d97da-264c-402d-b207-239922c547ef",
      "Name": "Azure.LoadBalancerCreateHealthProbe.Port",
      "Label": "Port",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "a5bfd24b-1249-4383-8204-336abc43a435",
      "Name": "Azure.LoadBalancerCreateHealthProbe.Interval",
      "Label": "Interval",
      "HelpText": "interval in seconds",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "033d0e37-30f9-49c8-b012-c18416596624",
      "Name": "Azure.LoadBalancerCreateHealthProbe.ProbeCount",
      "Label": "Unhealty threshold",
      "HelpText": "number of consecutive failures",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Azure.AccountId": "#{Azure.LoadBalancerCreateHealthProbe.Account}",
    "Octopus.Action.Script.ScriptBody": "\n\nWrite-Output \"Resource group name: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])\"\nWrite-Output \"Load balancer name : $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName'])\"\nWrite-Output \"Health probe name: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'])\"\n\nWrite-Output \"Protocol: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'])\"\nWrite-Output \"Path: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'])\"\nWrite-Output \"Port: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port'])\"\nWrite-Output \"Interval: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'])\"\nWrite-Output \"Probe count: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'])\"\n\n\n$loadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'] -name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']\n$healthProbe = Get-AzureRmLoadBalancerProbeConfig -name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] -LoadBalancer $loadBalancer  -ErrorAction:SilentlyContinue\n\nif($healthProbe -eq $null)\n{\n\t#Create healthProbe\n\tWrite-Output \"Creating healt probe: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName']) on load balancer: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])\"\n\t\n\tif($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] -eq \"http\")\n\t{\n\t\t#path only used in http\n\t\t$loadBalancer  | Add-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `\n\t\t\t-RequestPath  $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'] `\n\t\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `\n\t\t\t-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `\n\t\t\t-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `\n\t\t\t-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'] \n\t}\n\telse\n\t{\n\t\t# Path is not part of tcp config\n\t\t$loadBalancer  | Add-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `\n\t\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `\n\t\t\t-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `\n\t\t\t-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `\n\t\t\t-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount']\n\t}\n}\nelse\n{\n\t#Update healthProbe\n\tWrite-Output \"Updating healt probe: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName']) on load balancer: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.LoadBalancerName']) in resource group: $($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ResourceGroupName'])\"\n\t\n\tif($OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] -eq \"http\")\n\t{\n\t\t#path only used in http\n\t\t$loadBalancer  | Set-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `\n\t\t\t-RequestPath  $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Path'] `\n\t\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `\n\t\t\t-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `\n\t\t\t-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `\n\t\t\t-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount'] \n\t}\n\telse\n\t{\n\t\t# Path is not part of tcp config\n\t\t$loadBalancer  | Set-AzureRmLoadBalancerProbeConfig -Name $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.HealthProbeName'] `\n\t\t\t-Protocol $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Protocol'] `\n\t\t\t-Port $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Port']  `\n\t\t\t-IntervalInSeconds $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.Interval'] `\n\t\t\t-ProbeCount $OctopusParameters['Azure.LoadBalancerCreateHealthProbe.ProbeCount']\n\t}\n}\n\nWrite-Host \"Save changes to loadbalancer\"\nSet-AzureRmLoadBalancer -LoadBalancer $loadBalancer"
  },
  "Category": "Azure",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/azure-add-or-update-azure-loadbalancer-health-probe.json",
  "Website": "/step-templates/59528692-2107-45eb-9fde-55e7329822a9",
  "Logo": "https://i.octopus.com/library/step-templates/azure.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/azure-add-or-update-azure-loadbalancer-health-probe.json)

</div>
