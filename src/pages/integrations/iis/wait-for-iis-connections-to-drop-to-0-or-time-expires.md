---
layout: src/layouts/Default.astro
pubDate: 2017-07-28
title: 'Wait for IIS connections to drop to 0 or time expires'
description: 'Wait for IIS connections to drop to 0 or time expires'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2017-07-28 by tbrasch belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Sleep Seconds

`wfitdSleepSeconds = 4`

Number of seconds to sleep between checking connection count.

</div>
        
<div class="param">

### Total Wait Minutes

`wfitdTotalWaitMinutes = 5`

Maximum wait time in minutes before proceeding, even if connections have not dropped to 0.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
Import-Module WebAdministration

$websites = Get-ChildItem IIS:\Sites
$continue = $true

#Verify sleepSeconds can be converted to integer.
$sleepSecondsString = 4

If ($OctopusParameters['wfitdSleepSeconds'])
{
  $sleepSecondsString = $OctopusParameters['wfitdSleepSeconds']
}

[int]$sleepSeconds = 0
[bool]$result = [int]::TryParse($sleepSecondsString, [ref]$sleepSeconds)

If ($result)
{
  Write-Host ('Sleep Seconds: ' + $sleepSeconds)
}
Else
{
  Throw "Cannot convert Sleep Seconds: '" + $sleepSecondsString + "' to integer."
}

#Verify totalWaitMinutes can be converted to integer.
$totalWaitMinutesString = 5

If ($OctopusParameters['wfitdTotalWaitMinutes'])
{
  $totalWaitMinutesString = $OctopusParameters['wfitdTotalWaitMinutes']
}

[int]$totalWaitMinutes = 0
[bool]$result = [int]::TryParse($totalWaitMinutesString, [ref]$totalWaitMinutes)

If ($result)
{
  Write-Host ('Total Wait Minutes: ' + $totalWaitMinutes)
}
Else
{
  Throw "Cannot convert Total Wait Minutes: '" + $totalWaitMinutesString + "' to integer."
}

Write-Host '***********************************************'

$stopWatch = [system.diagnostics.stopwatch]::StartNew()
While ($continue)
{
  $connectionsExist = $false
  
  Foreach ($website in $websites)
  {
    $connections = (Get-Counter ('\\' + $env:COMPUTERNAME  + '\web service(' + $website.name + ')\Current Connections')).CounterSamples.CookedValue
    Write-Host ($website.Name + ' - ' + $connections + ' connection(s).')
    If ($connections -gt 0)
    {
      $connectionsExist = $true
    }
  }
  
  If ($connectionsExist)
  {
    Start-Sleep -Seconds $sleepSeconds
    
    If ($stopWatch.Elapsed.Minutes -ge $totalWaitMinutes)
    {
      $continue = $false
    }
  }
  Else
  {
    $continue = $false
  }
  
  Write-Host ('Elapsed seconds: ' + $stopWatch.Elapsed.TotalSeconds)
  Write-Host '==============================================='
}

$stopWatch.Stop()

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Wait%20for%20IIS%20connections%20to%20drop%20to%200%20or%20time%20expires&step-template=Wait%20for%20IIS%20connections%20to%20drop%20to%200%20or%20time%20expires)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "2e27acd9-5ab3-4580-b746-7d0a0de23fcc",
  "Name": "Wait for IIS connections to drop to 0 or time expires",
  "Description": "Wait for IIS connections to drop to 0 or time expires",
  "Version": 1,
  "ExportedAt": "2017-07-28T18:51:55.519Z",
  "ActionType": "Octopus.Script",
  "Author": "tbrasch",
  "Parameters": [
    {
      "Id": "af43ce76-167e-44f2-a985-eee8597f8e39",
      "Name": "wfitdSleepSeconds",
      "Label": "Sleep Seconds",
      "HelpText": "Number of seconds to sleep between checking connection count.",
      "DefaultValue": "4",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "37709659-d95b-4524-a287-771c1b62d112",
      "Name": "wfitdTotalWaitMinutes",
      "Label": "Total Wait Minutes",
      "HelpText": "Maximum wait time in minutes before proceeding, even if connections have not dropped to 0.",
      "DefaultValue": "5",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptBody": "Import-Module WebAdministration\n\n$websites = Get-ChildItem IIS:\\Sites\n$continue = $true\n\n#Verify sleepSeconds can be converted to integer.\n$sleepSecondsString = 4\n\nIf ($OctopusParameters['wfitdSleepSeconds'])\n{\n  $sleepSecondsString = $OctopusParameters['wfitdSleepSeconds']\n}\n\n[int]$sleepSeconds = 0\n[bool]$result = [int]::TryParse($sleepSecondsString, [ref]$sleepSeconds)\n\nIf ($result)\n{\n  Write-Host ('Sleep Seconds: ' + $sleepSeconds)\n}\nElse\n{\n  Throw \"Cannot convert Sleep Seconds: '\" + $sleepSecondsString + \"' to integer.\"\n}\n\n#Verify totalWaitMinutes can be converted to integer.\n$totalWaitMinutesString = 5\n\nIf ($OctopusParameters['wfitdTotalWaitMinutes'])\n{\n  $totalWaitMinutesString = $OctopusParameters['wfitdTotalWaitMinutes']\n}\n\n[int]$totalWaitMinutes = 0\n[bool]$result = [int]::TryParse($totalWaitMinutesString, [ref]$totalWaitMinutes)\n\nIf ($result)\n{\n  Write-Host ('Total Wait Minutes: ' + $totalWaitMinutes)\n}\nElse\n{\n  Throw \"Cannot convert Total Wait Minutes: '\" + $totalWaitMinutesString + \"' to integer.\"\n}\n\nWrite-Host '***********************************************'\n\n$stopWatch = [system.diagnostics.stopwatch]::StartNew()\nWhile ($continue)\n{\n  $connectionsExist = $false\n  \n  Foreach ($website in $websites)\n  {\n    $connections = (Get-Counter ('\\\\' + $env:COMPUTERNAME  + '\\web service(' + $website.name + ')\\Current Connections')).CounterSamples.CookedValue\n    Write-Host ($website.Name + ' - ' + $connections + ' connection(s).')\n    If ($connections -gt 0)\n    {\n      $connectionsExist = $true\n    }\n  }\n  \n  If ($connectionsExist)\n  {\n    Start-Sleep -Seconds $sleepSeconds\n    \n    If ($stopWatch.Elapsed.Minutes -ge $totalWaitMinutes)\n    {\n      $continue = $false\n    }\n  }\n  Else\n  {\n    $continue = $false\n  }\n  \n  Write-Host ('Elapsed seconds: ' + $stopWatch.Elapsed.TotalSeconds)\n  Write-Host '==============================================='\n}\n\n$stopWatch.Stop()\n",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/wait-for-iis-connections-to-drop-to-zero.json",
  "Website": "/step-templates/2e27acd9-5ab3-4580-b746-7d0a0de23fcc",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/wait-for-iis-connections-to-drop-to-zero.json)

</div>
