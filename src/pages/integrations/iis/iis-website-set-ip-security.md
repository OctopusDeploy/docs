---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2021-03-01
title: 'IIS Website - Set IP Security'
description: 'Takes a list of ip/mask and allow them in ipsecurity'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2021-03-01 by olsh belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Name of Website

`Site`

null

</div>
        
<div class="param">

### List of ip addresses

`IpAddresses`

A newline separated list of IP addresses and/or IP address and subnet mask pairs in the format <IPAddress>/<SubnetMask>.

</div>
        
<div class="param">

### Enable proxy mode

`EnableProxyMode`

If the website is running behind a proxy, this setting most likely need to be checked.

</div>
        
<div class="param">

### Set deny

`SetDeny`

If checked, IIS will be changed to "Deny" all IP addresses not added to the list.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
$existingRules = Get-WebConfiguration /system.webServer/security/ipSecurity/* -location $Site -pspath IIS://;
[Object[]]$newRules = @();

$ips = $IpAddresses -split '\n';
$ips = $ips.Trim('\r');
foreach ($u in $ips) {
    $a = $u.Split("/");
    $newRules += [Object]@{ ipAddress = $a[0]; subnetMask = $a[1]; allowed = $true };
}

if ($EnableProxyMode -eq "true") {
    Write-Output "Enabling proxy mode"
    set-webconfigurationproperty -Filter /system.webServer/security/ipSecurity -location $Site -Name "enableProxyMode" -Value "true"
}

if ($SetDeny -eq "true") {
    Write-Output "Setting Deny rule"
    set-webconfigurationproperty -Filter /system.webServer/security/ipSecurity -location $Site -Name "allowUnlisted" -Value "false"
}

function addRules([string]$website, [Object[]]$newRules, [Object[]]$oldRules) {

    foreach ($rule in $newRules) {
        if (ruleExists $rule $oldRules) {
            Write-Host "Rule $($rule.ipAddress)/$($rule.subnetMask) already exists";

            continue;
        }

        $value = @{ipAddress = $($rule.ipAddress); allowed = "true" }
        if ([string]::IsNullOrEmpty($rule.subnetMask)) {
            Write-Output "Adding ip $($rule.ipAddress) to allow"
        }
        else {
            Write-Output "Adding ip $($rule.ipAddress)/$($rule.subnetMask) to allow"
            $value.subnetMask = $rule.subnetMask;
        }

        add-webconfiguration /system.webServer/security/ipSecurity -location $website -value $value -pspath IIS://
    }    
}

function clearRules([string]$website, [Object[]]$newRules, [Object[]]$oldRules) {

    foreach ($rule in $oldRules) {
        if (ruleExists $rule $newRules) {
            continue;
        }

        Write-Host "Rule $($rule.ipAddress)/$($rule.subnetMask) is not exists, remove it";

        Clear-WebConfiguration -Filter $rule.ItemXPath -location $rule.Location
    }    
}

function ruleExists([Object]$rule, [Object[]]$rules) {
    foreach ($r in $rules) {
        if ($r.ipAddress -eq $rule.ipAddress -and $r.allowed -eq $rule.allowed) {
            if ($r.subnetMask -eq $rule.subnetMask) {
                return $true;
            }

            if (([string]::IsNullOrEmpty($r.subnetMask) -or $r.subnetMask -eq "255.255.255.255") -and ([string]::IsNullOrEmpty($rule.subnetMask) -or $rule.subnetMask -eq "255.255.255.255")) {
                return $true;
            }
        }
    }

    return $false;
}

addRules $Site $newRules $existingRules;
clearRules $Site $newRules $existingRules;

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20IIS%20Website%20-%20Set%20IP%20Security&step-template=IIS%20Website%20-%20Set%20IP%20Security)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "2aab8e8b-6a55-462c-91ca-3c2a395e82a5",
  "Name": "IIS Website - Set IP Security",
  "Description": "Takes a list of ip/mask and allow them in ipsecurity",
  "Version": 10,
  "ExportedAt": "2021-03-01T11:24:20.680Z",
  "ActionType": "Octopus.Script",
  "Author": "olsh",
  "Parameters": [
    {
      "Id": "357e87c7-908c-4cdb-af63-8818cef5bd23",
      "Name": "Site",
      "Label": "Name of Website",
      "HelpText": null,
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "9db7ed01-c348-48ee-868b-ebcd0d87cce1",
      "Name": "IpAddresses",
      "Label": "List of ip addresses",
      "HelpText": "A newline separated list of IP addresses and/or IP address and subnet mask pairs in the format <IPAddress>/<SubnetMask>.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      },
      "Links": {}
    },
    {
      "Id": "2854ab2d-a000-48dd-9b20-6930c73c96fb",
      "Name": "EnableProxyMode",
      "Label": "Enable proxy mode",
      "HelpText": "If the website is running behind a proxy, this setting most likely need to be checked.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "7d8cc90e-281e-4718-a0e9-b1daa522d5c9",
      "Name": "SetDeny",
      "Label": "Set deny",
      "HelpText": "If checked, IIS will be changed to \"Deny\" all IP addresses not added to the list.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptBody": "$existingRules = Get-WebConfiguration /system.webServer/security/ipSecurity/* -location $Site -pspath IIS://;\n[Object[]]$newRules = @();\n\n$ips = $IpAddresses -split '\\n';\n$ips = $ips.Trim('\\r');\nforeach ($u in $ips) {\n    $a = $u.Split(\"/\");\n    $newRules += [Object]@{ ipAddress = $a[0]; subnetMask = $a[1]; allowed = $true };\n}\n\nif ($EnableProxyMode -eq \"true\") {\n    Write-Output \"Enabling proxy mode\"\n    set-webconfigurationproperty -Filter /system.webServer/security/ipSecurity -location $Site -Name \"enableProxyMode\" -Value \"true\"\n}\n\nif ($SetDeny -eq \"true\") {\n    Write-Output \"Setting Deny rule\"\n    set-webconfigurationproperty -Filter /system.webServer/security/ipSecurity -location $Site -Name \"allowUnlisted\" -Value \"false\"\n}\n\nfunction addRules([string]$website, [Object[]]$newRules, [Object[]]$oldRules) {\n\n    foreach ($rule in $newRules) {\n        if (ruleExists $rule $oldRules) {\n            Write-Host \"Rule $($rule.ipAddress)/$($rule.subnetMask) already exists\";\n\n            continue;\n        }\n\n        $value = @{ipAddress = $($rule.ipAddress); allowed = \"true\" }\n        if ([string]::IsNullOrEmpty($rule.subnetMask)) {\n            Write-Output \"Adding ip $($rule.ipAddress) to allow\"\n        }\n        else {\n            Write-Output \"Adding ip $($rule.ipAddress)/$($rule.subnetMask) to allow\"\n            $value.subnetMask = $rule.subnetMask;\n        }\n\n        add-webconfiguration /system.webServer/security/ipSecurity -location $website -value $value -pspath IIS://\n    }    \n}\n\nfunction clearRules([string]$website, [Object[]]$newRules, [Object[]]$oldRules) {\n\n    foreach ($rule in $oldRules) {\n        if (ruleExists $rule $newRules) {\n            continue;\n        }\n\n        Write-Host \"Rule $($rule.ipAddress)/$($rule.subnetMask) is not exists, remove it\";\n\n        Clear-WebConfiguration -Filter $rule.ItemXPath -location $rule.Location\n    }    \n}\n\nfunction ruleExists([Object]$rule, [Object[]]$rules) {\n    foreach ($r in $rules) {\n        if ($r.ipAddress -eq $rule.ipAddress -and $r.allowed -eq $rule.allowed) {\n            if ($r.subnetMask -eq $rule.subnetMask) {\n                return $true;\n            }\n\n            if (([string]::IsNullOrEmpty($r.subnetMask) -or $r.subnetMask -eq \"255.255.255.255\") -and ([string]::IsNullOrEmpty($rule.subnetMask) -or $rule.subnetMask -eq \"255.255.255.255\")) {\n                return $true;\n            }\n        }\n    }\n\n    return $false;\n}\n\naddRules $Site $newRules $existingRules;\nclearRules $Site $newRules $existingRules;\n",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-website-set-ip-security.json",
  "Website": "/step-templates/2aab8e8b-6a55-462c-91ca-3c2a395e82a5",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-website-set-ip-security.json)

</div>
