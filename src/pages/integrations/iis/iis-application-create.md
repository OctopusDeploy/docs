---
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
layout: src/layouts/Default.astro
pubDate: 2017-04-10
title: 'IIS Application - Create'
description: 'Create an IIS virtual application (a virtual directory with an application pool)'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
---

Octopus.Script exported 2017-04-10 by bobjwalker belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Virtual path

`VirtualPath = `

The name of the application to create. For example, to serve an application that will be available at `/myapp`, enter `myapp`. To create an application under a parent virtual directory or application, separate with slashes - for example: `/applications/myapp`

</div>
        
<div class="param">

### Physical path

`PhysicalPath = `

Physical folder that the application will serve files from. Example: `C:\MyApp`.

</div>
        
<div class="param">

### Parent site

`ParentSite = `

The name of the IIS web site to attach the application to. For example, to put the application under the default web site, enter:

    Default Web Site

</div>
        
<div class="param">

### Application pool

`ApplicationPoolName = `

The name of the application pool that the application will run under.

</div>
        
<div class="param">

### Protocols

`BindingProtocols = http`

The protocols to use for the application

</div>
        
<div class="param">

### Require SSL

`RequireSSL = False`

Web site SSL settings

</div>
        
<div class="param">

### Client certificate

`ClientCertificate = Ignore`

_(Require SSL)_ Defines how to handle client certificates if SSL is required.

</div>
        
<div class="param">

### Preload Enabled

`PreloadEnabled = False`

If true, sets the application to enable preloading.

</div>
        
<div class="param">

### Enable Anonymous authentication

`EnableAnonymous = False`

Whether IIS should allow anonymous authentication

</div>
        
<div class="param">

### Enable Basic authentication

`EnableBasic = False`

Whether IIS should allow basic authentication with a 401 challenge.

</div>
        
<div class="param">

### Enable Windows authentication

`EnableWindows = False`

Whether IIS should allow integrated Windows authentication with a 401 challenge.

</div>
        
<div class="param">

### Set Application Pool Settings

`SetApplicationPoolSettings = False`

If true, this will allow you to set the Application Pool CLR Version, identity using the .NET CLR Version, Identity, Username, and Password parameters.  If false, the other four parameters will be ignored.

</div>
        
<div class="param">

### Application Pool .NET CLR Version

`ApplicationPoolFrameworkVersion = v4.0`

The version of the .NET common language runtime that this application pool will use.

</div>
        
<div class="param">

### Application Pool Identity

`ApplicationPoolIdentityType = ApplicationPoolIdentity`

Which built-in account will the application pool run under.

</div>
        
<div class="param">

### Application Pool Username

`ApplicationPoolUsername = `

The Windows/domain account of the custom user that the application pool will run under. Example: YOURDOMAIN\\YourAccount. You will need to ensure that this user has permissions to run as an application pool.

</div>
        
<div class="param">

### Application Pool Password

`ApplicationPoolPassword = `

The password for the custom account given above.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
## --------------------------------------------------------------------------------------
## Input
## --------------------------------------------------------------------------------------

$virtualPath = $OctopusParameters['VirtualPath']
$physicalPath = $OctopusParameters['PhysicalPath']
$applicationPoolName = $OctopusParameters['ApplicationPoolName']
$setApplicationPoolSettings = [boolean]::Parse($OctopusParameters['SetApplicationPoolSettings'])
$appPoolFrameworkVersion = $OctopusParameters["ApplicationPoolFrameworkVersion"]
$applicationPoolIdentityType = $OctopusParameters["ApplicationPoolIdentityType"]
$applicationPoolUsername = $OctopusParameters["ApplicationPoolUsername"]
$applicationPoolPassword = $OctopusParameters["ApplicationPoolPassword"]

$parentSite = $OctopusParameters['ParentSite']
$bindingProtocols = $OctopusParameters['BindingProtocols']
$authentication = $OctopusParameters['AuthenticationType']
$requireSSL = $OctopusParameters['RequireSSL']
$clientCertificate = $OctopusParameters['ClientCertificate']

$preloadEnabled = [boolean]::Parse($OctopusParameters['PreloadEnabled'])
$enableAnonymous = [boolean]::Parse($OctopusParameters['EnableAnonymous'])
$enableBasic = [boolean]::Parse($OctopusParameters['EnableBasic'])
$enableWindows = [boolean]::Parse($OctopusParameters['EnableWindows'])

## --------------------------------------------------------------------------------------
## Helpers
## --------------------------------------------------------------------------------------
# Helper for validating input parameters
function Validate-Parameter($foo, [string[]]$validInput, $parameterName) {
    Write-Host "${parameterName}: ${foo}"
    if (! $foo) {
        throw "$parameterName cannot be empty, please specify a value"
    }
    
    if ($validInput) {
        @($foo) | % { 
                if ($validInput -notcontains $_) {
                    throw "'$_' is not a valid input for '$parameterName'"
                }
             }  
        }   
}

# Helper to run a block with a retry if things go wrong
$maxFailures = 5
$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4
function Execute-WithRetry([ScriptBlock] $command) {
    $attemptCount = 0
    $operationIncomplete = $true

    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {
        $attemptCount = ($attemptCount + 1)

        if ($attemptCount -ge 2) {
            Write-Output "Waiting for $sleepBetweenFailures seconds before retrying..."
            Start-Sleep -s $sleepBetweenFailures
            Write-Output "Retrying..."
        }

        try {
            & $command

            $operationIncomplete = $false
        } catch [System.Exception] {
            if ($attemptCount -lt ($maxFailures)) {
                Write-Output ("Attempt $attemptCount of $maxFailures failed: " + $_.Exception.Message)
            
            }
            else {
                throw "Failed to execute command"
            }
        }
    }
}

## --------------------------------------------------------------------------------------
## Configuration
## --------------------------------------------------------------------------------------
Validate-Parameter $virtualPath -parameterName "Virtual path"
Validate-Parameter $physicalPath -parameterName "Physical path"
Validate-Parameter $applicationPoolName -parameterName "Application pool"
Validate-Parameter $parentSite -parameterName "Parent site"


Add-PSSnapin WebAdministration -ErrorAction SilentlyContinue
Import-Module WebAdministration -ErrorAction SilentlyContinue


## --------------------------------------------------------------------------------------
## Run
## --------------------------------------------------------------------------------------

Write-Host "Getting web site $parentSite"
# Workaround to bug in Get-WebSite cmdlet which would return all sites
# See http://forums.iis.net/p/1167298/1943273.aspx / http://stackoverflow.com/a/6832577/785750
$site = Get-WebSite  | where { $_.Name -eq $parentSite }
if (!$site) {
    throw "The web site '$parentSite' does not exist. Please create the site first."
}

$path = $site.PhysicalPath;
$parts = $virtualPath -split "[/\\]"
$name = ""

for ($i = 0; $i -lt $parts.Length; $i++) {
    $name = $name + "/" + $parts[$i]
    $name = $name.TrimStart('/').TrimEnd('/')
    if ($i -eq $parts.Length - 1) {
        
    }
    elseif ([string]::IsNullOrEmpty($name) -eq $false -and $name -ne "") {
        Write-Host "Ensuring parent exists: $name"
        
        $path = [IO.Path]::Combine($path, $parts[$i])
        $app = Get-WebApplication -Name $name -Site $parentSite

        if (!$app) {
            $vdir = Get-WebVirtualDirectory -Name $name -site $parentSite
            if (!$vdir) {
                Write-Verbose "The application or virtual directory '$name' does not exist"
                if([IO.Directory]::Exists([System.Environment]::ExpandEnvironmentVariables($path)) -eq $true)
                {
                    Write-Verbose "Using physical path '$path' as parent"
                }
                else
                {
                    throw "Failed to ensure parent"
                }
            }
            else
            {
                $path = $vdir.PhysicalPath
            }
        }
        else
        {
            $path = $app.PhysicalPath
        }
    }
}

$existing = Get-WebApplication -site $parentSite -Name $name

# Set App Pool
Execute-WithRetry { 
	Write-Verbose "Loading Application pool"
	$pool = Get-Item "IIS:\AppPools\$ApplicationPoolName" -ErrorAction SilentlyContinue
	if (!$pool) { 
		Write-Host "Application pool `"$ApplicationPoolName`" does not exist, creating..." 
		new-item "IIS:\AppPools\$ApplicationPoolName" -confirm:$false
		$pool = Get-Item "IIS:\AppPools\$ApplicationPoolName"
	} else {
		Write-Host "Application pool `"$ApplicationPoolName`" already exists"
	}
}

# Set App Pool Identity
Execute-WithRetry { 
	if($setApplicationPoolSettings)
    {
        Write-Host "Set application pool identity: $applicationPoolIdentityType"
        if ($applicationPoolIdentityType -eq "SpecificUser") {
            Set-ItemProperty "IIS:\AppPools\$ApplicationPoolName" -name processModel -value @{identitytype="SpecificUser"; username="$applicationPoolUsername"; password="$applicationPoolPassword"}
        } else {
            Set-ItemProperty "IIS:\AppPools\$ApplicationPoolName" -name processModel -value @{identitytype="$applicationPoolIdentityType"}
        }
    }
}

# Set .NET Framework
Execute-WithRetry { 
    if($setApplicationPoolSettings)
    {
        Write-Host "Set .NET framework version: $appPoolFrameworkVersion" 
        if($appPoolFrameworkVersion -eq "No Managed Code")
        {
            Set-ItemProperty "IIS:\AppPools\$ApplicationPoolName" managedRuntimeVersion ""
        }
        else
        {
            Set-ItemProperty "IIS:\AppPools\$ApplicationPoolName" managedRuntimeVersion $appPoolFrameworkVersion
        }
    }
}

Execute-WithRetry { 
    ## Check if the physical path exits
    if(!(Test-Path -Path $physicalPath)) {
        Write-Host "Creating physical path '$physicalPath'"
        New-Item -ItemType directory -Path $physicalPath
    }

    if (!$existing) {
        Write-Host "Creating web application '$name'"
        New-WebApplication -Site $parentSite -Name $name -ApplicationPool $applicationPoolName -PhysicalPath $physicalPath
        Write-Host "Web application created"
    } else {
        Write-Host "The web application '$name' already exists. Updating physical path:"

        Set-ItemProperty IIS:\\Sites\\$parentSite\\$name -name physicalPath -value $physicalPath
        Write-Host "Physical path changed to: $physicalPath"

        Set-ItemProperty IIS:\\Sites\\$parentSite\\$name -Name applicationPool -Value $applicationPoolName
        Write-Output "ApplicationPool changed to: $applicationPoolName"
    }
    
    Write-Host "Enabling '$bindingProtocols' protocols"
    Set-ItemProperty IIS:\\Sites\\$parentSite\\$name -name enabledProtocols -value $bindingProtocols

    $enabledIisAuthenticationOptions = $Authentication -split '\\s*[,;]\\s*'

    try {

    Execute-WithRetry { 
        Write-Output "Anonymous authentication enabled: $enableAnonymous"
        Set-WebConfigurationProperty -filter /system.webServer/security/authentication/anonymousAuthentication -name enabled -value "$enableAnonymous" -PSPath IIS:\\ -location $parentSite/$virtualPath
    }    
    
    Execute-WithRetry { 
        Write-Output "Windows authentication enabled: $enableWindows"
        Set-WebConfigurationProperty -filter /system.WebServer/security/authentication/windowsAuthentication -name enabled -value "$enableWindows" -PSPath IIS:\\ -location $parentSite/$virtualPath
    }

    Execute-WithRetry { 
        Write-Output "Basic authentication enabled: $enableBasic"
        Set-WebConfigurationProperty -filter /system.webServer/security/authentication/basicAuthentication -name enabled -value "$enableBasic" -PSPath IIS:\\ -location $parentSite/$virtualPath
    }

    } catch [System.Exception] {
        Write-Output "Authentication options could not be set. This can happen when there is a problem with your application's web.config. For example, you might be using a section that requires an extension that is not installed on this web server (such as URL Rewriting). It can also happen when you have selected an authentication option and the appropriate IIS module is not installed (for example, for Windows authentication, you need to enable the Windows Authentication module in IIS/Windows first)"
        throw
    }

    Set-WebConfiguration -value "None" -filter "system.webserver/security/access" -location $parentSite/$virtualPath -PSPath IIS:\\ 
    if ($requireSSL -ieq "True")
    {
        Write-Output "Require SSL enabled: $requireSSL"
        Set-WebConfiguration -value "Ssl" -filter "system.webserver/security/access" -location $parentSite/$virtualPath -PSPath IIS:\\ 
        Write-Output "Client certificate mode: $clientCertificate"
        if ($clientCertificate -ieq "Accept") {
           Set-WebConfigurationProperty -filter "system.webServer/security/access" -location $parentSite/$virtualPath -PSPath IIS:\\ -name "sslFlags" -value "Ssl,SslNegotiateCert"
        }
        if ($clientCertificate -ieq "Require") {
           Set-WebConfigurationProperty -filter "system.webServer/security/access" -location $parentSite/$virtualPath -PSPath IIS:\\ -name "sslFlags" -value "Ssl,SslNegotiateCert,SslRequireCert"
        }
    }
    
    try {
        Set-ItemProperty IIS:\\Sites\\$parentSite\\$name -name preloadEnabled -value $preloadEnabled
        Write-Output "Preload Enabled: $preloadEnabled"
    } catch [System.Exception] {
       if ($preloadEnabled) {
            Write-Output "Preload Enabled: $preloadEnabled Could not be set. You may to install the Application Initialization feature"
            throw
       }
    }
}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20IIS%20Application%20-%20Create&step-template=IIS%20Application%20-%20Create)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "5b3e7576-44f8-4852-ae09-a45bd985c549",
  "Name": "IIS Application - Create",
  "Description": "Create an IIS virtual application (a virtual directory with an application pool)",
  "Version": 37,
  "ExportedAt": "2017-04-10T15:13:10.653Z",
  "ActionType": "Octopus.Script",
  "Author": "bobjwalker",
  "Parameters": [
    {
      "Id": "679da415-996c-4ad3-87d5-bb8ce4e1f8d0",
      "Name": "VirtualPath",
      "Label": "Virtual path",
      "HelpText": "The name of the application to create. For example, to serve an application that will be available at `/myapp`, enter `myapp`. To create an application under a parent virtual directory or application, separate with slashes - for example: `/applications/myapp`",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "3eecef84-fe72-4efc-98bf-42aa41a2d488",
      "Name": "PhysicalPath",
      "Label": "Physical path",
      "HelpText": "Physical folder that the application will serve files from. Example: `C:\\MyApp`.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "f2b3a7ef-4d83-4692-a328-fc18cb85fd3e",
      "Name": "ParentSite",
      "Label": "Parent site",
      "HelpText": "The name of the IIS web site to attach the application to. For example, to put the application under the default web site, enter:\n\n    Default Web Site",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "3cb9971e-a7f2-47e7-8201-fb25c3080bd0",
      "Name": "ApplicationPoolName",
      "Label": "Application pool",
      "HelpText": "The name of the application pool that the application will run under.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "2a5d18bf-50ad-43c4-882b-9314ee2551b4",
      "Name": "BindingProtocols",
      "Label": "Protocols",
      "HelpText": "The protocols to use for the application",
      "DefaultValue": "http",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "07d979ef-c343-4c9c-8681-d3c06f451539",
      "Name": "RequireSSL",
      "Label": "Require SSL",
      "HelpText": "Web site SSL settings",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "3a3a8fe8-9fb0-4db5-85c9-04141f33f32d",
      "Name": "ClientCertificate",
      "Label": "Client certificate",
      "HelpText": "_(Require SSL)_ Defines how to handle client certificates if SSL is required.",
      "DefaultValue": "Ignore",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "Ignore\nAccept\nRequire"
      },
      "Links": {}
    },
    {
      "Id": "174299e5-38dc-4fe9-b25a-6a5bdad05b34",
      "Name": "PreloadEnabled",
      "Label": "Preload Enabled",
      "HelpText": "If true, sets the application to enable preloading.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "1641d3e2-a1e5-4933-b993-6528f1764557",
      "Name": "EnableAnonymous",
      "Label": "Enable Anonymous authentication",
      "HelpText": "Whether IIS should allow anonymous authentication",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "3a52b977-3ea6-482b-8e55-62efd0198b14",
      "Name": "EnableBasic",
      "Label": "Enable Basic authentication",
      "HelpText": "Whether IIS should allow basic authentication with a 401 challenge.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "085a3183-30bc-499e-90bf-9b5bcdf0842a",
      "Name": "EnableWindows",
      "Label": "Enable Windows authentication",
      "HelpText": "Whether IIS should allow integrated Windows authentication with a 401 challenge.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "de7b8dee-bf5a-48ea-99bc-f5b86fcdf118",
      "Name": "SetApplicationPoolSettings",
      "Label": "Set Application Pool Settings",
      "HelpText": "If true, this will allow you to set the Application Pool CLR Version, identity using the .NET CLR Version, Identity, Username, and Password parameters.  If false, the other four parameters will be ignored.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "dd301881-0cd6-40bf-98b4-36e13a587fe2",
      "Name": "ApplicationPoolFrameworkVersion",
      "Label": "Application Pool .NET CLR Version",
      "HelpText": "The version of the .NET common language runtime that this application pool will use.",
      "DefaultValue": "v4.0",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "v2.0|CLR v2.0 (.NET 2.0, 3.0, 3.5)\nv4.0|CLR v4.0 (.NET 4.0, 4.5, 4.6)\nNo Managed Code"
      },
      "Links": {}
    },
    {
      "Id": "92cb9de4-f65f-4855-bc88-d89e6a748f3c",
      "Name": "ApplicationPoolIdentityType",
      "Label": "Application Pool Identity",
      "HelpText": "Which built-in account will the application pool run under.",
      "DefaultValue": "ApplicationPoolIdentity",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "ApplicationPoolIdentity|Application Pool Identity\nLocalService|Local Service\nLocalSystem|Local System\nNetworkService|Network Service\nSpecificUser|Custom user ..."
      },
      "Links": {}
    },
    {
      "Id": "7cbeec84-7fad-46dd-98de-ed61531f8bb3",
      "Name": "ApplicationPoolUsername",
      "Label": "Application Pool Username",
      "HelpText": "The Windows/domain account of the custom user that the application pool will run under. Example: YOURDOMAIN\\\\YourAccount. You will need to ensure that this user has permissions to run as an application pool.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "748a99a2-a9f4-46b2-b9b5-283a864171d3",
      "Name": "ApplicationPoolPassword",
      "Label": "Application Pool Password",
      "HelpText": "The password for the custom account given above.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      },
      "Links": {}
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "## --------------------------------------------------------------------------------------\n## Input\n## --------------------------------------------------------------------------------------\n\n$virtualPath = $OctopusParameters['VirtualPath']\n$physicalPath = $OctopusParameters['PhysicalPath']\n$applicationPoolName = $OctopusParameters['ApplicationPoolName']\n$setApplicationPoolSettings = [boolean]::Parse($OctopusParameters['SetApplicationPoolSettings'])\n$appPoolFrameworkVersion = $OctopusParameters[\"ApplicationPoolFrameworkVersion\"]\n$applicationPoolIdentityType = $OctopusParameters[\"ApplicationPoolIdentityType\"]\n$applicationPoolUsername = $OctopusParameters[\"ApplicationPoolUsername\"]\n$applicationPoolPassword = $OctopusParameters[\"ApplicationPoolPassword\"]\n\n$parentSite = $OctopusParameters['ParentSite']\n$bindingProtocols = $OctopusParameters['BindingProtocols']\n$authentication = $OctopusParameters['AuthenticationType']\n$requireSSL = $OctopusParameters['RequireSSL']\n$clientCertificate = $OctopusParameters['ClientCertificate']\n\n$preloadEnabled = [boolean]::Parse($OctopusParameters['PreloadEnabled'])\n$enableAnonymous = [boolean]::Parse($OctopusParameters['EnableAnonymous'])\n$enableBasic = [boolean]::Parse($OctopusParameters['EnableBasic'])\n$enableWindows = [boolean]::Parse($OctopusParameters['EnableWindows'])\n\n## --------------------------------------------------------------------------------------\n## Helpers\n## --------------------------------------------------------------------------------------\n# Helper for validating input parameters\nfunction Validate-Parameter($foo, [string[]]$validInput, $parameterName) {\n    Write-Host \"${parameterName}: ${foo}\"\n    if (! $foo) {\n        throw \"$parameterName cannot be empty, please specify a value\"\n    }\n    \n    if ($validInput) {\n        @($foo) | % { \n                if ($validInput -notcontains $_) {\n                    throw \"'$_' is not a valid input for '$parameterName'\"\n                }\n             }  \n        }   \n}\n\n# Helper to run a block with a retry if things go wrong\n$maxFailures = 5\n$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4\nfunction Execute-WithRetry([ScriptBlock] $command) {\n    $attemptCount = 0\n    $operationIncomplete = $true\n\n    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {\n        $attemptCount = ($attemptCount + 1)\n\n        if ($attemptCount -ge 2) {\n            Write-Output \"Waiting for $sleepBetweenFailures seconds before retrying...\"\n            Start-Sleep -s $sleepBetweenFailures\n            Write-Output \"Retrying...\"\n        }\n\n        try {\n            & $command\n\n            $operationIncomplete = $false\n        } catch [System.Exception] {\n            if ($attemptCount -lt ($maxFailures)) {\n                Write-Output (\"Attempt $attemptCount of $maxFailures failed: \" + $_.Exception.Message)\n            \n            }\n            else {\n                throw \"Failed to execute command\"\n            }\n        }\n    }\n}\n\n## --------------------------------------------------------------------------------------\n## Configuration\n## --------------------------------------------------------------------------------------\nValidate-Parameter $virtualPath -parameterName \"Virtual path\"\nValidate-Parameter $physicalPath -parameterName \"Physical path\"\nValidate-Parameter $applicationPoolName -parameterName \"Application pool\"\nValidate-Parameter $parentSite -parameterName \"Parent site\"\n\n\nAdd-PSSnapin WebAdministration -ErrorAction SilentlyContinue\nImport-Module WebAdministration -ErrorAction SilentlyContinue\n\n\n## --------------------------------------------------------------------------------------\n## Run\n## --------------------------------------------------------------------------------------\n\nWrite-Host \"Getting web site $parentSite\"\n# Workaround to bug in Get-WebSite cmdlet which would return all sites\n# See http://forums.iis.net/p/1167298/1943273.aspx / http://stackoverflow.com/a/6832577/785750\n$site = Get-WebSite  | where { $_.Name -eq $parentSite }\nif (!$site) {\n    throw \"The web site '$parentSite' does not exist. Please create the site first.\"\n}\n\n$path = $site.PhysicalPath;\n$parts = $virtualPath -split \"[/\\\\]\"\n$name = \"\"\n\nfor ($i = 0; $i -lt $parts.Length; $i++) {\n    $name = $name + \"/\" + $parts[$i]\n    $name = $name.TrimStart('/').TrimEnd('/')\n    if ($i -eq $parts.Length - 1) {\n        \n    }\n    elseif ([string]::IsNullOrEmpty($name) -eq $false -and $name -ne \"\") {\n        Write-Host \"Ensuring parent exists: $name\"\n        \n        $path = [IO.Path]::Combine($path, $parts[$i])\n        $app = Get-WebApplication -Name $name -Site $parentSite\n\n        if (!$app) {\n            $vdir = Get-WebVirtualDirectory -Name $name -site $parentSite\n            if (!$vdir) {\n                Write-Verbose \"The application or virtual directory '$name' does not exist\"\n                if([IO.Directory]::Exists([System.Environment]::ExpandEnvironmentVariables($path)) -eq $true)\n                {\n                    Write-Verbose \"Using physical path '$path' as parent\"\n                }\n                else\n                {\n                    throw \"Failed to ensure parent\"\n                }\n            }\n            else\n            {\n                $path = $vdir.PhysicalPath\n            }\n        }\n        else\n        {\n            $path = $app.PhysicalPath\n        }\n    }\n}\n\n$existing = Get-WebApplication -site $parentSite -Name $name\n\n# Set App Pool\nExecute-WithRetry { \n\tWrite-Verbose \"Loading Application pool\"\n\t$pool = Get-Item \"IIS:\\AppPools\\$ApplicationPoolName\" -ErrorAction SilentlyContinue\n\tif (!$pool) { \n\t\tWrite-Host \"Application pool `\"$ApplicationPoolName`\" does not exist, creating...\" \n\t\tnew-item \"IIS:\\AppPools\\$ApplicationPoolName\" -confirm:$false\n\t\t$pool = Get-Item \"IIS:\\AppPools\\$ApplicationPoolName\"\n\t} else {\n\t\tWrite-Host \"Application pool `\"$ApplicationPoolName`\" already exists\"\n\t}\n}\n\n# Set App Pool Identity\nExecute-WithRetry { \n\tif($setApplicationPoolSettings)\n    {\n        Write-Host \"Set application pool identity: $applicationPoolIdentityType\"\n        if ($applicationPoolIdentityType -eq \"SpecificUser\") {\n            Set-ItemProperty \"IIS:\\AppPools\\$ApplicationPoolName\" -name processModel -value @{identitytype=\"SpecificUser\"; username=\"$applicationPoolUsername\"; password=\"$applicationPoolPassword\"}\n        } else {\n            Set-ItemProperty \"IIS:\\AppPools\\$ApplicationPoolName\" -name processModel -value @{identitytype=\"$applicationPoolIdentityType\"}\n        }\n    }\n}\n\n# Set .NET Framework\nExecute-WithRetry { \n    if($setApplicationPoolSettings)\n    {\n        Write-Host \"Set .NET framework version: $appPoolFrameworkVersion\" \n        if($appPoolFrameworkVersion -eq \"No Managed Code\")\n        {\n            Set-ItemProperty \"IIS:\\AppPools\\$ApplicationPoolName\" managedRuntimeVersion \"\"\n        }\n        else\n        {\n            Set-ItemProperty \"IIS:\\AppPools\\$ApplicationPoolName\" managedRuntimeVersion $appPoolFrameworkVersion\n        }\n    }\n}\n\nExecute-WithRetry { \n    ## Check if the physical path exits\n    if(!(Test-Path -Path $physicalPath)) {\n        Write-Host \"Creating physical path '$physicalPath'\"\n        New-Item -ItemType directory -Path $physicalPath\n    }\n\n    if (!$existing) {\n        Write-Host \"Creating web application '$name'\"\n        New-WebApplication -Site $parentSite -Name $name -ApplicationPool $applicationPoolName -PhysicalPath $physicalPath\n        Write-Host \"Web application created\"\n    } else {\n        Write-Host \"The web application '$name' already exists. Updating physical path:\"\n\n        Set-ItemProperty IIS:\\\\Sites\\\\$parentSite\\\\$name -name physicalPath -value $physicalPath\n        Write-Host \"Physical path changed to: $physicalPath\"\n\n        Set-ItemProperty IIS:\\\\Sites\\\\$parentSite\\\\$name -Name applicationPool -Value $applicationPoolName\n        Write-Output \"ApplicationPool changed to: $applicationPoolName\"\n    }\n    \n    Write-Host \"Enabling '$bindingProtocols' protocols\"\n    Set-ItemProperty IIS:\\\\Sites\\\\$parentSite\\\\$name -name enabledProtocols -value $bindingProtocols\n\n    $enabledIisAuthenticationOptions = $Authentication -split '\\\\s*[,;]\\\\s*'\n\n    try {\n\n    Execute-WithRetry { \n        Write-Output \"Anonymous authentication enabled: $enableAnonymous\"\n        Set-WebConfigurationProperty -filter /system.webServer/security/authentication/anonymousAuthentication -name enabled -value \"$enableAnonymous\" -PSPath IIS:\\\\ -location $parentSite/$virtualPath\n    }    \n    \n    Execute-WithRetry { \n        Write-Output \"Windows authentication enabled: $enableWindows\"\n        Set-WebConfigurationProperty -filter /system.WebServer/security/authentication/windowsAuthentication -name enabled -value \"$enableWindows\" -PSPath IIS:\\\\ -location $parentSite/$virtualPath\n    }\n\n    Execute-WithRetry { \n        Write-Output \"Basic authentication enabled: $enableBasic\"\n        Set-WebConfigurationProperty -filter /system.webServer/security/authentication/basicAuthentication -name enabled -value \"$enableBasic\" -PSPath IIS:\\\\ -location $parentSite/$virtualPath\n    }\n\n    } catch [System.Exception] {\n        Write-Output \"Authentication options could not be set. This can happen when there is a problem with your application's web.config. For example, you might be using a section that requires an extension that is not installed on this web server (such as URL Rewriting). It can also happen when you have selected an authentication option and the appropriate IIS module is not installed (for example, for Windows authentication, you need to enable the Windows Authentication module in IIS/Windows first)\"\n        throw\n    }\n\n    Set-WebConfiguration -value \"None\" -filter \"system.webserver/security/access\" -location $parentSite/$virtualPath -PSPath IIS:\\\\ \n    if ($requireSSL -ieq \"True\")\n    {\n        Write-Output \"Require SSL enabled: $requireSSL\"\n        Set-WebConfiguration -value \"Ssl\" -filter \"system.webserver/security/access\" -location $parentSite/$virtualPath -PSPath IIS:\\\\ \n        Write-Output \"Client certificate mode: $clientCertificate\"\n        if ($clientCertificate -ieq \"Accept\") {\n           Set-WebConfigurationProperty -filter \"system.webServer/security/access\" -location $parentSite/$virtualPath -PSPath IIS:\\\\ -name \"sslFlags\" -value \"Ssl,SslNegotiateCert\"\n        }\n        if ($clientCertificate -ieq \"Require\") {\n           Set-WebConfigurationProperty -filter \"system.webServer/security/access\" -location $parentSite/$virtualPath -PSPath IIS:\\\\ -name \"sslFlags\" -value \"Ssl,SslNegotiateCert,SslRequireCert\"\n        }\n    }\n    \n    try {\n        Set-ItemProperty IIS:\\\\Sites\\\\$parentSite\\\\$name -name preloadEnabled -value $preloadEnabled\n        Write-Output \"Preload Enabled: $preloadEnabled\"\n    } catch [System.Exception] {\n       if ($preloadEnabled) {\n            Write-Output \"Preload Enabled: $preloadEnabled Could not be set. You may to install the Application Initialization feature\"\n            throw\n       }\n    }\n}\n",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-app-create.json",
  "Website": "/step-templates/5b3e7576-44f8-4852-ae09-a45bd985c549",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-app-create.json)

</div>
