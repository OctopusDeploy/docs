---
layout: src/layouts/Default.astro
pubDate: 2019-09-14
title: 'IIS - Add CCS HTTPS bindings based on HTTP bindings'
description: 'Add IIS Centralized Certificate Store (CCS) SSL bindings to a website based on HTTP bindings (binds to same IP and hostname but different port and protocol).

This is used to enable CCS on IIS websites created with the normal Octopus IIS website creation step.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2019-09-14 by bobjwalker belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Website Name

`IisCcsWebSiteName = `

Name of the website, can be retrieved from a IIS website deployment step: `#{Octopus.Action[*].IISWebSite.WebSiteName}`.

</div>
        
<div class="param">

### Enable SNI

`IisCcsSNI = true`

Enable SNI for the binding(s), default is enabled.

</div>
        
<div class="param">

### Port mapping

`IisCcsPortMap = 80:443`

Mapping of HTTP to HTTPS ports as list of integer parts. Default is `80:443` (multiple mappings may be added, separated by spaces).

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
$WebSiteName = $OctopusParameters['IisCcsWebSiteName'];
[bool]$SNI = $false;
if (-not [bool]::TryParse($OctopusParameters['IisCcsSNI'], [ref]$SNI)) {
    $SNI = $true;
}
$SslFlags = 2; # Use CCS
if ($SNI) {
	$SslFlags = 3; # Use SNI CCS
}
$PortMap = [System.Collections.Generic.Dictionary[int,int]]::new();
foreach ($mapping in [regex]::Matches($OctopusParameters['IisCcsPortMap'],"([0-9]+):([0-9]+)")) {
    $PortMap.Add([int]$mapping.Groups[1].Value, [int]$mapping.Groups[2].Value);
}
$httpBindings = Get-WebBinding -Name $WebSiteName -Protocol http | Foreach-Object { $_.bindingInformation };
if (-not $httpBindings) {
    Write-Error "The site $WebSiteName does not exist, or it has not HTTP binding"
}
foreach ($binding in (Get-WebBinding -Name $WebSiteName -Protocol http | Foreach-Object { $_.bindingInformation })) {
    $parts = $binding.Split(":");
    $IPAddress = $parts[0];
    $HostHeader = $parts[2];
    [int]$Port = 0;
    if ([string]::IsNullOrEmpty($HostHeader)) {
        Write-Warning "The binding $binding has no hostname, skipping";
    } elseif (-not $PortMap.TryGetValue([int]$parts[1], [ref]$Port)) {
        Write-Warning "There is no port mapping for the binding $binding, skipping";
    } else {
        Write-Verbose "Binding HTTP $binding to HTTPS $($IPAddress):$($Port):$($HostHeader)";
        $existingBinding = Get-WebBinding -Name $WebSiteName -Protocol https -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader;
        if ($existingBinding) {
            if ($existingBinding.sslFlags -ne $SslFlags) {
                Write-Host "Change SSL flags of binding $($IPAddress):$($Port):$($HostHeader)";
                Set-WebBinding -Name $WebSiteName -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader -PropertyName SslFlags -Value $SslFlags;
            }
        } else {
            Write-Host "Create HTTPS binding $($IPAddress):$($Port):$($HostHeader)";
            New-WebBinding -Name $WebSiteName -Protocol https -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader -SslFlags $SslFlags;
        }
    }
}
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20IIS%20-%20Add%20CCS%20HTTPS%20bindings%20based%20on%20HTTP%20bindings&step-template=IIS%20-%20Add%20CCS%20HTTPS%20bindings%20based%20on%20HTTP%20bindings)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "0f21bd9a-2dea-4432-a1a1-2dee302ca418",
  "Name": "IIS - Add CCS HTTPS bindings based on HTTP bindings",
  "Description": "Add IIS Centralized Certificate Store (CCS) SSL bindings to a website based on HTTP bindings (binds to same IP and hostname but different port and protocol).\n\nThis is used to enable CCS on IIS websites created with the normal Octopus IIS website creation step.",
  "Version": 2,
  "ExportedAt": "2019-09-14T22:53:52.793Z",
  "ActionType": "Octopus.Script",
  "Author": "bobjwalker",
  "Packages": [],
  "Parameters": [
    {
      "Id": "e17b143f-d26c-458b-be41-6afca9e2666f",
      "Name": "IisCcsWebSiteName",
      "Label": "Website Name",
      "HelpText": "Name of the website, can be retrieved from a IIS website deployment step: `#{Octopus.Action[*].IISWebSite.WebSiteName}`.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": "de1633dd-5dcd-4d8f-8c69-d031a6b32434",
      "Name": "IisCcsSNI",
      "Label": "Enable SNI",
      "HelpText": "Enable SNI for the binding(s), default is enabled.",
      "DefaultValue": "true",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Id": "e6faf04c-441b-4ef2-8ad6-2ce0b4dc93df",
      "Name": "IisCcsPortMap",
      "Label": "Port mapping",
      "HelpText": "Mapping of HTTP to HTTPS ports as list of integer parts. Default is `80:443` (multiple mappings may be added, separated by spaces).",
      "DefaultValue": "80:443",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptBody": "$WebSiteName = $OctopusParameters['IisCcsWebSiteName'];\n[bool]$SNI = $false;\nif (-not [bool]::TryParse($OctopusParameters['IisCcsSNI'], [ref]$SNI)) {\n    $SNI = $true;\n}\n$SslFlags = 2; # Use CCS\nif ($SNI) {\n\t$SslFlags = 3; # Use SNI CCS\n}\n$PortMap = [System.Collections.Generic.Dictionary[int,int]]::new();\nforeach ($mapping in [regex]::Matches($OctopusParameters['IisCcsPortMap'],\"([0-9]+):([0-9]+)\")) {\n    $PortMap.Add([int]$mapping.Groups[1].Value, [int]$mapping.Groups[2].Value);\n}\n$httpBindings = Get-WebBinding -Name $WebSiteName -Protocol http | Foreach-Object { $_.bindingInformation };\nif (-not $httpBindings) {\n    Write-Error \"The site $WebSiteName does not exist, or it has not HTTP binding\"\n}\nforeach ($binding in (Get-WebBinding -Name $WebSiteName -Protocol http | Foreach-Object { $_.bindingInformation })) {\n    $parts = $binding.Split(\":\");\n    $IPAddress = $parts[0];\n    $HostHeader = $parts[2];\n    [int]$Port = 0;\n    if ([string]::IsNullOrEmpty($HostHeader)) {\n        Write-Warning \"The binding $binding has no hostname, skipping\";\n    } elseif (-not $PortMap.TryGetValue([int]$parts[1], [ref]$Port)) {\n        Write-Warning \"There is no port mapping for the binding $binding, skipping\";\n    } else {\n        Write-Verbose \"Binding HTTP $binding to HTTPS $($IPAddress):$($Port):$($HostHeader)\";\n        $existingBinding = Get-WebBinding -Name $WebSiteName -Protocol https -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader;\n        if ($existingBinding) {\n            if ($existingBinding.sslFlags -ne $SslFlags) {\n                Write-Host \"Change SSL flags of binding $($IPAddress):$($Port):$($HostHeader)\";\n                Set-WebBinding -Name $WebSiteName -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader -PropertyName SslFlags -Value $SslFlags;\n            }\n        } else {\n            Write-Host \"Create HTTPS binding $($IPAddress):$($Port):$($HostHeader)\";\n            New-WebBinding -Name $WebSiteName -Protocol https -IPAddress $IPAddress -Port $Port -HostHeader $HostHeader -SslFlags $SslFlags;\n        }\n    }\n}"
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-bindings-enable-ssl-ccs.json",
  "Website": "/step-templates/0f21bd9a-2dea-4432-a1a1-2dee302ca418",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-bindings-enable-ssl-ccs.json)

</div>
