---
layout: src/layouts/Default.astro
pubDate: 2016-05-27
title: 'Explicitly Add IIS WindowsAuthentication Providers'
description: 'Clears the WindowsAuthentication Providers, and explicitly adds the ones provided.'
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2016-05-27 by KShanafelt belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Add Windows Authentication Providers

`add-windows-authentication-providers.is-enabled = True`

If enabled, This step will clear the Windows Authentication Providers, and then add the ones listed in the
    Windows Authentication Providers
field.

</div>
        
<div class="param">

### Web Site name

`add-windows-authentication-providers.website-name`

The display name of the IIS web site to add Windows Authentication providers to.

</div>
        
<div class="param">

### Windows Authentication Providers

`add-windows-authentication-providers.providers`

A comma- or newline-separated list of Windows Authentication Providers to add.

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```PowerShell
## --------------------------------------------------------------------------------------
## Configuration
## --------------------------------------------------------------------------------------

$isEnabled = $OctopusParameters["add-windows-authentication-providers.is-enabled"]
if (!$isEnabled -or ![boolean]::Parse($isEnabled))
{
   exit 0
}

try {
    Add-PSSnapin WebAdministration
} catch {
    try {
        Import-Module WebAdministration
    } catch {
		Write-Warning "We failed to load the WebAdministration module. This usually resolved by doing one of the following:"
		Write-Warning "1. Install .NET Framework 3.5.1"
		Write-Warning "2. Upgrade to PowerShell 3.0 (or greater)"
        throw ($error | Select-Object -First 1)
    }
}

$webSiteName = $OctopusParameters["add-windows-authentication-providers.website-name"]
$providersString = $OctopusParameters["add-windows-authentication-providers.providers"]
$providers = ($providersString.Split("`r`n,") | % {$_.Trim() } | ? {$_})

## --------------------------------------------------------------------------------------
## Helpers
## --------------------------------------------------------------------------------------
$maxFailures = 5
$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4
function Execute-WithRetry([ScriptBlock] $command) {
    $attemptCount = 0
    $operationIncomplete = $true

    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {
        $attemptCount = ($attemptCount + 1)

        if ($attemptCount -ge 2) {
            Write-Output "Waiting for $sleepBetweenFailures seconds before retrying..."
            Start-Sleep -s $sleepBetweenFailures
            Write-Output "Retrying..."
        }

        try {
            & $command

            $operationIncomplete = $false
        } catch [System.Exception] {
            if ($attemptCount -lt ($maxFailures)) {
                Write-Output ("Attempt $attemptCount of $maxFailures failed: " + $_.Exception.Message)
            }
            else {
                throw "Failed to execute command"
            }
        }
    }
}

## --------------------------------------------------------------------------------------
## Run
## --------------------------------------------------------------------------------------
Execute-WithRetry { 
    Write-Host "Clearing Windows Authentication Providers for $webSiteName"
    Remove-WebConfigurationProperty -PSPath IIS:\ -Location "$webSiteName" -filter system.webServer/security/authentication/windowsAuthentication/providers -name "."
}

$providersPrintedString = $providers -join ", "
Write-Host "Providers to add: $providersPrintedString"
foreach ($provider in $providers) {
    Write-Host "Windows Authentication Provider $provider"
    Execute-WithRetry { 
        Add-WebConfiguration -Filter system.webServer/security/authentication/windowsAuthentication/providers -PSPath IIS:\ -Location "$webSiteName" -Value "$provider"
    }
}
```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20Explicitly%20Add%20IIS%20WindowsAuthentication%20Providers&step-template=Explicitly%20Add%20IIS%20WindowsAuthentication%20Providers)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "f3cf7831-d47c-4b5f-8f76-6bc649d59dd9",
  "Name": "Explicitly Add IIS WindowsAuthentication Providers",
  "Description": "Clears the WindowsAuthentication Providers, and explicitly adds the ones provided.",
  "Version": 1,
  "ExportedAt": "2016-05-27T01:18:58.041+00:00",
  "ActionType": "Octopus.Script",
  "Author": "KShanafelt",
  "Parameters": [
    {
      "Name": "add-windows-authentication-providers.is-enabled",
      "Label": "Add Windows Authentication Providers",
      "HelpText": "If enabled, This step will clear the Windows Authentication Providers, and then add the ones listed in the\n    Windows Authentication Providers\nfield.",
      "DefaultValue": "True",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "add-windows-authentication-providers.website-name",
      "Label": "Web Site name",
      "HelpText": "The display name of the IIS web site to add Windows Authentication providers to.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "add-windows-authentication-providers.providers",
      "Label": "Windows Authentication Providers",
      "HelpText": "A comma- or newline-separated list of Windows Authentication Providers to add.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.ScriptBody": "## --------------------------------------------------------------------------------------\n## Configuration\n## --------------------------------------------------------------------------------------\n\n$isEnabled = $OctopusParameters[\"add-windows-authentication-providers.is-enabled\"]\nif (!$isEnabled -or ![boolean]::Parse($isEnabled))\n{\n   exit 0\n}\n\ntry {\n    Add-PSSnapin WebAdministration\n} catch {\n    try {\n        Import-Module WebAdministration\n    } catch {\n\t\tWrite-Warning \"We failed to load the WebAdministration module. This usually resolved by doing one of the following:\"\n\t\tWrite-Warning \"1. Install .NET Framework 3.5.1\"\n\t\tWrite-Warning \"2. Upgrade to PowerShell 3.0 (or greater)\"\n        throw ($error | Select-Object -First 1)\n    }\n}\n\n$webSiteName = $OctopusParameters[\"add-windows-authentication-providers.website-name\"]\n$providersString = $OctopusParameters[\"add-windows-authentication-providers.providers\"]\n$providers = ($providersString.Split(\"`r`n,\") | % {$_.Trim() } | ? {$_})\n\n## --------------------------------------------------------------------------------------\n## Helpers\n## --------------------------------------------------------------------------------------\n$maxFailures = 5\n$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4\nfunction Execute-WithRetry([ScriptBlock] $command) {\n    $attemptCount = 0\n    $operationIncomplete = $true\n\n    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {\n        $attemptCount = ($attemptCount + 1)\n\n        if ($attemptCount -ge 2) {\n            Write-Output \"Waiting for $sleepBetweenFailures seconds before retrying...\"\n            Start-Sleep -s $sleepBetweenFailures\n            Write-Output \"Retrying...\"\n        }\n\n        try {\n            & $command\n\n            $operationIncomplete = $false\n        } catch [System.Exception] {\n            if ($attemptCount -lt ($maxFailures)) {\n                Write-Output (\"Attempt $attemptCount of $maxFailures failed: \" + $_.Exception.Message)\n            }\n            else {\n                throw \"Failed to execute command\"\n            }\n        }\n    }\n}\n\n## --------------------------------------------------------------------------------------\n## Run\n## --------------------------------------------------------------------------------------\nExecute-WithRetry { \n    Write-Host \"Clearing Windows Authentication Providers for $webSiteName\"\n    Remove-WebConfigurationProperty -PSPath IIS:\\ -Location \"$webSiteName\" -filter system.webServer/security/authentication/windowsAuthentication/providers -name \".\"\n}\n\n$providersPrintedString = $providers -join \", \"\nWrite-Host \"Providers to add: $providersPrintedString\"\nforeach ($provider in $providers) {\n    Write-Host \"Windows Authentication Provider $provider\"\n    Execute-WithRetry { \n        Add-WebConfiguration -Filter system.webServer/security/authentication/windowsAuthentication/providers -PSPath IIS:\\ -Location \"$webSiteName\" -Value \"$provider\"\n    }\n}",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.NuGetFeedId": null,
    "Octopus.Action.Package.NuGetPackageId": null
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-website-add-windows-auth-providers.json",
  "Website": "/step-templates/f3cf7831-d47c-4b5f-8f76-6bc649d59dd9",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-website-add-windows-auth-providers.json)

</div>
