---
layout: src/layouts/Default.astro
pubDate: 2015-08-25
title: 'IIS Virtual Directory - Create'
description: 'Create an IIS virtual directory.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2015-08-25 by jaymickey belongs to 'IIS' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Virtual path

`VirtualPath = `

The full path to the virtual directory you wish to create. Do not include the application (if any) the directory will be created under. The path, not including the virtual directory itself must already exist. Eg. If the virtual directory is to be created under `myapp/someFolder/myVdir` enter: `someFolder/myVdir`.

</div>
        
<div class="param">

### Application

`ApplicationName = `

Name of the IIS application to create the virtual directory under (not required).

</div>
        
<div class="param">

### Physical path

`PhysicalPath = `

Physical folder that the application will serve files from. Example: `C:\MyApp`.

</div>
        
<div class="param">

### Create Physical Path (If not exists)

`CreatePhysicalPath = False`

Create the physical path if it does not exist.

</div>
        
<div class="param">

### Parent site

`ParentSite`

The name of the IIS web site to attach the application to. For example, to put the application under the default web site, enter:

    Default Web Site

</div>
        
<div class="param">

### Username

`Username`

Pass-through authentication username

</div>
        
<div class="param">

### Password

`Password`

Pass-through authentication password

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
## --------------------------------------------------------------------------------------
## Input
## --------------------------------------------------------------------------------------

$virtualPath = $OctopusParameters['VirtualPath'].TrimStart('/',' ').TrimEnd('/', ' ')
$physicalPath = $OctopusParameters['PhysicalPath']
$parentSite = $OctopusParameters['ParentSite']
$application = $OctopusParameters['ApplicationName']
$username = $OctopusParameters['Username']
$password = $OctopusParameters['Password']
$createPhysicalPath = $OctopusParameters['CreatePhysicalPath']

## --------------------------------------------------------------------------------------
## Helpers
## --------------------------------------------------------------------------------------
# Helper for validating input parameters
function Confirm-Parameter([string]$parameterInput, [string[]]$validInput, $parameterName) {
    Write-Host "${parameterName}: $parameterInput"
    if (! $parameterInput) {
        throw "No value was set for $parameterName, and it cannot be empty"
    }

    if ($validInput) {
        if (! $validInput -contains $parameterInput) {
            throw "'$input' is not a valid input for '$parameterName'"
        }
    }

}

# Helper to run a block with a retry if things go wrong
$maxFailures = 5
$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4
function Invoke-CommandWithRetry([ScriptBlock] $command) {
    $attemptCount = 0
    $operationIncomplete = $true

    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {
        $attemptCount = ($attemptCount + 1)

        if ($attemptCount -ge 2) {
            Write-Output "Waiting for $sleepBetweenFailures seconds before retrying..."
            Start-Sleep -s $sleepBetweenFailures
            Write-Output "Retrying..."
        }

        try {
            & $command

            $operationIncomplete = $false
        } catch [System.Exception] {
            if ($attemptCount -lt ($maxFailures)) {
                Write-Output ("Attempt $attemptCount of $maxFailures failed: " + $_.Exception.Message)

            }
            else {
                throw "Failed to execute command"
            }
        }
    }
}

## --------------------------------------------------------------------------------------
## Configuration
## --------------------------------------------------------------------------------------
Confirm-Parameter $virtualPath -parameterName "Virtual path"
Confirm-Parameter $physicalPath -parameterName "Physical path"
Confirm-Parameter $parentSite -parameterName "Parent site"

if (![string]::IsNullOrEmpty($application)) {
    $application = $application.TrimStart('/',' ').TrimEnd('/',' ')
}

Add-PSSnapin WebAdministration -ErrorAction SilentlyContinue
Import-Module WebAdministration -ErrorAction SilentlyContinue


## --------------------------------------------------------------------------------------
## Run
## --------------------------------------------------------------------------------------

Write-Host "Getting web site $parentSite"
$site = Get-Website -name $parentSite
if (!$site) {
    throw "The web site '$parentSite' does not exist. Please create the site first."
}

$virtualFullPath = $virtualPath

if ($application) {
    Write-Host "Verifying existance of application $application"
    $app = Get-WebApplication -site $parentSite -name $application
    if (!$app) {
        throw "The application '$parentSite' does not exist. Please create the application first."
    } else {
        $virtualFullPath = $application + '/' + $virtualPath
    }
}

# If the physical path down not exist and $createPhysicalPath is true,
# then attempt create it, otherwise throw an error.
if (!(Test-Path $physicalPath)) {
    if ($createPhysicalPath) {
        try {
            Write-Host "Attempting to create physical path '$physicalPath'"
            New-Item -Type Directory -Path $physicalPath -Force
        } catch {
            throw "Couldn't create physical path!"
        }
    } else {
        throw "Physical path does not exist!"
    }
}

# This needs to be improved, especially given applicaltions can be nested.
if ($application) {
    $existing = Get-WebVirtualDirectory -site $parentSite -Application $application -Name $virtualPath
} else {
    $existing = Get-WebVirtualDirectory -site $parentSite -Name $virtualPath
}

Invoke-CommandWithRetry {

    $virtualDirectoryPath = "IIS:\Sites\$parentSite\$virtualFullPath"

    if (!$existing) {
        Write-Host "Creating virtual directory '$virtualPath'"

        New-Item $virtualDirectoryPath -type VirtualDirectory -physicalPath $physicalPath

        Write-Host "Virtual directory created"
    }
    else {
        Write-Host "The virtual directory '$virtualPath' already exists. Checking physical path."

        $currentPath = (Get-ItemProperty $virtualDirectoryPath).physicalPath
        Write-Host "Physical path currently set to $currentPath"

        if ([string]::Compare($currentPath, $physicalPath, $True) -ne 0) {
            Set-ItemProperty $virtualDirectoryPath -name physicalPath -value $physicalPath
            Write-Host "Physical path changed to $physicalPath"
        }
    }

    ## Set vdir pass-through credentails, if applicable
    if (![string]::IsNullOrEmpty($username) -and ![string]::IsNullOrEmpty($password)) {
        Write-Host "Setting Pass-through credentials for username '$username'"

        Set-ItemProperty $virtualDirectoryPath -Name userName -Value $username
        Set-ItemProperty $virtualDirectoryPath -Name password -Value $password

        Write-Host "Pass-through credentials set"
    }
}

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20IIS%20Virtual%20Directory%20-%20Create&step-template=IIS%20Virtual%20Directory%20-%20Create)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "2cfbcd72-cf43-43fd-8291-9bb564cc512c",
  "Name": "IIS Virtual Directory - Create",
  "Description": "Create an IIS virtual directory.",
  "Version": 7,
  "ExportedAt": "2015-08-25T13:55:15.518+00:00",
  "ActionType": "Octopus.Script",
  "Author": "jaymickey",
  "Parameters": [
    {
      "Name": "VirtualPath",
      "Label": "Virtual path",
      "HelpText": "The full path to the virtual directory you wish to create. Do not include the application (if any) the directory will be created under. The path, not including the virtual directory itself must already exist. Eg. If the virtual directory is to be created under `myapp/someFolder/myVdir` enter: `someFolder/myVdir`.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "ApplicationName",
      "Type": "String",
      "Label": "Application",
      "HelpText": "Name of the IIS application to create the virtual directory under (not required).",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "PhysicalPath",
      "Label": "Physical path",
      "HelpText": "Physical folder that the application will serve files from. Example: `C:\\MyApp`.",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "CreatePhysicalPath",
      "Label": "Create Physical Path (If not exists)",
      "HelpText": "Create the physical path if it does not exist.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    },
    {
      "Name": "ParentSite",
      "Label": "Parent site",
      "HelpText": "The name of the IIS web site to attach the application to. For example, to put the application under the default web site, enter:\n\n    Default Web Site",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "Username",
      "Label": "Username",
      "HelpText": "Pass-through authentication username",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "Password",
      "Label": "Password",
      "HelpText": "Pass-through authentication password",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "## --------------------------------------------------------------------------------------\n## Input\n## --------------------------------------------------------------------------------------\n\n$virtualPath = $OctopusParameters['VirtualPath'].TrimStart('/',' ').TrimEnd('/', ' ')\n$physicalPath = $OctopusParameters['PhysicalPath']\n$parentSite = $OctopusParameters['ParentSite']\n$application = $OctopusParameters['ApplicationName']\n$username = $OctopusParameters['Username']\n$password = $OctopusParameters['Password']\n$createPhysicalPath = $OctopusParameters['CreatePhysicalPath']\n\n## --------------------------------------------------------------------------------------\n## Helpers\n## --------------------------------------------------------------------------------------\n# Helper for validating input parameters\nfunction Confirm-Parameter([string]$parameterInput, [string[]]$validInput, $parameterName) {\n    Write-Host \"${parameterName}: $parameterInput\"\n    if (! $parameterInput) {\n        throw \"No value was set for $parameterName, and it cannot be empty\"\n    }\n\n    if ($validInput) {\n        if (! $validInput -contains $parameterInput) {\n            throw \"'$input' is not a valid input for '$parameterName'\"\n        }\n    }\n\n}\n\n# Helper to run a block with a retry if things go wrong\n$maxFailures = 5\n$sleepBetweenFailures = Get-Random -minimum 1 -maximum 4\nfunction Invoke-CommandWithRetry([ScriptBlock] $command) {\n    $attemptCount = 0\n    $operationIncomplete = $true\n\n    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {\n        $attemptCount = ($attemptCount + 1)\n\n        if ($attemptCount -ge 2) {\n            Write-Output \"Waiting for $sleepBetweenFailures seconds before retrying...\"\n            Start-Sleep -s $sleepBetweenFailures\n            Write-Output \"Retrying...\"\n        }\n\n        try {\n            & $command\n\n            $operationIncomplete = $false\n        } catch [System.Exception] {\n            if ($attemptCount -lt ($maxFailures)) {\n                Write-Output (\"Attempt $attemptCount of $maxFailures failed: \" + $_.Exception.Message)\n\n            }\n            else {\n                throw \"Failed to execute command\"\n            }\n        }\n    }\n}\n\n## --------------------------------------------------------------------------------------\n## Configuration\n## --------------------------------------------------------------------------------------\nConfirm-Parameter $virtualPath -parameterName \"Virtual path\"\nConfirm-Parameter $physicalPath -parameterName \"Physical path\"\nConfirm-Parameter $parentSite -parameterName \"Parent site\"\n\nif (![string]::IsNullOrEmpty($application)) {\n    $application = $application.TrimStart('/',' ').TrimEnd('/',' ')\n}\n\nAdd-PSSnapin WebAdministration -ErrorAction SilentlyContinue\nImport-Module WebAdministration -ErrorAction SilentlyContinue\n\n\n## --------------------------------------------------------------------------------------\n## Run\n## --------------------------------------------------------------------------------------\n\nWrite-Host \"Getting web site $parentSite\"\n$site = Get-Website -name $parentSite\nif (!$site) {\n    throw \"The web site '$parentSite' does not exist. Please create the site first.\"\n}\n\n$virtualFullPath = $virtualPath\n\nif ($application) {\n    Write-Host \"Verifying existance of application $application\"\n    $app = Get-WebApplication -site $parentSite -name $application\n    if (!$app) {\n        throw \"The application '$parentSite' does not exist. Please create the application first.\"\n    } else {\n        $virtualFullPath = $application + '/' + $virtualPath\n    }\n}\n\n# If the physical path down not exist and $createPhysicalPath is true,\n# then attempt create it, otherwise throw an error.\nif (!(Test-Path $physicalPath)) {\n    if ($createPhysicalPath) {\n        try {\n            Write-Host \"Attempting to create physical path '$physicalPath'\"\n            New-Item -Type Directory -Path $physicalPath -Force\n        } catch {\n            throw \"Couldn't create physical path!\"\n        }\n    } else {\n        throw \"Physical path does not exist!\"\n    }\n}\n\n# This needs to be improved, especially given applicaltions can be nested.\nif ($application) {\n    $existing = Get-WebVirtualDirectory -site $parentSite -Application $application -Name $virtualPath\n} else {\n    $existing = Get-WebVirtualDirectory -site $parentSite -Name $virtualPath\n}\n\nInvoke-CommandWithRetry {\n\n    $virtualDirectoryPath = \"IIS:\\Sites\\$parentSite\\$virtualFullPath\"\n\n    if (!$existing) {\n        Write-Host \"Creating virtual directory '$virtualPath'\"\n\n        New-Item $virtualDirectoryPath -type VirtualDirectory -physicalPath $physicalPath\n\n        Write-Host \"Virtual directory created\"\n    }\n    else {\n        Write-Host \"The virtual directory '$virtualPath' already exists. Checking physical path.\"\n\n        $currentPath = (Get-ItemProperty $virtualDirectoryPath).physicalPath\n        Write-Host \"Physical path currently set to $currentPath\"\n\n        if ([string]::Compare($currentPath, $physicalPath, $True) -ne 0) {\n            Set-ItemProperty $virtualDirectoryPath -name physicalPath -value $physicalPath\n            Write-Host \"Physical path changed to $physicalPath\"\n        }\n    }\n\n    ## Set vdir pass-through credentails, if applicable\n    if (![string]::IsNullOrEmpty($username) -and ![string]::IsNullOrEmpty($password)) {\n        Write-Host \"Setting Pass-through credentials for username '$username'\"\n\n        Set-ItemProperty $virtualDirectoryPath -Name userName -Value $username\n        Set-ItemProperty $virtualDirectoryPath -Name password -Value $password\n\n        Write-Host \"Pass-through credentials set\"\n    }\n}\n",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Category": "IIS",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-vdir-create.json",
  "Website": "/step-templates/2cfbcd72-cf43-43fd-8291-9bb564cc512c",
  "Logo": "https://i.octopus.com/library/step-templates/iis.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/iis-vdir-create.json)

</div>
