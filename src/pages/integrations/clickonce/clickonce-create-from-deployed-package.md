---
layout: src/layouts/Default.astro
pubDate: 2016-09-15
title: 'ClickOnce - Create from deployed package'
description: 'Create binaries manifest & CO application and sign them with given code sign certificate ... using mage.exe.'
navMenu: false
# Set to true when launched
navSitemap: false
navSearch: false
# This file is auto-generated by docs/tools/MarkdownGenerator (detail.js)
---

Octopus.Script exported 2016-09-15 by Grendizr belongs to 'ClickOnce' category.

## Parameters

When steps based on the template are included in a project's deployment process, the parameters below can be set.


<div class="param">

### Deploy step to read binaries from

`DeployStepName`

Name of the previous step used to deploy binaries that will be packed in CO package

</div>
        
<div class="param">

### Path to the directory where to deploy the ClickOnce package

`DestinationPath = \\MyServer\MyClickOnceRepo\#{Octopus.Project.Name}\#{Octopus.Environment.Name}`

Path to the target directory for the ClickOnce package. This will contain the created *.application file and the "Application Files" folder

</div>
        
<div class="param">

### Name of the target executable file

`ExeFileName`

Name of the executable file of the application to pack

</div>
        
<div class="param">

### Publisher name

`Publisher = MyCompany`

Publisher name to use when creating the CO package

</div>
        
<div class="param">

### Path to the certification file

`SignCertFilePath = \\MyServer\Auth\cert\my-cert.pfx`

Path to the certification pfx file

</div>
        
<div class="param">

### Password of the certification file

`SignCertPassword = `

null

</div>
        
<div class="param">

### Path to mage.exe

`MageExePath = \\MyServer\Tools\Octopus\Tentacles\mage.exe`

Path to mage.exe which is used to update manifest and .application files and sign them.

</div>
        
<div class="param">

### Icon filename

`IconFile`

Name of icon file in the package, eg. ApplicationIcon.ico

</div>
        
<div class="param">

### Application display name

`DisplayName`

Name which appears in the Start Menu

</div>
        

## Script body

Steps based on this template will execute the following *PowerShell* script.

```powershell
Write-Host "Building clickonce application ..."

function Validate-Parameter([REF]$f, $name, $value) {
    if (!$value) {
        throw ('Missing required value for parameter ''{0}''.' -f $name)
    }
    
    $f.Value = $value
    Write-Host "Parameters [$name] has been initialized with : [$value]"
}

### Parameters
$deployStepName = $null
$appName = $null
$exeFileName = $null
$destinationPath = $null
$certFilePath = $null
$certPassword = $null
$publisher = $null
$mageExe = $null
$version = $null
$binariesFolderPath = $null
$coAppName = $null
$iconFile = $null

Validate-Parameter ([REF]$deployStepName) 'Deploy step name to read binaries from' $OctopusParameters['DeployStepName']
Validate-Parameter ([REF]$appName) 'Project name' $OctopusParameters['Octopus.Project.Name']
Validate-Parameter ([REF]$coAppName) 'Application display name' $OctopusParameters['DisplayName']

Validate-Parameter ([REF]$exeFileName) 'Executable file name' $OctopusParameters['ExeFileName']
Validate-Parameter ([REF]$destinationPath) 'Path to the directory where to deploy the ClickOnce package' $OctopusParameters['DestinationPath']
Validate-Parameter ([REF]$certFilePath) 'Path to the certification file' $OctopusParameters['SignCertFilePath']
Validate-Parameter ([REF]$certPassword) 'Password of the certification file' $OctopusParameters['SignCertPassword']
Validate-Parameter ([REF]$publisher) 'Publisher name' $OctopusParameters['Publisher']
Validate-Parameter ([REF]$mageExe) 'Path to the mage.exe' $OctopusParameters['MageExePath']
Validate-Parameter ([REF]$iconFile) 'Icon file' $OctopusParameters['IconFile']

### end of parameters

Validate-Parameter ([REF]$version) 'Version number (from release)' $OctopusParameters['Octopus.Release.Number']

$binariesFolderParameter = -join("Octopus.Action[",$deployStepName,"].Output.Package.InstallationDirectoryPath")
Write-Host "Trying to get Installation folder parameter value for : [$binariesFolderParameter]"

$binariesFolderPath = $OctopusParameters[$binariesFolderParameter]
if(!$binariesFolderPath){
     throw ('Unable to retrieve binaries path from previous step execution for step with name ''{0}''.' -f $deployStepName)
}

$appVersionAndNumber = -join($appName, "_", $version)
$packageDestinationSubDirectory = -join ("Application_Files/", $appVersionAndNumber)
$packageDestinationPath = -join ($destinationPath, "/", $packageDestinationSubDirectory) 
$appManifestRelativePath = -join ("Application_Files/",$appVersionAndNumber, "/", $exeFileName, ".manifest")
$appManifestFilePath = -join ($binariesFolderPath, "/", $exeFileName, ".manifest")

$coAppFilePath = -join($binariesFolderPath, "\", $appName, ".application")
$coAppFilePathServer = -join($destinationPath, "\", $appName, ".application")

### Create Application manifest
Write-Host "Creating application manifest at "$appManifestFilePath
& $mageExe -New Application -t "$appManifestFilePath" -n "$coAppName" -v $version -p msil -fd "$binariesFolderPath" -tr FullTrust -a sha256RSA -if $iconFile
Write-Host "Signing application manifest ..."
& $mageExe -Sign "$appManifestFilePath" -cf $certFilePath -pwd $certPassword

### Create Deployment application
Write-Host "Creating CO application [$coAppName] at "$coAppFilePath
& $mageExe -New Deployment -t "$coAppFilePath" -n "$coAppName" -v $version -p msil -appm $appManifestFilePath -ip true -i true -um true -pub $publisher -pu "$coAppFilePathServer" -appc $appManifestRelativePath -a sha256RSA

Write-Host "Updating minimum version to force auto-update"
& $mageExe -Update $coAppFilePath -mv $version -pub $publisher -a sha256RSA

Write-Host "Changing expiration max age => before application startup (hacking xml) of "$coAppFilePath
$content = Get-Content $coAppFilePath
$content -replace "<expiration maximumAge=`"0`" unit=`"days`" />", "<beforeApplicationStartup />" | set-content $coAppFilePath

Write-Host "Signing CO application [$coAppName] ..."
& $mageExe -Sign "$coAppFilePath" -cf $certFilePath -pwd $certPassword


Write-Host "Copying binaries from "$binariesFolderPath
Write-Host "to destination "$packageDestinationPath

### Remove any existing files from the package destination folder
Remove-Item $packageDestinationPath -Recurse -ErrorAction SilentlyContinue

### Ensure target directory exists in order not to fail the copy
New-Item $packageDestinationPath -ItemType directory > $null

### Copy binaries to destination folder
Copy-Item $binariesFolderPath"/*" $packageDestinationPath -recurse -Force > $null
Copy-Item $coAppFilePath $destinationPath -Force > $null

Write-Host "Building clickonce application script completed."

```

Provided under the [Apache License version 2.0](https://github.com/OctopusDeploy/Library/blob/master/LICENSE.txt).

[Report an issue](https://github.com/OctopusDeploy/Library/issues/new?assignees=&labels=&projects=&template=bug-report.yml&title=Issue%20with%20ClickOnce%20-%20Create%20from%20deployed%20package&step-template=ClickOnce%20-%20Create%20from%20deployed%20package)

<div class="get-json">

To use this template in Octopus Deploy, copy the JSON below and paste it into the **Library → Step templates → Import** dialog.

```json
{
  "Id": "1b7909be-4870-4f81-8957-8357b9342c0f",
  "Name": "ClickOnce - Create from deployed package",
  "Description": "Create binaries manifest & CO application and sign them with given code sign certificate ... using mage.exe.",
  "Version": 28,
  "ExportedAt": "2016-09-15T06:53:27.970+00:00",
  "ActionType": "Octopus.Script",
  "Author": "Grendizr",
  "Parameters": [
    {
      "Name": "DeployStepName",
      "Label": "Deploy step to read binaries from",
      "HelpText": "Name of the previous step used to deploy binaries that will be packed in CO package",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      }
    },
    {
      "Name": "DestinationPath",
      "Label": "Path to the directory where to deploy the ClickOnce package",
      "HelpText": "Path to the target directory for the ClickOnce package. This will contain the created *.application file and the \"Application Files\" folder",
      "DefaultValue": "\\\\MyServer\\MyClickOnceRepo\\#{Octopus.Project.Name}\\#{Octopus.Environment.Name}",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "ExeFileName",
      "Label": "Name of the target executable file",
      "HelpText": "Name of the executable file of the application to pack",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "Publisher",
      "Label": "Publisher name",
      "HelpText": "Publisher name to use when creating the CO package",
      "DefaultValue": "MyCompany",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "SignCertFilePath",
      "Label": "Path to the certification file",
      "HelpText": "Path to the certification pfx file",
      "DefaultValue": "\\\\MyServer\\Auth\\cert\\my-cert.pfx",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "SignCertPassword",
      "Label": "Password of the certification file",
      "HelpText": null,
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      }
    },
    {
      "Name": "MageExePath",
      "Label": "Path to mage.exe",
      "HelpText": "Path to mage.exe which is used to update manifest and .application files and sign them.",
      "DefaultValue": "\\\\MyServer\\Tools\\Octopus\\Tentacles\\mage.exe",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "IconFile",
      "Label": "Icon filename",
      "HelpText": "Name of icon file in the package, eg. ApplicationIcon.ico",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Name": "DisplayName",
      "Label": "Application display name",
      "HelpText": "Name which appears in the Start Menu",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    }
  ],
  "Properties": {
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.ScriptBody": "Write-Host \"Building clickonce application ...\"\n\nfunction Validate-Parameter([REF]$f, $name, $value) {\n    if (!$value) {\n        throw ('Missing required value for parameter ''{0}''.' -f $name)\n    }\n    \n    $f.Value = $value\n    Write-Host \"Parameters [$name] has been initialized with : [$value]\"\n}\n\n### Parameters\n$deployStepName = $null\n$appName = $null\n$exeFileName = $null\n$destinationPath = $null\n$certFilePath = $null\n$certPassword = $null\n$publisher = $null\n$mageExe = $null\n$version = $null\n$binariesFolderPath = $null\n$coAppName = $null\n$iconFile = $null\n\nValidate-Parameter ([REF]$deployStepName) 'Deploy step name to read binaries from' $OctopusParameters['DeployStepName']\nValidate-Parameter ([REF]$appName) 'Project name' $OctopusParameters['Octopus.Project.Name']\nValidate-Parameter ([REF]$coAppName) 'Application display name' $OctopusParameters['DisplayName']\n\nValidate-Parameter ([REF]$exeFileName) 'Executable file name' $OctopusParameters['ExeFileName']\nValidate-Parameter ([REF]$destinationPath) 'Path to the directory where to deploy the ClickOnce package' $OctopusParameters['DestinationPath']\nValidate-Parameter ([REF]$certFilePath) 'Path to the certification file' $OctopusParameters['SignCertFilePath']\nValidate-Parameter ([REF]$certPassword) 'Password of the certification file' $OctopusParameters['SignCertPassword']\nValidate-Parameter ([REF]$publisher) 'Publisher name' $OctopusParameters['Publisher']\nValidate-Parameter ([REF]$mageExe) 'Path to the mage.exe' $OctopusParameters['MageExePath']\nValidate-Parameter ([REF]$iconFile) 'Icon file' $OctopusParameters['IconFile']\n\n### end of parameters\n\nValidate-Parameter ([REF]$version) 'Version number (from release)' $OctopusParameters['Octopus.Release.Number']\n\n$binariesFolderParameter = -join(\"Octopus.Action[\",$deployStepName,\"].Output.Package.InstallationDirectoryPath\")\nWrite-Host \"Trying to get Installation folder parameter value for : [$binariesFolderParameter]\"\n\n$binariesFolderPath = $OctopusParameters[$binariesFolderParameter]\nif(!$binariesFolderPath){\n     throw ('Unable to retrieve binaries path from previous step execution for step with name ''{0}''.' -f $deployStepName)\n}\n\n$appVersionAndNumber = -join($appName, \"_\", $version)\n$packageDestinationSubDirectory = -join (\"Application_Files/\", $appVersionAndNumber)\n$packageDestinationPath = -join ($destinationPath, \"/\", $packageDestinationSubDirectory) \n$appManifestRelativePath = -join (\"Application_Files/\",$appVersionAndNumber, \"/\", $exeFileName, \".manifest\")\n$appManifestFilePath = -join ($binariesFolderPath, \"/\", $exeFileName, \".manifest\")\n\n$coAppFilePath = -join($binariesFolderPath, \"\\\", $appName, \".application\")\n$coAppFilePathServer = -join($destinationPath, \"\\\", $appName, \".application\")\n\n### Create Application manifest\nWrite-Host \"Creating application manifest at \"$appManifestFilePath\n& $mageExe -New Application -t \"$appManifestFilePath\" -n \"$coAppName\" -v $version -p msil -fd \"$binariesFolderPath\" -tr FullTrust -a sha256RSA -if $iconFile\nWrite-Host \"Signing application manifest ...\"\n& $mageExe -Sign \"$appManifestFilePath\" -cf $certFilePath -pwd $certPassword\n\n### Create Deployment application\nWrite-Host \"Creating CO application [$coAppName] at \"$coAppFilePath\n& $mageExe -New Deployment -t \"$coAppFilePath\" -n \"$coAppName\" -v $version -p msil -appm $appManifestFilePath -ip true -i true -um true -pub $publisher -pu \"$coAppFilePathServer\" -appc $appManifestRelativePath -a sha256RSA\n\nWrite-Host \"Updating minimum version to force auto-update\"\n& $mageExe -Update $coAppFilePath -mv $version -pub $publisher -a sha256RSA\n\nWrite-Host \"Changing expiration max age => before application startup (hacking xml) of \"$coAppFilePath\n$content = Get-Content $coAppFilePath\n$content -replace \"<expiration maximumAge=`\"0`\" unit=`\"days`\" />\", \"<beforeApplicationStartup />\" | set-content $coAppFilePath\n\nWrite-Host \"Signing CO application [$coAppName] ...\"\n& $mageExe -Sign \"$coAppFilePath\" -cf $certFilePath -pwd $certPassword\n\n\nWrite-Host \"Copying binaries from \"$binariesFolderPath\nWrite-Host \"to destination \"$packageDestinationPath\n\n### Remove any existing files from the package destination folder\nRemove-Item $packageDestinationPath -Recurse -ErrorAction SilentlyContinue\n\n### Ensure target directory exists in order not to fail the copy\nNew-Item $packageDestinationPath -ItemType directory > $null\n\n### Copy binaries to destination folder\nCopy-Item $binariesFolderPath\"/*\" $packageDestinationPath -recurse -Force > $null\nCopy-Item $coAppFilePath $destinationPath -Force > $null\n\nWrite-Host \"Building clickonce application script completed.\"\n",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.NuGetFeedId": null,
    "Octopus.Action.Package.NuGetPackageId": null
  },
  "Category": "ClickOnce",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/clickonce-from-deployed-package.json",
  "Website": "/step-templates/1b7909be-4870-4f81-8957-8357b9342c0f",
  "Logo": "https://i.octopus.com/library/step-templates/clickonce.png",
  "$Meta": {
    "Type": "ActionTemplate"
  }
}
```

[History](https://github.com/OctopusDeploy/Library/commits/master/step-templates/https://github.com/OctopusDeploy/Library/commits/master/step-templates//opt/buildagent/work/75443764cd38076d/step-templates/clickonce-from-deployed-package.json)

</div>
